# Руководство по SaaS-системе с суперадмин панелью

## Обзор

Система теперь поддерживает полноценную мульти-тенантную SaaS-архитектуру с суперадмин панелью для управления всеми школами (клиентами).

## Основные компоненты

### 1. Модель SuperAdmin
- Отдельная модель для супер-администратора платформы
- Полный доступ ко всем школам и данным
- Не привязан к конкретной школе

### 2. Модель School (обновлена)
- `name` - Название школы/компании
- `contact_person` - ФИО контактного лица
- `address` - Адрес (юридический/фактический)
- `phone` - Номер телефона
- `owner_username` - Логин владельца школы
- `owner_password_hash` - Хеш пароля владельца
- `is_active` - Статус аккаунта (активен/отключён)

### 3. Изоляция данных
- Полная изоляция данных между школами
- Автоматическая фильтрация всех запросов по `school_id`
- Суперадмин видит все данные, обычные пользователи - только свою школу

## Установка и настройка

### 1. Создание первого суперадмина

```bash
python create_superadmin.py
```

Введите:
- Логин суперадмина
- Пароль
- ФИО (опционально)
- Email (опционально)

### 2. Миграция существующих данных

Если у вас уже есть школы в базе данных:

```bash
python migrate_schools_table.py
```

Этот скрипт:
- Добавит поля `owner_username` и `owner_password_hash` в таблицу `schools`
- Автоматически заполнит их данными из первого администратора каждой школы

### 3. Создание таблиц

При первом запуске приложения таблицы создадутся автоматически. Если нужно создать вручную:

```python
from app import app, db
with app.app_context():
    db.create_all()
```

## Использование

### Вход в систему

1. **Суперадмин**: входит с логином и паролем, созданными через `create_superadmin.py`
   - После входа перенаправляется на `/schools`
   - Может управлять всеми школами

2. **Владелец школы**: входит с логином и паролем, указанными при создании школы
   - Видит только данные своей школы
   - Полная изоляция от других школ

### Суперадмин панель

Доступна по адресу `/schools` (только для суперадмина).

**Возможности:**
- ✅ Создание новых школ
- ✅ Редактирование информации о школе
- ✅ Управление статусом школы (активна/заблокирована)
- ✅ Управление логином и паролем владельца
- ✅ Удаление школы (с полным удалением всех данных)
- ✅ Управление функциями школы (feature flags)

### Создание новой школы

1. Нажмите "➕ Добавить школу"
2. Заполните форму:
   - Название школы *
   - ФИО контактного лица
   - Адрес
   - Телефон
   - Логин владельца *
   - Пароль владельца *
   - Статус (активна/заблокирована)
   - Функции (feature flags)
3. Нажмите "Сохранить"

**Важно:** После создания школы сохраните логин и пароль владельца!

### Управление статусом школы

- **Активна**: владелец может войти в систему
- **Заблокирована**: доступ владельца и всех пользователей школы заблокирован

### Изоляция данных

Все данные автоматически изолированы по `school_id`:
- Ученики
- Группы
- Платежи
- Посещаемость
- Финансы
- Пользователи
- Настройки

**Супер-администратор** видит все данные (для управления).
**Обычные пользователи** видят только данные своей школы.

## Безопасность

1. **Изоляция данных**: автоматическая фильтрация всех запросов
2. **Проверка доступа**: все маршруты проверяют права доступа
3. **Хеширование паролей**: все пароли хранятся в виде хешей (bcrypt)
4. **Статус школы**: можно быстро заблокировать доступ всей школе

## API Endpoints

### Для суперадмина:

- `GET /api/schools` - Список всех школ
- `GET /api/schools/<id>` - Информация о школе
- `POST /api/schools` - Создать школу
- `PUT /api/schools/<id>` - Обновить школу
- `DELETE /api/schools/<id>/delete` - Удалить школу
- `POST /api/schools/switch` - Переключиться на школу (для просмотра)

## Структура файлов

```
backend/
  models/
    models.py          # Модели SuperAdmin, School
  middleware/
    school_middleware.py  # Middleware для изоляции данных
  utils/
    school_utils.py      # Утилиты для работы со школами
    query_filters.py     # Фильтры запросов по school_id

frontend/
  templates/
    schools.html        # Суперадмин панель
  static/js/
    schools.js          # JavaScript для управления школами

create_superadmin.py    # Скрипт создания суперадмина
migrate_schools_table.py # Миграция таблицы schools
```

## Примечания

- При удалении школы удаляются **все** связанные данные
- Изменение логина владельца автоматически обновляет логин пользователя-админа
- Изменение пароля владельца автоматически обновляет пароль пользователя-админа
- Суперадмин может просматривать данные любой школы через переключение



