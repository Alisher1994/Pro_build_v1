<!doctype html>
<html lang="ru">

<head>
  <meta charset="UTF-8">
  <title>Тендер · Демо (без бэка)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="css/style.css">
  <style>
    body {
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
      margin: 0;
      background: var(--gray-100);
      color: var(--gray-900);
      font-family: var(--font-family);
      -webkit-font-smoothing: antialiased;
    }

    .topbar {
      flex: 0 0 auto;
      width: 100%;
      box-sizing: border-box;
      max-width: 1440px;
      margin: 16px auto 8px;
      background: var(--white);
      border: 1px solid var(--gray-300);
      border-radius: 12px;
      padding: 12px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: var(--shadow-md);
    }

    .title {
      font-size: 18px;
      font-weight: 400;
      color: var(--gray-800);
    }

    .pill {
      padding: 6px 10px;
      border-radius: 10px;
      background: var(--primary-lighter);
      color: var(--primary);
      font-size: 12px;
      font-weight: 400;
    }

    .main {
      flex: 1;
      width: 100%;
      box-sizing: border-box;
      padding: 24px;
      display: block;
      overflow: hidden;
    }

    .sidebar {
      display: none;
    }

    .sidebar h3 {
      margin: 0 0 10px;
      font-size: 14px;
      color: var(--gray-500);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 400;
    }

    .nav-item {
      display: block;
      padding: 8px 12px;
      border-radius: 6px;
      color: var(--gray-700);
      cursor: pointer;
      font-size: 13px;
      margin-bottom: 2px;
      transition: background 0.1s;
    }

    .nav-item:hover {
      background: var(--gray-100);
    }

    .nav-item.active {
      background: var(--primary-lighter);
      color: var(--primary);
      font-weight: 500;
    }

    .card {
      height: 100%;
      overflow-y: auto;
      background: var(--white);
      border: 1px solid var(--gray-300);
      border-radius: 12px;
      box-shadow: var(--shadow-sm);
      padding: 14px 14px 10px;
      box-sizing: border-box;
      scrollbar-width: none;
    }

    .card::-webkit-scrollbar {
      display: none;
    }

    .card h2 {
      margin: 0 0 6px;
      font-size: 15px;
      color: var(--gray-800);
      font-weight: 400;
    }

    .sub {
      color: var(--gray-600);
      font-size: 12px;
    }

    .filters {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
      margin: 6px 0 10px;
    }

    .chip {
      padding: 5px 10px;
      border-radius: 8px;
      font-size: 12px;
      background: var(--gray-200);
      color: var(--gray-800);
      cursor: pointer;
      border: 1px solid var(--gray-300);
    }

    .chip.active {
      background: var(--primary-lighter);
      border-color: var(--primary);
      color: var(--primary);
      font-weight: 400;
    }

    .table {
      width: 100%;
      border-collapse: collapse;
    }

    .table th,
    .table td {
      border-bottom: 1px solid var(--gray-200);
      padding: 8px 6px;
      text-align: left;
      font-size: 13px;
    }

    .table th {
      color: var(--gray-700);
      font-weight: 400;
      background: var(--gray-50);
    }

    .lot-meta-chip {
      background: var(--gray-100);
      color: var(--gray-700);
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 500;
      white-space: nowrap;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .lot-meta-chip.sum-chip {
      background: #e6f6f5;
      color: #246664;
      font-weight: 700;
    }

    .badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 400;
      color: #fff;
      min-width: 86px;
      text-align: center;
    }

    .b-open {
      background: var(--primary);
    }

    .b-closed {
      background: var(--gray-600);
    }

    .b-parsed {
      background: var(--accent-green);
    }

    .b-parsing {
      background: var(--accent-blue);
    }

    .b-uploaded {
      background: var(--gray-700);
    }

    .b-failed {
      background: var(--accent-red);
    }

    .muted {
      color: var(--gray-600);
      font-size: 12px;
    }

    details {
      border: 1px solid var(--gray-200);
      border-radius: 4px;
      padding: 10px 12px;
      background: var(--gray-50);
    }

    details summary {
      cursor: pointer;
      font-weight: 400;
      display: flex;
      gap: 8px;
      align-items: center;
    }

    details summary::-webkit-details-marker {
      display: none;
    }

    .row {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
    }

    .kv {
      font-size: 13px;
      color: var(--gray-700);
    }

    .kv strong {
      color: var(--gray-900);
      font-weight: 400;
    }

    .log-list {
      display: grid;
      gap: 8px;
      margin-top: 6px;
    }

    .log-item {
      border: 1px solid var(--gray-200);
      border-radius: 10px;
      padding: 10px;
      background: var(--white);
      box-shadow: var(--shadow-sm);
    }

    .log-head {
      display: flex;
      gap: 8px;
      align-items: center;
      justify-content: space-between;
    }

    .log-msg {
      margin: 4px 0;
      font-size: 13px;
    }

    .log-meta {
      color: var(--gray-600);
      font-size: 12px;
    }

    .btn {
      border: 1px solid var(--gray-300);
      background: var(--primary);
      color: #fff;
      border-radius: 8px;
      padding: 6px 16px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: var(--shadow-sm);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .btn:hover:not(:disabled) {
      background: var(--primary-hover);
      box-shadow: var(--shadow-md);
      transform: translateY(-1px);
    }

    .btn:active:not(:disabled) {
      transform: translateY(0);
      box-shadow: none;
    }

    .btn:disabled {
      background: var(--gray-200);
      border-color: var(--gray-300);
      color: var(--gray-500);
      cursor: not-allowed;
      box-shadow: none;
    }

    .btn.secondary {
      background: #fff;
      color: var(--gray-700);
      border-color: var(--gray-300);
      box-shadow: none;
    }

    .btn.secondary:hover:not(:disabled) {
      background: var(--gray-50);
      border-color: var(--gray-400);
      color: var(--gray-900);
    }

    .btn:active {
      transform: translateY(1px);
      box-shadow: none;
    }

    .download-btn {
      padding: 6px 10px;
    }

    .card+.card {
      margin-top: 0;
    }

    .tag {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 8px;
      border-radius: 8px;
      background: var(--primary-lighter);
      color: var(--primary);
      font-size: 12px;
    }

    .files a {
      color: var(--accent-blue);
      text-decoration: none;
    }

    .files a:hover {
      text-decoration: underline;
    }

    .actions-inline {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .stack {
      display: grid;
      gap: 10px;
    }

    .lot-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .lot-entry {
      border: 1px solid var(--gray-200);
      border-radius: 12px;
      background: var(--white);
      overflow: hidden;
    }

    .lot-entry summary {
      display: flex;
      cursor: pointer;
      padding: 16px 20px;
      justify-content: space-between;
      align-items: center;
      gap: 18px;
    }

    .lot-entry summary::marker {
      display: none;
    }

    .lot-entry summary:hover {
      background: #F0F9F9;
    }

    .lot-entry[open] summary {
      background: #F0F9F9;
    }

    .lot-summary-left {
      display: flex;
      align-items: center;
      gap: 32px;
      min-width: 0;
      flex: 1;
    }

    .lot-icon {
      width: 52px;
      height: 52px;
      border-radius: 10px;
      background: linear-gradient(135deg, rgba(43, 122, 120, 0.18), rgba(43, 122, 120, 0.06));
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--primary);
      flex-shrink: 0;
    }

    .lot-icon svg {
      width: 32px;
      height: 32px;
    }

    .lot-lines {
      display: flex;
      flex-direction: column;
      gap: 6px;
      min-width: 0;
    }

    .lot-line {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      font-size: 12px;
      color: var(--gray-700);
    }

    .lot-line strong {
      color: var(--gray-900);
    }

    .lot-line .lot-title {
      font-size: 15px;
      font-weight: 600;
      color: var(--gray-900);
      margin: 0;
    }

    .lot-line .lot-id {
      color: var(--gray-600);
      font-weight: 500;
    }

    .lot-line .lot-timer {
      color: var(--accent-blue);
      font-weight: 600;
    }

    .lot-meta-chip {
      padding: 0;
      border-radius: 0;
      background: transparent;
      color: var(--gray-700);
      font-size: 12px;
    }

    .lot-view-link {
      color: var(--accent-blue);
      text-decoration: none;
      font-weight: 600;
    }

    .lot-view-link:hover {
      text-decoration: underline;
    }

    .lot-summary-right {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 4px;
      font-size: 12px;
      flex-shrink: 0;
      padding-right: 8px;
    }

    .countdown {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 8px;
    }

    .cd-block {
      display: grid;
      grid-template-rows: auto auto;
      gap: 4px;
      align-items: center;
      text-align: center;
    }

    .cd-digits {
      display: flex;
      gap: 4px;
    }

    .cd-box {
      width: 24px;
      height: 32px;
      background: linear-gradient(180deg, #9aa0aa 0%, #6f7683 100%);
      color: #fff;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 14px;
      box-shadow: inset 0 -1.5px 0 rgba(0, 0, 0, 0.2);
      position: relative;
    }

    .cd-box::after {
      content: "";
      position: absolute;
      left: 4px;
      right: 4px;
      top: 50%;
      height: 1px;
      background: rgba(255, 255, 255, 0.25);
    }

    .cd-label {
      font-size: 9px;
      color: var(--gray-600);
      font-weight: 600;
      text-transform: lowercase;
    }

    .cd-sep {
      font-weight: 900;
      color: var(--gray-700);
      padding: 0 1px;
      margin-top: -9px;
    }

    .pictorial-chart {
      display: flex;
      gap: 2px;
      align-items: center;
    }

    .person-icon {
      width: 16px;
      height: 16px;
      color: var(--gray-400);
      /* Darker gray for better visibility */
    }

    .person-icon.active {
      color: #2B7A78;
    }

    .works-modal {
      display: flex;
      flex-direction: column;
      gap: 12px;
      padding: 0;
    }

    .works-header {
      display: grid;
      grid-template-columns: 1fr 100px 90px;
      gap: 8px;
      padding: 10px 16px;
      background: var(--gray-50);
      border-bottom: 1px solid var(--gray-200);
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--gray-500);
      font-weight: 700;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .sort-switch {
      display: flex;
      background: var(--gray-100);
      padding: 4px;
      border-radius: 8px;
      gap: 4px;
      /* width: fit-content; Removing this to let it stretch if needed or keep it compact */
      margin-right: auto;
    }

    .sort-btn {
      padding: 6px 12px;
      border: none;
      background: transparent;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
      color: var(--gray-600);
      cursor: pointer;
      transition: all 0.2s;
    }

    .sort-btn:hover {
      color: var(--gray-900);
      background: rgba(255, 255, 255, 0.5);
    }

    .sort-btn.active {
      background: #fff;
      color: var(--primary);
      font-weight: 600;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .offers-toolbar {
      padding: 12px 16px;
      background: #fafafa;
      border-bottom: 1px solid var(--gray-200);
    }

    /* Document icon buttons */
    .doc-icon-btn {
      display: flex;
      align-items: center;
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 10px;
      cursor: pointer;
      transition: all 0.2s;
      background: var(--gray-100);
      color: var(--gray-400);
      border: 1px solid var(--gray-200);
    }

    .doc-icon-btn:hover {
      background: var(--gray-200);
      color: var(--gray-600);
    }

    .doc-icon-btn.active {
      background: #dcfce7;
      color: #16a34a;
      border-color: #22c55e;
      cursor: pointer;
    }

    .doc-icon-btn.active:hover {
      background: #bbf7d0;
    }

    .works-block-group {
      border-bottom: 1px solid var(--gray-200);
    }

    .works-block-group summary {
      padding: 12px 16px;
      background: #fff;
      font-weight: 700;
      color: var(--primary);
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 14px;
      list-style: none;
    }

    .works-block-group summary::-webkit-details-marker {
      display: none;
    }

    .works-block-group summary::before {
      content: "→";
      transition: transform 0.2s;
      font-weight: normal;
      color: var(--gray-400);
    }

    .works-block-group[open] summary::before {
      transform: rotate(90deg);
    }

    .works-estimate-group {
      margin-left: 20px;
      border-left: 2px solid var(--gray-100);
      border-bottom: 1px solid var(--gray-50);
    }

    .works-estimate-group summary {
      padding: 10px 16px;
      background: #fafafa;
      font-weight: 600;
      color: var(--gray-800);
      cursor: pointer;
      font-size: 13px;
      list-style: none;
    }

    .works-estimate-group summary::-webkit-details-marker {
      display: none;
    }

    .works-estimate-group summary::before {
      content: "•";
      margin-right: 8px;
      color: var(--primary-light);
    }

    .works-stage-group {
      margin: 4px 16px 12px 32px;
      background: #fff;
      border: 1px solid var(--gray-100);
      border-radius: 6px;
    }

    .works-stage-group-title {
      padding: 8px 12px;
      font-weight: 600;
      font-size: 12px;
      color: var(--gray-600);
      background: var(--gray-50);
      border-bottom: 1px solid var(--gray-100);
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }

    .works-stage {
      border: 1px solid var(--gray-200);
      border-radius: 6px;
      padding: 10px 12px;
      background: #fff;
    }

    .works-stage+.works-stage {
      margin-top: 4px;
    }

    .works-stage-title {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 700;
      color: var(--gray-900);
      margin-bottom: 8px;
      font-size: 12px;
    }

    .works-stage-title input {
      accent-color: #2B7A78;
    }

    .works-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .works-row {
      display: grid;
      grid-template-columns: 1fr 100px 90px;
      gap: 8px;
      align-items: center;
      font-size: 12px;
      color: var(--gray-800);
      padding: 10px 12px;
      background: var(--gray-50);
      border: 1px solid var(--gray-200);
      border-radius: 6px;
    }

    .works-row input {
      accent-color: #2B7A78;
    }

    .works-name {
      font-weight: 500;
      color: var(--gray-900);
    }

    .works-volume,
    .works-unit {
      text-align: right;
      color: var(--gray-700);
      font-weight: 600;
    }

    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.35);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 16px;
      z-index: 5000;
    }

    .modal {
      background: var(--white);
      border-radius: 12px;
      border: 1px solid var(--gray-300);
      max-width: 1400px;
      width: 100%;
      padding: 16px;
      box-shadow: var(--shadow-lg);
    }

    .modal.narrow {
      max-width: 520px;
    }

    .modal h3 {
      margin: 0 0 10px;
      font-weight: 400;
    }

    .modal .meta {
      color: var(--gray-600);
      font-size: 12px;
      margin-bottom: 10px;
    }

    .modal .list {
      display: grid;
      gap: 8px;
    }

    .modal-close-btn {
      width: 32px;
      height: 32px;
      padding: 0;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border: 1px solid var(--gray-300);
      background: var(--white);
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
      flex-shrink: 0;
    }

    .modal-close-btn:hover {
      background: var(--gray-100);
      border-color: var(--gray-400);
    }

    .modal-close-btn svg {
      width: 16px;
      height: 16px;
      stroke: var(--gray-700);
    }

    .pill-small {
      padding: 4px 8px;
      border-radius: 6px;
      background: var(--gray-200);
      color: var(--gray-700);
      font-size: 12px;
    }

    .status-steps {
      display: flex;
      align-items: flex-start;
      font-size: 10px;
      color: var(--gray-700);
      width: 100%;
      justify-content: space-between;
      gap: 2px;
    }

    .step-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 42px;
      position: relative;
    }

    .status-step {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      border: 1px solid var(--gray-300);
      background: var(--gray-100);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--gray-600);
      z-index: 2;
    }

    .status-step.done {
      border-color: var(--accent-green);
      color: var(--accent-green);
      background: #e8f7ed;
    }

    .status-step.active {
      border-color: var(--gray-500);
      color: var(--gray-700);
      background: var(--gray-200);
    }

    .status-step.failed {
      border-color: var(--gray-500);
      color: var(--gray-700);
      background: var(--gray-200);
    }

    .status-step.winner {
      border-color: var(--accent-orange);
      color: var(--accent-orange);
      background: #fff7ed;
      animation: radar 2s infinite;
    }

    @keyframes radar {
      0% {
        box-shadow: 0 0 0 0 rgba(202, 80, 16, 0.4);
      }

      70% {
        box-shadow: 0 0 0 6px rgba(202, 80, 16, 0);
      }

      100% {
        box-shadow: 0 0 0 0 rgba(202, 80, 16, 0);
      }
    }

    .status-line {
      width: 4px;
      flex: 1;
      height: 1px;
      background: var(--gray-300);
      margin-top: 9px;
    }

    .status-line.done {
      background: var(--accent-green);
    }

    .status-line.active {
      background: var(--gray-400);
    }

    .status-line.failed {
      background: var(--gray-400);
    }

    .status-line.winner {
      background: var(--accent-orange);
    }

    .step-label {
      margin-top: 4px;
      font-size: 7.5px;
      text-align: center;
      line-height: 1.1;
      white-space: normal;
      word-break: break-word;
    }

    .step-label.active {
      color: var(--gray-800);
      font-weight: 400;
    }

    .step-label.done {
      color: var(--accent-green);
      font-weight: 400;
    }

    .step-label.failed {
      color: var(--gray-700);
      font-weight: 400;
    }

    .step-label.winner {
      color: var(--accent-orange);
      font-weight: 400;
    }

    .file-buttons {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    /* Legacy rows removed; using card grid for offers */
    .offers-toolbar {
      display: flex;
      gap: 8px;
      padding: 8px 0 12px;
      align-items: center;
      flex-wrap: wrap;
    }

    .sort-switch {
      display: inline-flex;
      border: 1px solid var(--gray-200);
      border-radius: 8px;
      overflow: hidden;
      background: #fff;
    }

    .sort-switch button {
      border: none;
      background: transparent;
      padding: 8px 12px;
      font-size: 12px;
      color: var(--gray-700);
      cursor: pointer;
    }

    .sort-switch button.active {
      background: var(--primary-lighter);
      color: var(--primary);
      font-weight: 600;
    }

    .offers-grid {
      display: grid;
      gap: 12px;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    }

    .offer-card {
      border: 1px solid var(--gray-200);
      border-radius: 10px;
      padding: 12px;
      background: #fff;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .offer-card.invite-card {
      justify-content: center;
      align-items: center;
      text-align: center;
      border: 1px dashed var(--gray-300);
      color: var(--primary);
      cursor: pointer;
      min-height: 180px;
      transition: border-color 0.15s ease, background 0.15s ease;
    }

    .offer-card.invite-card:hover {
      border-color: var(--primary);
      background: var(--primary-lighter);
    }

    .invite-cta {
      font-weight: 600;
      font-size: 13px;
      padding: 8px 12px;
      border-radius: 8px;
    }

    .offer-card.is-blocked {
      background: #FFE5E5;
      border-color: #FFCCCC;
    }

    .offer-card.non-winner {
      background: #f5f5f5;
      opacity: 0.7;
    }

    .offer-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 8px;
    }

    .offer-header-actions {
      display: flex;
      gap: 6px;
    }

    .offer-title {
      font-weight: 600;
      font-size: 14px;
      color: var(--gray-900);
      flex: 1;
      min-width: 0;
    }

    .offer-meta {
      display: grid;
      row-gap: 6px;
      font-size: 12px;
      color: var(--gray-700);
    }

    .offer-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    .offer-label {
      color: var(--gray-600);
      font-size: 12px;
    }

    .offer-sum {
      font-weight: 600;
      color: var(--gray-900);
    }

    .progress {
      position: relative;
      background: var(--gray-100);
      border-radius: 999px;
      height: 8px;
      flex: 1;
    }

    .progress-bar {
      height: 100%;
      background: var(--primary);
      border-radius: 999px;
      transition: width 0.2s ease;
    }

    .progress-wrap {
      display: flex;
      align-items: center;
      gap: 8px;
      width: 100%;
    }

    .progress-value {
      font-size: 12px;
      color: var(--gray-700);
      min-width: 24px;
      text-align: right;
    }

    /* Rating cubes styles */
    .rating-cubes {
      display: flex;
      gap: 3px;
      flex: 1;
    }

    .rating-cube {
      flex: 1;
      height: 8px;
      background: var(--gray-200);
      border-radius: 2px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .rating-cube.active {
      box-shadow: 0 0 4px rgba(0, 0, 0, 0.1);
    }

    .rating-cube.active:nth-child(1) {
      background: #ff4d4d;
    }

    .rating-cube.active:nth-child(2) {
      background: #ff7043;
    }

    .rating-cube.active:nth-child(3) {
      background: #ffa726;
    }

    .rating-cube.active:nth-child(4) {
      background: #ffca28;
    }

    .rating-cube.active:nth-child(5) {
      background: #fdd835;
    }

    .rating-cube.active:nth-child(6) {
      background: #c0ca33;
    }

    .rating-cube.active:nth-child(7) {
      background: #9ccc65;
    }

    .rating-cube.active:nth-child(8) {
      background: #66bb6a;
    }

    .rating-cube.active:nth-child(9) {
      background: #43a047;
    }

    .rating-cube.active:nth-child(10) {
      background: #2e7d32;
    }

    .offer-actions {
      display: flex;
      gap: 8px;
      justify-content: space-between;
      flex-wrap: nowrap;
    }

    .offer-actions .btn {
      flex: 1;
    }

    .offer-status {
      padding: 4px 0;
    }

    .block-banner-inline {
      margin-top: 4px;
      font-size: 12px;
      color: var(--gray-800);
    }

    /* Block button */
    .block-btn {
      width: 32px;
      height: 32px;
      padding: 0;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border: 1px solid var(--gray-300);
      background: var(--white);
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .block-btn:hover {
      background: var(--gray-100);
      border-color: var(--gray-400);
    }

    .block-btn.blocked {
      background: var(--accent-red);
      border-color: var(--accent-red);
    }

    .block-btn.blocked:hover {
      background: #B02D31;
    }

    .block-btn svg {
      width: 16px;
      height: 16px;
      stroke: var(--gray-700);
    }

    .block-btn.blocked svg {
      stroke: white;
    }

    .share-btn {
      width: 32px;
      height: 32px;
      padding: 0;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border: 1px solid var(--gray-300);
      background: var(--white);
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .share-btn:hover {
      background: var(--gray-100);
      border-color: var(--gray-400);
    }

    .share-btn svg {
      width: 16px;
      height: 16px;
      stroke: var(--gray-700);
    }

    .lot-share-btn {
      width: 32px;
      height: 32px;
      padding: 0;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border: 1px solid var(--gray-300);
      background: var(--white);
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .lot-share-btn:hover {
      background: var(--gray-100);
      border-color: var(--gray-400);
    }

    .lot-share-btn svg {
      width: 16px;
      height: 16px;
      stroke: var(--gray-700);
    }

    .lot-share-btn {
      width: 32px;
      height: 32px;
      padding: 0;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border: 1px solid var(--gray-300);
      background: var(--white);
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .lot-share-btn:hover {
      background: var(--gray-100);
      border-color: var(--gray-400);
    }

    .lot-share-btn svg {
      width: 16px;
      height: 16px;
      stroke: var(--gray-700);
    }

    .offer-title-box {
      display: flex;
      flex-direction: column;
      gap: 3px;
    }

    .offer-code-badge {
      font-size: 11px;
      color: var(--primary);
      background: rgba(43, 122, 120, 0.08);
      padding: 2px 6px;
      border-radius: 4px;
      width: fit-content;
      cursor: pointer;
      display: flex;
      align-items: center;
      transition: all 0.2s;
      font-weight: 600;
      border: 1px solid rgba(43, 122, 120, 0.2);
    }

    .offer-code-badge:hover {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    .delete-lot-btn {
      width: 32px;
      height: 32px;
      padding: 0;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border: 1px solid var(--gray-300);
      background: var(--white);
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .delete-lot-btn:hover {
      background: var(--gray-100);
      border-color: var(--gray-400);
    }

    .delete-lot-btn svg {
      width: 16px;
      height: 16px;
      stroke: var(--gray-700);
    }

    /* Blocked row state */
    .sub-row.blocked {
      background: var(--gray-200);
    }

    .sub-row.blocked:hover {
      background: var(--gray-300);
    }

    .block-reason-banner {
      background: #FFE5E5;
      border: 1px solid #FFCCCC;
      border-radius: 6px;
      padding: 12px;
      font-size: 12px;
      color: var(--gray-800);
    }

    .block-reason-banner strong {
      color: var(--accent-red);
      font-weight: 600;
    }

    .share-link-box {
      background: var(--gray-50);
      border: 1px solid var(--gray-300);
      border-radius: 8px;
      padding: 12px;
      margin-top: 12px;
    }

    .share-link-input {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid var(--gray-300);
      border-radius: 6px;
      font-family: monospace;
      font-size: 12px;
      background: #fff;
    }

    .share-link-copy {
      margin-top: 8px;
    }

    /* Subcontractor Modal Styles */
    .modal.wide {
      max-width: 900px;
      width: 90%;
    }

    .sub-grid {
      display: grid;
      grid-template-columns: 350px 1fr;
      gap: 20px;
      height: 60vh;
      min-height: 400px;
    }

    .sub-left-panel,
    .sub-right-panel {
      display: flex;
      flex-direction: column;
      overflow: hidden;
      border: 1px solid var(--gray-200);
      border-radius: 8px;
      background: #fafafa;
    }

    .sub-panel-header {
      padding: 12px;
      border-bottom: 1px solid var(--gray-200);
      background: #fff;
    }

    .sub-filter-row {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .sub-input {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid var(--gray-300);
      border-radius: 6px;
      font-size: 13px;
      color: var(--gray-800);
      transition: all 0.2s;
      background: #fff;
    }

    .sub-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(43, 122, 120, 0.15);
    }

    .sub-input::placeholder {
      color: var(--gray-400);
    }

    .sub-list-scroll {
      flex: 1;
      overflow-y: auto;
      background: #fff;
    }

    .sub-item-row {
      padding: 10px 12px;
      border-bottom: 1px solid var(--gray-100);
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 12px;
      transition: background 0.2s;
    }

    .sub-item-row:hover {
      background: var(--gray-50);
    }

    .sub-item-row.selected {
      background: var(--primary-lighter);
    }

    .sub-item-row.active {
      border-left: 3px solid var(--primary);
      background: var(--gray-50);
    }

    .sub-item-photo {
      width: 40px;
      height: 40px;
      border-radius: 6px;
      background: var(--gray-200);
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }

    .sub-item-photo img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .sub-item-info {
      flex: 1;
      min-width: 0;
    }

    .sub-item-name {
      font-weight: 600;
      font-size: 13px;
      color: var(--gray-900);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .sub-item-inn {
      font-size: 11px;
      color: var(--gray-500);
    }

    .sub-checkbox {
      width: 18px;
      height: 18px;
      accent-color: var(--primary);
    }

    .sub-tabs {
      display: flex;
      background: #fff;
      border-bottom: 1px solid var(--gray-200);
    }

    .sub-tab-btn {
      flex: 1;
      padding: 10px;
      border: none;
      background: none;
      font-size: 12px;
      font-weight: 600;
      color: var(--gray-500);
      cursor: pointer;
      border-bottom: 2px solid transparent;
    }

    .sub-tab-btn.active {
      color: var(--primary);
      border-bottom-color: var(--primary);
    }

    .sub-work-list-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 0;
      border-bottom: 1px solid var(--gray-100);
      font-size: 13px;
      color: var(--gray-700);
    }

    .sub-work-list-item:last-child {
      border-bottom: none;
    }

    .sub-work-dot {
      width: 6px;
      height: 6px;
      background: var(--primary);
      border-radius: 50%;
      flex-shrink: 0;
    }

    .sub-tab-pane {
      display: none;
      padding: 16px;
      flex: 1;
      overflow-y: auto;
    }

    .sub-tab-pane.active {
      display: block;
    }

    .sub-empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: var(--gray-400);
      font-size: 13px;
    }

    .sub-item-row.existing {
      background: #fdfdfd;
      cursor: pointer;
    }

    .sub-item-row.existing:hover {
      background: var(--gray-50);
    }

    .existing-badge {
      font-size: 10px;
      color: var(--accent-green);
      background: #eefdf3;
      padding: 2px 6px;
      border-radius: 4px;
      font-weight: 600;
      margin-left: auto;
      border: 1px solid rgba(16, 124, 16, 0.1);
    }

    @keyframes spin {
      from {
        transform: rotate(0deg);
      }

      to {
        transform: rotate(360deg);
      }
    }

    /* Tree and Works Modal Styles */
    .tree-grid-header {
      position: sticky;
      top: 0;
      z-index: 10;
      display: grid;
      grid-template-columns: 1fr 80px 70px 110px;
      column-gap: 12px;
      padding: 12px 16px;
      background: var(--gray-50);
      border-bottom: 1px solid var(--gray-200);
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      color: var(--gray-500);
      font-weight: 700;
    }

    #modal-body.list {
      max-height: calc(90vh - 120px);
      overflow-y: auto;
      padding: 0;
    }

    .works-modal {
      display: flex;
      flex-direction: column;
      min-width: 600px;
    }

    .works-block-group {
      border-bottom: 1px solid var(--gray-100);
      background: #fff;
    }

    .works-block-content,
    .works-estimate-content {
      background: #fafafa;
    }

    .works-block-group summary {
      padding: 14px 16px;
      font-weight: 700;
      color: var(--primary);
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 14px;
      list-style: none;
      transition: background 0.2s;
    }

    .works-block-group summary:hover {
      background: var(--gray-50);
    }

    .works-block-group summary::before {
      content: "";
      width: 0;
      height: 0;
      border-top: 5px solid transparent;
      border-bottom: 5px solid transparent;
      border-left: 7px solid var(--gray-400);
      transition: transform 0.2s;
    }

    .works-block-group[open]>summary::before {
      transform: rotate(90deg);
    }

    .works-estimate-group {
      margin-left: 20px;
      border-left: 2px solid var(--gray-100);
    }

    .works-estimate-group summary {
      padding: 12px 16px;
      background: #fafafa;
      font-weight: 600;
      color: var(--gray-800);
      cursor: pointer;
      font-size: 13px;
      list-style: none;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .works-estimate-group summary::before {
      content: "•";
      font-weight: bold;
      color: var(--primary-light);
    }

    .works-stage-group {
      margin: 8px 16px 16px 32px;
      background: #fff;
      border: 1px solid var(--gray-200);
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.02);
    }

    .works-stage-group-title {
      padding: 10px 14px;
      font-weight: 700;
      font-size: 11px;
      color: var(--gray-600);
      background: var(--gray-50);
      border-bottom: 1px solid var(--gray-100);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .works-row {
      display: grid;
      grid-template-columns: 1fr 80px 70px 110px;
      gap: 12px;
      padding: 10px 14px;
      font-size: 13px;
      align-items: start;
      border-bottom: 1px solid #f5f5f5;
    }

    .works-row:last-child {
      border-bottom: none;
    }

    .works-name {
      color: var(--gray-800);
      line-height: 1.5;
    }

    .works-volume,
    .works-unit,
    .works-sum {
      color: var(--gray-600);
      font-weight: 500;
      font-variant-numeric: tabular-nums;
      text-align: left;
    }

    .works-sum {
      color: var(--primary);
      font-weight: 600;
    }

    .doc-icon-btn {
      display: flex;
      align-items: center;
      padding: 4px 8px;
      border-radius: 4px;
      border: 1px solid var(--gray-200);
      background: var(--gray-50);
      color: var(--gray-400);
      cursor: default;
      transition: all 0.2s;
    }

    .doc-icon-btn.active {
      color: #107C10;
      background: #E8F5E9;
      border-color: rgba(16, 124, 16, 0.2);
      cursor: pointer;
    }

    .doc-icon-btn.active:hover {
      background: #C8E6C9;
    }

    .modal-footer {
      padding-top: 16px;
      margin-top: 16px;
      border-top: 1px solid var(--gray-200);
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #fff;
    }
  </style>
</head>

<body>
  <div class="main">
    <section class="card" aria-label="Лоты">
      <h2>Лоты</h2>
      <div class="filters">
        <span class="chip active" data-filter="all">Все</span>
        <span class="chip" data-filter="open">Открытые</span>
        <span class="chip" data-filter="closed">Закрытые</span>
      </div>
      <div id="lot-list" class="lot-list"></div>
    </section>
  </div>

  <div class="modal-backdrop" id="modal">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="header" id="modal-header-standard">
        <div class="row" style="justify-content: space-between; align-items: center;">
          <h3 id="modal-title">Отклик</h3>
          <button class="btn secondary" id="modal-close">Закрыть</button>
        </div>
      </div>
      <div class="meta" id="modal-meta"></div>
      <div id="modal-body" class="list"></div>
      <div id="modal-footer" class="modal-footer" style="display: none;"></div>
    </div>
  </div>

  <script src="js/api.js"></script>
  <script src="js/tenderApi.js"></script>
  <script>
    // Create global reference for probimApi
    window.probimApi = api;

    // State
    const CURRENT_PROJECT_ID = '902eeb62-5a34-4e69-933e-784ea2127910'; // TODO: Получать из URL или глобального состояния

    // Import API functions with aliases to avoid name collisions
    const apiGetTenders = getTenders;
    const apiGetTender = getTender;
    const apiCreateTender = createTender;
    const apiInviteSubcontractor = inviteSubcontractor;
    const apiToggleBidBlock = toggleBidBlock;
    const apiSelectWinner = selectWinner;
    const apiCreateContract = createContract;
    const apiCancelContract = cancelContract;

    let lots = [];
    let PROJECT_CURRENCY = 'UZS';

    /**
     * Форматирование суммы с учетом валюты проекта
     */
    function formatMoney(amount, currency = PROJECT_CURRENCY) {
      if (amount === undefined || amount === null || isNaN(amount)) return '—';

      const currencySymbols = {
        'UZS': 'сўм',
        'RUB': '₽',
        'USD': '$',
        'EUR': '€',
        'KGS': 'сом',
        'KZT': '₸'
      };

      const symbol = currencySymbols[currency] || currency || '';
      const formatted = new Intl.NumberFormat('ru-RU', {
        minimumFractionDigits: 0,
        maximumFractionDigits: 0,
      }).format(amount);

      return `${formatted} ${symbol}`;
    }

    let lotFilter = "all";
    let objectFilter = null;
    let offerSortMode = "score"; // score|sum

    function renderObjects() {
      // Sidebar removed
    }

    const statusLabel = {
      open: "Открыт",
      closed: "Закрыт",
      parsed: "Разобран",
      parsing: "Разбор",
      uploaded: "Загружен",
      failed: "Ошибка",
      invited: "Приглашен",
      winner: "Победитель"
    };

    const statusBadge = (status) => {
      const map = {
        open: { cls: "b-open", icon: '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 9.9-1"/></svg>' },
        closed: { cls: "b-closed", icon: '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M20 13c0 5-3.5 7.5-7.66 8.95a1 1 0 0 1-.67-.01C7.5 20.5 4 18 4 13V6a1 1 0 0 1 1-1c2 0 4.5-1.2 6.24-2.72a1.17 1.17 0 0 1 1.52 0C14.51 3.81 17 5 19 5a1 1 0 0 1 1 1z"/><path d="m9 12 2 2 4-4"/></svg>' },
        parsed: { cls: "b-parsed" },
        parsing: { cls: "b-parsing" },
        uploaded: { cls: "b-uploaded" },
        failed: { cls: "b-failed" },
        invited: { cls: "b-draft" },
        winner: { cls: "b-parsed" }
      };
      const cfg = map[status] || { cls: "b-draft" };
      const label = statusLabel[status] || status;
      const icon = cfg.icon ? `<span style="display:inline-flex; align-items:center; gap:6px;">${cfg.icon}<span>${label}</span></span>` : label;
      return `<span class="badge ${cfg.cls}">${icon}</span>`;
    };

    const lotIconSvg = `
      <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#2B7A78" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="m11 17 2 2a1 1 0 1 0 3-3"/>
        <path d="m14 14 2.5 2.5a1 1 0 1 0 3-3l-3.88-3.88a3 3 0 0 0-4.24 0l-.88.88a1 1 0 1 1-3-3l2.81-2.81a5.79 5.79 0 0 1 7.06-.87l.47.28a2 2 0 0 0 1.42.25L21 4"/>
        <path d="m21 3 1 11h-2"/>
        <path d="M3 3 2 14l6.5 6.5a1 1 0 1 0 3-3"/>
        <path d="M3 4h8"/>
      </svg>
    `;

    function copyToClipboard(text, el) {
      if (!text || text === '—') return;
      navigator.clipboard.writeText(text).then(() => {
        const originalText = el.innerHTML;
        el.innerHTML = 'Код скопирован!';
        el.style.background = 'var(--accent-blue)';
        el.style.color = '#fff';
        setTimeout(() => {
          el.innerHTML = originalText;
          el.style.background = '';
          el.style.color = '';
        }, 1500);
      }).catch(err => {
        console.error('Copy failed', err);
      });
    }

    async function shareLot(lotId) {
      try {
        const response = await fetch(`/api/tenders/${lotId}/share-link`);
        if (!response.ok) throw new Error('Failed to get share link');
        const { url } = await response.json();

        resetModalStructure();
        const inner = modal.querySelector('.modal');
        inner.classList.add('narrow');
        modalTitle.textContent = "Поделиться лотом";
        modalMeta.textContent = `ID: ${lotId}`;
        modalBody.innerHTML = `
              <div class="share-link-box">
                  <label style="display: block; margin-bottom: 8px; font-size: 13px; color: var(--gray-700); font-weight: 600;">Универсальная ссылка для субподрядчиков:</label>
                  <div style="position: relative;">
                    <input type="text" class="share-link-input" value="${url}" readonly id="share-lot-url-input" style="width: 100%; padding: 10px; padding-right: 40px; border: 1px solid var(--gray-300); border-radius: 6px; font-size: 13px;">
                    <button id="copy-lot-url" style="position: absolute; right: 5px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; color: var(--primary);">
                      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                    </button>
                  </div>
                  <div style="margin-top: 12px; font-size: 12px; color: var(--gray-500); line-height: 1.4;">
                    Передайте эту ссылку субподрядчикам вместе с их 4-значным кодом доступа.
                  </div>
              </div>
          `;
        modal.style.display = "flex";

        document.getElementById("copy-lot-url").addEventListener("click", () => {
          const input = document.getElementById("share-lot-url-input");
          input.select();
          navigator.clipboard.writeText(url).then(() => {
            alert("Ссылка скопирована!");
          });
        });
      } catch (err) {
        console.error(err);
        alert('Ошибка при создании ссылки: ' + err.message);
      }
    }



    const formatDate = (value) => {
      if (!value) return "—";
      const date = new Date(value);
      if (Number.isNaN(date.getTime())) return value;
      return date.toLocaleDateString('ru-RU');
    };

    const statusStepper = (status) => {
      const steps = [
        { key: "login", label: "Вход", icon: '<svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path><polyline points="10 17 15 12 10 7"></polyline><line x1="15" y1="12" x2="3" y2="12"></line></svg>' },
        { key: "docs", label: "Документы", icon: '<svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>' },
        { key: "uploaded", label: "Загрузка оферты", icon: '<svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M12 16V4"></path><polyline points="8 8 12 4 16 8"></polyline><rect x="4" y="16" width="16" height="4" rx="1"></rect></svg>' },
        { key: "parsed", label: "Разобрано", icon: '<svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>' },
        { key: "winner", label: "Победитель", icon: '<svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>' },
        { key: "contract", label: "Договор", icon: '<svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>' }
      ];
      // map status to step index
      const stateIndex = {
        invited: -1,
        login: 0,
        docs: 1,
        uploaded: 2,
        parsing: 3,
        parsed: 3,
        winner: 4,
        contract: 5
      };
      const current = stateIndex[status] ?? -1;
      const failed = status === "failed";
      const winner = status === "winner";
      const invited = status === "invited" || current === -1;

      const html = steps.map((step, i) => {
        const isLast = i === steps.length - 1;

        // Line logic
        let lineHtml = "";
        if (!isLast) {
          let lineClass = "status-line";
          if (failed && i === 3) lineClass += " failed";
          else if (i < current) lineClass += " done";
          else if (i === current && !invited) lineClass += " active";

          lineHtml = `<div class="${lineClass}"></div>`;
        }

        // Step logic
        let stepClass = "status-step";
        if (failed && i === 4) stepClass += " failed";
        else if (winner && i === 4) stepClass += " winner";
        else if (!invited && i <= current) stepClass += " done";

        // Special case for invited: first step is active (waiting for login/entry)
        if (invited && i === 0) stepClass = "status-step active";

        // Label logic
        let labelClass = "step-label";
        if (failed && i === 4) labelClass += " failed";
        else if (winner && i === 4) labelClass += " winner";
        else if (!invited && i <= current) labelClass += " done";

        if (invited && i === 0) labelClass = "step-label active";

        let labelText = step.label;
        if (failed && i === 4) labelText = "Ошибка";

        return `
          <div class="step-item">
            <div class="${stepClass}">${step.icon}</div>
            <div class="${labelClass}">${labelText}</div>
          </div>
          ${lineHtml}
        `;
      }).join("");

      return `<div class="status-steps">${html}</div>`;
    };

    function updateCountdowns() {
      document.querySelectorAll('.countdown').forEach(el => {
        const deadline = el.getAttribute('data-deadline');
        if (!deadline) return;

        const target = new Date(deadline + "T23:59:59");
        const now = new Date();
        const diff = target - now;

        if (diff <= 0) {
          if (!el.classList.contains('expired')) {
            el.classList.add('expired');
            el.innerHTML = `
              <div style="color: #d32f2f; font-weight: 700; font-size: 12px; padding: 14px 0; background: #ffebee; border-radius: 6px; border: 1px solid #ffcdd2; width: 264px; text-align: center; display: flex; align-items: center; justify-content: center; gap: 8px;">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
                <span>Срок приёма данных истёк</span>
              </div>`;
          }
          return;
        }

        const p = countdownParts(deadline);
        if (!p) return;

        const map = {
          days: p.days,
          hours: p.hours,
          mins: p.mins,
          secs: p.secs
        };
        Object.entries(map).forEach(([unit, val]) => {
          const digits = val.split("");
          el.querySelectorAll(`[data-unit="${unit}"]`).forEach(box => {
            const idx = Number(box.getAttribute('data-idx')) || 0;
            box.textContent = digits[idx] ?? "0";
          });
        });
      });
    }

    setInterval(updateCountdowns, 1000);

    const deadlineLabel = (dateStr) => {
      const target = new Date(dateStr + "T23:59:59");
      const now = new Date();
      const diff = target - now;
      if (Number.isNaN(diff)) return "дедлайн не задан";
      if (diff <= 0) return "дедлайн истёк";

      // Use the same calculation logic as subcontractor-portal.html
      const days = Math.floor(diff / (1000 * 60 * 60 * 24));
      const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
      const mins = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
      const secs = Math.floor((diff % (1000 * 60)) / 1000);

      const parts = [];
      if (days > 0) parts.push(`${days} д`);
      parts.push(`${hours.toString().padStart(2, "0")}:${mins.toString().padStart(2, "0")}:${secs.toString().padStart(2, "0")}`);
      return `до дедлайна ${parts.join(" · ")}`;
    };

    const countdownParts = (dateStr) => {
      if (!dateStr) return null;

      let target;
      // Check if date already has time component (ISO format like 2025-12-31T23:59:59.000Z)
      if (dateStr.includes('T')) {
        target = new Date(dateStr);
      } else {
        // Simple date format like 2025-12-31, add end of day
        target = new Date(dateStr + "T23:59:59");
      }

      if (Number.isNaN(target.getTime())) return null;
      const now = new Date();
      let diff = target - now;
      if (diff < 0) diff = 0;

      // Use the same calculation logic as subcontractor-portal.html
      const days = Math.floor(diff / (1000 * 60 * 60 * 24));
      const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
      const mins = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
      const secs = Math.floor((diff % (1000 * 60)) / 1000);

      return {
        days: String(Math.min(days, 99)).padStart(2, "0"),
        hours: String(hours).padStart(2, "0"),
        mins: String(mins).padStart(2, "0"),
        secs: String(secs).padStart(2, "0"),
      };
    };

    const countdownMarkup = (deadline) => {
      if (!deadline) return `<div class="countdown" data-deadline=""></div>`;

      const target = new Date(deadline + "T23:59:59");
      const now = new Date();
      if (target - now <= 0) {
        return `
          <div class="countdown expired" data-deadline="${deadline}">
            <div style="color: #d32f2f; font-weight: 700; font-size: 12px; padding: 14px 0; background: #ffebee; border-radius: 6px; border: 1px solid #ffcdd2; width: 264px; text-align: center; display: flex; align-items: center; justify-content: center; gap: 8px;">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
              <span>Срок приёма данных истёк</span>
            </div>
          </div>
        `;
      }

      const p = countdownParts(deadline) || { days: "00", hours: "00", mins: "00", secs: "00" };
      const unitBoxes = (val, unit) => `
        <div class="cd-digits">
          <div class="cd-box" data-unit="${unit}" data-idx="0">${val[0]}</div>
          <div class="cd-box" data-unit="${unit}" data-idx="1">${val[1]}</div>
        </div>`;

      return `
        <div class="countdown" data-deadline="${deadline}">
          <div class="cd-block">
            ${unitBoxes(p.days, 'days')}
            <div class="cd-label">Дни</div>
          </div>
          <div class="cd-sep">:</div>
          <div class="cd-block">
            ${unitBoxes(p.hours, 'hours')}
            <div class="cd-label">Часы</div>
          </div>
          <div class="cd-sep">:</div>
          <div class="cd-block">
            ${unitBoxes(p.mins, 'mins')}
            <div class="cd-label">Минуты</div>
          </div>
          <div class="cd-sep">:</div>
          <div class="cd-block">
            ${unitBoxes(p.secs, 'secs')}
            <div class="cd-label">Секунды</div>
          </div>
        </div>
      `;
    };

    const modal = document.getElementById("modal");
    let modalTitle = document.getElementById("modal-title");
    let modalMeta = document.getElementById("modal-meta");
    let modalBody = document.getElementById("modal-body");

    function resetModalStructure() {
      const inner = modal.querySelector('.modal');
      const footer = document.getElementById("modal-footer");
      const headerStd = document.getElementById("modal-header-standard");

      if (footer) {
        footer.style.display = "none";
        footer.innerHTML = "";
      }
      if (headerStd) headerStd.style.display = "block";
      const closeBtnHeader = document.getElementById("modal-close");
      if (closeBtnHeader) closeBtnHeader.style.visibility = "visible";

      // Check if standard structure exists
      if (!inner.querySelector("#modal-title") || !inner.querySelector("#modal-body")) {
        inner.innerHTML = `
              <div class="header" id="modal-header-standard">
                <div class="row" style="justify-content: space-between; align-items: center;">
                  <h3 id="modal-title"></h3>
                  <button class="modal-close-btn" id="modal-close" title="Закрыть">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <line x1="18" y1="6" x2="6" y2="18"></line>
                      <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                  </button>
                </div>
              </div>
              <div class="meta" id="modal-meta"></div>
              <div id="modal-body" class="list"></div>
              <div id="modal-footer" class="modal-footer" style="display: none;"></div>
            `;
        // Update references if they changed due to innerHTML
        modalTitle = document.getElementById("modal-title");
        modalMeta = document.getElementById("modal-meta");
        modalBody = document.getElementById("modal-body");

        const closeBtn = document.getElementById("modal-close");
        if (closeBtn) closeBtn.addEventListener("click", closeModal);
      }
    }

    function openResponse(upload, lot) {
      resetModalStructure();
      modalTitle.textContent = `${upload.subcontractor} · ${lot.id}`;
      modalMeta.textContent = `${upload.coverage} · статус ${statusLabel[upload.status] || upload.status} · ${deadlineLabel(lot.deadline)}`;
      modalBody.innerHTML = `
        <div class="tag">Файлы</div>
        <div class="files">${upload.files.map(f => `<a href="${f.url}">${f.name}</a> <span class="muted">(${f.kind})</span>`).join(" · ")}</div>
        ${upload.report ? `<div class="tag">Отчёт</div><div>${upload.report}</div>` : ""}
        ${upload.errors && upload.errors.length ? `<div class="tag">Ошибки</div><div class="muted">${upload.errors.join("; ")}</div>` : ""}
      `;
      modal.style.display = "flex";
    }

    function closeModal() { modal.style.display = "none"; }

    document.getElementById("modal-close").addEventListener("click", closeModal);
    modal.addEventListener("click", (e) => { if (e.target === modal) closeModal(); });

    // --- Add Subcontractor Logic ---
    async function openAddSubModal(lotId) {
      resetModalStructure();
      const inner = modal.querySelector('.modal');
      inner.classList.remove('narrow', 'medium');
      inner.classList.add('wide');
      modalTitle.textContent = "Добавить участников в лот";
      modalMeta.textContent = "Выберите субподрядчиков из списка";

      modalBody.innerHTML = `
        <div class="sub-grid">
            <!-- Left Side -->
            <div class="sub-left-panel">
                <div class="sub-panel-header">
                    <div class="sub-filter-row">
                        <input type="text" id="sub-search" class="sub-input" placeholder="Поиск по названию или ИНН...">
                        <select id="sub-work-filter" class="sub-input">
                            <option value="">Все виды работ</option>
                            <!-- populated by js -->
                        </select>
                    </div>
                </div>
                <div id="sub-modal-list" class="sub-list-scroll">
                    <div class="sub-empty-state">Загрузка данных...</div>
                </div>
            </div>

            <!-- Right Side -->
            <div class="sub-right-panel" id="sub-details-panel">
                <div class="sub-empty-state" style="opacity: 0.6;">
                    <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="margin-bottom: 12px;"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                    <div style="font-size: 13px;">Выберите организацию для просмотра деталей</div>
                </div>
            </div>
        </div>
      `;

      // Setup Footer
      const footer = document.getElementById("modal-footer");
      footer.style.display = "flex";
      footer.innerHTML = `
        <button class="btn secondary" id="modal-close-footer" style="min-width: 100px;">Закрыть</button>
        <button class="btn" id="confirm-selection" disabled style="min-width: 160px;">Пригласить (0)</button>
      `;
      document.getElementById("modal-close-footer").addEventListener("click", closeModal);

      // Hide header close button to emphasize footer buttons
      const closeBtn = document.getElementById("modal-close");
      if (closeBtn) closeBtn.style.visibility = "hidden";
      modal.style.display = "flex";

      try {
        const subs = await window.probimApi.getSubcontractors(CURRENT_PROJECT_ID);
        const listContainer = document.getElementById("sub-modal-list");
        const workFilter = document.getElementById("sub-work-filter");
        const searchInput = document.getElementById("sub-search");
        const confirmBtn = document.getElementById("confirm-selection");
        const detailsPanel = document.getElementById("sub-details-panel");

        let selectedSubs = new Set();
        let currentFocusedSubId = null;

        // Find already added subcontractors in this lot
        const lot = lots.find(l => l.id === lotId);
        const existingSubIds = new Set();
        if (lot && lot.uploads) {
          lot.uploads.forEach(u => {
            const sId = u._rawData?.subcontractor?.id || u._rawData?.subcontractorId;
            if (sId) existingSubIds.add(sId);
          });
        }

        // Collect all work types
        const allWorkTypes = new Set();
        subs.forEach(s => {
          if (s.workTypes) {
            try {
              const types = Array.isArray(s.workTypes) ? s.workTypes : JSON.parse(s.workTypes);
              types.forEach(t => allWorkTypes.add(t));
            } catch (e) {
              s.workTypes.split(',').map(t => t.trim()).forEach(t => { if (t) allWorkTypes.add(t); });
            }
          }
        });

        workFilter.innerHTML += Array.from(allWorkTypes).sort().map(tw => `<option value="${tw}">${tw}</option>`).join('');

        const renderSubs = () => {
          const searchText = searchInput.value.toLowerCase();
          const selectedWork = workFilter.value;

          const filtered = subs.filter(s => {
            const matchesSearch = (s.company || "").toLowerCase().includes(searchText) || String(s.inn || "").includes(searchText);

            let matchesWorks = true;
            if (selectedWork) {
              const subWorks = [];
              if (s.workTypes) {
                try {
                  const parsed = Array.isArray(s.workTypes) ? s.workTypes : JSON.parse(s.workTypes);
                  subWorks.push(...parsed);
                } catch (e) { subWorks.push(...s.workTypes.split(',').map(t => t.trim())); }
              }
              matchesWorks = subWorks.includes(selectedWork);
            }

            return matchesSearch && matchesWorks;
          }).sort((a, b) => (a.company || "").localeCompare(b.company || ""));

          if (filtered.length === 0) {
            listContainer.innerHTML = `<div class="sub-empty-state">Ничего не найдено</div>`;
            return;
          }

          listContainer.innerHTML = filtered.map(s => {
            const isExisting = existingSubIds.has(s.id);
            return `
            <div class="sub-item-row ${s.id === currentFocusedSubId ? 'active' : ''} ${selectedSubs.has(s.id) ? 'selected' : ''} ${isExisting ? 'existing' : ''}" data-id="${s.id}">
                ${isExisting ?
                '<div style="width:18px; display:flex; align-items:center; justify-content:center;"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="var(--accent-green)" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg></div>' :
                `<input type="checkbox" class="sub-checkbox" ${selectedSubs.has(s.id) ? 'checked' : ''} data-id="${s.id}">`
              }
                <div class="sub-item-photo">
                    ${s.companyPhoto ? `<img src="${s.companyPhoto}" alt="">` : '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="opacity:0.4;"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>'}
                </div>
                <div class="sub-item-info">
                    <div class="sub-item-name">${s.company || "Без названия"}</div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                      <div class="sub-item-inn">ИНН: ${s.inn || "—"}</div>
                      <span style="display: inline-flex; align-items: center; gap: 3px; color: #f59e0b; font-size: 10px; font-weight: 700; background: #fffbeb; padding: 0px 5px; border-radius: 10px; border: 1px solid #fef3c7;">
                          <svg width="9" height="9" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
                          0.0
                      </span>
                    </div>
                </div>
                ${isExisting ? '<span class="existing-badge">В лоте</span>' : '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="opacity:0.3;"><polyline points="9 18 15 12 9 6"></polyline></svg>'}
            </div>
          `}).join('');

          listContainer.querySelectorAll(".sub-item-row").forEach(row => {
            const id = row.dataset.id;
            const sub = subs.find(s => s.id === id);

            row.addEventListener('click', (e) => {
              if (e.target.classList.contains('sub-checkbox')) return;
              showSubDetails(sub);
              currentFocusedSubId = id;
              listContainer.querySelectorAll('.sub-item-row').forEach(r => r.classList.remove('active'));
              row.classList.add('active');
            });

            const checkbox = row.querySelector('.sub-checkbox');
            if (checkbox) {
              checkbox.addEventListener('change', () => {
                if (checkbox.checked) selectedSubs.add(id);
                else selectedSubs.delete(id);
                row.classList.toggle('selected', checkbox.checked);
                confirmBtn.disabled = selectedSubs.size === 0;
                confirmBtn.textContent = `Пригласить (${selectedSubs.size})`;
              });
            }
          });
        };

        const showSubDetails = async (sub) => {
          detailsPanel.innerHTML = `
            <div class="sub-panel-header" style="padding-bottom: 2px;">
                <div style="font-weight: 700; font-size: 15px; color: var(--primary);">${sub.company}</div>
                <div style="display: flex; align-items: center; gap: 10px; margin-top: 2px;">
                  <div style="font-size: 12px; color: var(--gray-600);">ИНН: ${sub.inn || '—'}</div>
                  <span style="display: inline-flex; align-items: center; gap: 3px; color: #f59e0b; font-size: 11px; font-weight: 700; background: #fffbeb; padding: 1px 6px; border-radius: 12px; border: 1px solid #fef3c7;">
                      <svg width="10" height="10" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
                      0.0
                  </span>
                </div>
                <div style="font-size: 12px; color: var(--gray-600); margin-top: 4px;">${sub.lastName} ${sub.firstName} · ${sub.phone}</div>
            </div>
            <div class="sub-tabs">
                <button class="sub-tab-btn active" data-tab="works">Виды работ</button>
                <button class="sub-tab-btn" data-tab="history">Успешные лоты</button>
            </div>
            <div class="sub-tab-pane active" id="tab-works">
                <div class="sub-work-list">
                    ${renderWorkList(sub.workTypes)}
                </div>
            </div>
            <div class="sub-tab-pane" id="tab-history">
                <div class="sub-empty-state">Загрузка истории...</div>
            </div>
          `;

          // Handle tab switching
          detailsPanel.querySelectorAll('.sub-tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
              detailsPanel.querySelectorAll('.sub-tab-btn').forEach(b => b.classList.remove('active'));
              detailsPanel.querySelectorAll('.sub-tab-pane').forEach(p => p.classList.remove('active'));
              btn.classList.add('active');
              detailsPanel.querySelector(`#tab-${btn.dataset.tab}`).classList.add('active');
            });
          });

          // Load history
          loadSubHistory(sub.id);
        };

        const renderWorkList = (workTypes) => {
          let types = [];
          if (workTypes) {
            try {
              types = Array.isArray(workTypes) ? workTypes : JSON.parse(workTypes);
            } catch (e) { types = workTypes.split(',').map(t => t.trim()); }
          }
          if (types.length === 0) return '<div class="muted" style="font-size:12px;">Виды работ не указаны</div>';
          return types.map(t => `
            <div class="sub-work-list-item">
                <div class="sub-work-dot"></div>
                <span>${t}</span>
            </div>
          `).join('');
        };

        const loadSubHistory = async (subId) => {
          const historyPane = document.getElementById('tab-history');
          try {
            // Find lots where this sub was a winner
            const successfulLots = lots.filter(l => l.uploads.some(u => u._rawData?.subcontractorId === subId && (u.status === 'winner' || u.status === 'contract')));

            if (successfulLots.length === 0) {
              historyPane.innerHTML = '<div class="sub-empty-state">Успешных проектов пока нет</div>';
              return;
            }

            historyPane.innerHTML = successfulLots.map(l => `
                <div style="padding: 10px; border: 1px solid var(--gray-200); border-radius: 8px; margin-bottom: 8px; background: #fff;">
                    <div style="font-weight: 600; font-size: 13px; margin-bottom: 4px;">${l.title}</div>
                    <div style="display: flex; justify-content: space-between; font-size: 11px; color: var(--gray-600);">
                        <span>${l.objectName}</span>
                        <span style="color: var(--accent-green); font-weight: 600;">Выполнено</span>
                    </div>
                </div>
            `).join('');
          } catch (e) {
            historyPane.innerHTML = '<div class="muted">Ошибка загрузки истории</div>';
          }
        };

        renderSubs();

        searchInput.addEventListener("input", renderSubs);
        workFilter.addEventListener("change", renderSubs);

        confirmBtn.addEventListener('click', async () => {
          confirmBtn.disabled = true;
          confirmBtn.textContent = 'Обработка...';

          for (let subId of selectedSubs) {
            const sub = subs.find(s => s.id === subId);
            await addSubcontractorToLot(lotId, sub, true); // silent mode
          }

          await loadTenders();
          closeModal();
        });

      } catch (e) {
        console.error(e);
        const listContainer = document.getElementById("sub-modal-list");
        if (listContainer) listContainer.innerHTML = `<div style="color: red; padding: 16px; text-align: center;">Ошибка загрузки: ${e.message}</div>`;
      }
    }

    // Explicitly expose handlers to global scope for HTML onclick attributes if any (though we usually use addEventListener)
    // Checking renderLots to see how these are called. They are passed as onclick strings in some places or attached via JS.
    // If attached via JS, we need to update the attachment points.
    // If onclick attributes are used, we need to update them.
    // Let's check renderLots.

    function openLotWorksModal(lotId) {
      const lot = lots.find(l => String(l.id) === String(lotId));
      if (!lot) return;

      resetModalStructure();
      modalTitle.textContent = lot.title || `Лот ${lot.id}`;
      modalMeta.textContent = `${lot.id}${lot.objectName ? ' · ' + lot.objectName : ''}`;

      // Use stored items if available, otherwise look in uploads
      const items = (lot.items && lot.items.length) ? lot.items : (lot.uploads || []).flatMap(u => u.items || []);

      // Hierarchy: Block -> Estimate -> Stage -> [Items]
      const hierarchy = {};

      if (items.length) {
        items.forEach(it => {
          const b = it.blockName || 'Общее';
          const e = it.estimateName || 'Раздел';
          const s = it.stageName || it.section || 'Этап';

          if (!hierarchy[b]) hierarchy[b] = {};
          if (!hierarchy[b][e]) hierarchy[b][e] = {};
          if (!hierarchy[b][e][s]) hierarchy[b][e][s] = [];
          hierarchy[b][e][s].push({
            name: it.name || `${it.section || 'Работа'}`,
            volume: it.volume ?? it.qty ?? it.quantity ?? '—',
            unit: it.unit ?? it.uom ?? it.measure ?? '—',
            sum: parseFloat(it.totalCost) || 0
          });
        });
      }

      const bodyHtml = `
        <div class="works-modal">
          <div class="tree-grid-header">
            <span>Вид работ</span>
            <span>Объем</span>
            <span>Ед. изм.</span>
            <span>Сумма</span>
          </div>
          ${Object.entries(hierarchy).map(([block, estimates]) => `
            <details class="works-block-group" open>
              <summary>${block}</summary>
              <div class="works-block-content">
                ${Object.entries(estimates).map(([estimate, stages]) => `
                  <details class="works-estimate-group" open>
                    <summary>${estimate}</summary>
                    <div class="works-estimate-content">
                      ${Object.entries(stages).map(([stage, rows]) => `
                        <div class="works-stage-group">
                          <div class="works-stage-group-title">${stage}</div>
                          <div class="works-list">
                            ${rows.map(r => `
                              <div class="works-row">
                                <span class="works-name">${r.name}</span>
                                <span class="works-volume">${r.volume}</span>
                                <span class="works-unit">${r.unit}</span>
                                <span class="works-sum">${formatMoney(r.sum)}</span>
                              </div>
                            `).join('')}
                          </div>
                        </div>
                      `).join('')}
                    </div>
                  </details>
                `).join('')}
              </div>
            </details>
          `).join('')}
          ${Object.keys(hierarchy).length === 0 ? '<div style="padding:48px 24px; text-align:center; color:var(--gray-500); font-size:14px;">Состав работ не определен для данного лота</div>' : ''}
        </div>
      `;

      modalBody.innerHTML = bodyHtml;
      modal.style.display = "flex";
    }

    async function toggleBlockSubcontractor(lotId, uploadId) {
      const lot = lots.find(l => l.id === lotId);
      if (!lot) return;

      const upload = lot.uploads.find(u => u.uploadId === uploadId);
      if (!upload) return;

      // Get the real bid ID from the raw data
      const bidId = upload._rawData?.id;
      if (!bidId) {
        console.error('Cannot find bid ID for upload', uploadId);
        return;
      }

      try {
        if (upload.blocked) {
          // Unblock
          await apiToggleBidBlock(bidId, false, null);
          await loadTenders(); // Reload data
        } else {
          // Block - ask for reason
          let reason = null;
          if (window.parent && typeof window.parent.requestBlockReason === "function") {
            reason = await window.parent.requestBlockReason();
          } else {
            reason = prompt("Напишите причину блокировки:");
          }

          if (reason && reason.trim()) {
            await apiToggleBidBlock(bidId, true, reason.trim());
            await loadTenders(); // Reload data
          }
        }
      } catch (error) {
        console.error('Failed to toggle block:', error);
        alert('Ошибка при блокировке/разблокировке: ' + error.message);
      }
    }

    async function handleSelectWinner(lotId, uploadId) {
      try {
        await apiSelectWinner(uploadId); // API call
        await loadTenders(); // Reload data
      } catch (error) {
        console.error('Failed to select winner:', error);
        alert('Не удалось выбрать победителя: ' + error.message);
      }
    }

    async function handleCreateContract(lotId, uploadId) {
      try {
        await apiCreateContract(uploadId); // API call
        await loadTenders(); // Reload data
      } catch (error) {
        console.error('Failed to create contract:', error);
        alert('Не удалось создать договор: ' + error.message);
      }
    }

    async function handleCancelContract(lotId, uploadId) {
      try {
        await apiCancelContract(uploadId); // API call
        await loadTenders(); // Reload data
      } catch (error) {
        console.error('Failed to cancel contract:', error);
        alert('Не удалось отменить договор: ' + error.message);
      }
    }

    function viewContract(lotId, uploadId) {
      const lot = lots.find(l => l.id === lotId);
      if (!lot) return;
      const upload = lot.uploads.find(u => u.uploadId === uploadId);
      if (!upload || !upload.contractNumber) return;

      resetModalStructure();
      const inner = modal.querySelector('.modal');
      inner.classList.add('narrow');
      modalTitle.textContent = "Договор";
      modalMeta.textContent = `${upload.subcontractor} · ${lot.id}`;
      modalBody.innerHTML = `
            <div style="padding: 16px; background: var(--gray-50); border-radius: 8px;">
                <div style="margin-bottom: 12px;"><strong>№ договора:</strong> ${upload.contractNumber}</div>
                <div style="margin-bottom: 12px;"><strong>Субподрядчик:</strong> ${upload.subcontractor}</div>
                <div style="margin-bottom: 12px;"><strong>Сумма:</strong> ${formatMoney(upload.total)}</div>
                <div style="margin-bottom: 12px;"><strong>Срок выполнения:</strong> ${upload.completionDate}</div>
                <div style="color: var(--gray-600); font-size: 12px; margin-top: 16px;">Дата составления: ${new Date().toLocaleDateString('ru-RU')}</div>
            </div>
        `;
      modal.style.display = "flex";
    }

    // View document (certificate or license)
    function viewDoc(title, url) {
      console.log('viewDoc called with:', { title, url });
      if (!url) {
        console.log('URL is empty, returning');
        return;
      }

      resetModalStructure();
      const inner = modal.querySelector('.modal');
      inner.classList.add('narrow');
      modalTitle.textContent = title;
      modalMeta.textContent = '';

      // Determine if it's an image or PDF
      const isImage = /\.(jpg|jpeg|png|gif|webp|bmp)$/i.test(url);
      const isPdf = /\.pdf$/i.test(url);

      const fullUrl = url.startsWith('http') ? url : `http://localhost:3001${url}`;

      if (isImage) {
        modalBody.innerHTML = `
          <div style="text-align: center; padding: 16px;">
            <img src="${fullUrl}" alt="${title}" style="max-width: 100%; max-height: 70vh; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
          </div>
        `;
      } else if (isPdf) {
        modalBody.innerHTML = `
          <div style="padding: 16px;">
            <iframe src="${fullUrl}" style="width: 100%; height: 70vh; border: none; border-radius: 8px;"></iframe>
          </div>
        `;
      } else {
        // For PDF and other documents - use embed with fallback download button
        modalBody.innerHTML = `
          <div style="padding: 16px;">
            <embed src="${fullUrl}" type="application/pdf" style="width: 100%; height: 60vh; border: none; border-radius: 8px;">
            <div style="text-align: center; margin-top: 16px;">
              <a href="${fullUrl}" target="_blank" class="btn" style="background: var(--primary); color: white; padding: 10px 20px; border-radius: 8px; text-decoration: none; display: inline-flex; align-items: center; gap: 8px;">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                  <polyline points="7 10 12 15 17 10"/>
                  <line x1="12" y1="15" x2="12" y2="3"/>
                </svg>
                Открыть / Скачать
              </a>
            </div>
          </div>
        `;
      }

      modal.style.display = "flex";
    }

    function getPictorialChart(uploads) {
      if (!uploads || uploads.length === 0) return '';
      const invitedCount = uploads.length;
      const activeCount = uploads.filter(u => u.status !== 'invited').length;
      const maxIcons = 10;
      const displayTotal = Math.min(invitedCount, maxIcons);

      let iconsHtml = '';
      for (let i = 0; i < displayTotal; i++) {
        const isActive = i < activeCount;
        iconsHtml += `
          <div class="person-icon ${isActive ? 'active' : ''}" title="${isActive ? 'Вошел в систему' : 'Приглашен'}">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
          </div>
        `;
      }

      return `
        <div class="pictorial-chart" title="Участники: ${activeCount} вошли / ${invitedCount} приглашено">
          ${iconsHtml}
          <span style="font-size: 10px; color: var(--gray-500); margin-left: 2px; font-weight: 600;">${activeCount}/${invitedCount}</span>
        </div>
      `;
    }

    function shareOffer(lotId, uploadId) {
      const lot = lots.find(l => l.id === lotId);
      if (!lot) return;
      const upload = lot.uploads.find(u => u.uploadId === uploadId);
      if (!upload) return;

      const url = `${window.location.origin}${window.location.pathname}?lot=${encodeURIComponent(lotId)}&offer=${encodeURIComponent(uploadId)}`;

      resetModalStructure();
      const inner = modal.querySelector('.modal');
      inner.classList.add('narrow');
      modalTitle.textContent = "Поделиться предложением";
      modalMeta.textContent = `${upload.subcontractor} · ${lot.id}`;
      modalBody.innerHTML = `
            <div class="share-link-box">
                <label style="display: block; margin-bottom: 8px; font-size: 12px; color: var(--gray-700); font-weight: 600;">Ссылка на предложение:</label>
                <input type="text" class="share-link-input" value="${url}" readonly id="share-url-input">
                <button class="btn share-link-copy" id="copy-share-link">Скопировать ссылку</button>
            </div>
        `;
      modal.style.display = "flex";

      document.getElementById("copy-share-link").addEventListener("click", () => {
        const input = document.getElementById("share-url-input");
        input.select();
        input.setSelectionRange(0, 99999);
        navigator.clipboard.writeText(url).then(() => {
          const btn = document.getElementById("copy-share-link");
          const originalText = btn.textContent;
          btn.textContent = "Скопировано!";
          setTimeout(() => {
            btn.textContent = originalText;
          }, 2000);
        }).catch(err => {
          alert("Не удалось скопировать ссылку: " + err);
        });
      });
    }

    async function addSubcontractorToLot(lotId, sub, silent = false) {
      const lot = lots.find(l => l.id === lotId);
      if (!lot) {
        if (!silent) closeModal();
        return;
      }

      const tenderId = lot._rawData?.id;
      if (!tenderId) {
        if (!silent) {
          alert('Ошибка: не найден ID тендера');
          closeModal();
        }
        return;
      }

      const subName = sub.company || `${sub.firstName} ${sub.lastName}`;
      if (lot.uploads.some(u => u.subcontractor === subName)) {
        if (!silent) {
          alert(`Субподрядчик "${subName}" уже добавлен`);
          closeModal();
        }
        return;
      }

      try {
        await apiInviteSubcontractor(tenderId, sub.id);
        if (!silent) {
          await loadTenders();
          closeModal();
        }
      } catch (error) {
        console.error('Failed to invite subcontractor:', error);
        if (!silent) alert('Ошибка при добавлении: ' + error.message);
      }
    }

    async function deleteLot(lotId) {
      const lot = lots.find(l => l.id === lotId);
      if (!lot) return;

      const lotName = lot.title || `Лот ${lot.id}`;
      if (!confirm(`Вы уверены, что хотите удалить "${lotName}"?`)) {
        return;
      }

      // Get the real tender ID from the raw data
      const tenderId = lot._rawData?.id;
      if (!tenderId) {
        console.error('Cannot find tender ID for lot', lotId);
        alert('Ошибка: не найден ID тендера');
        return;
      }

      try {
        const response = await fetch(`/api/tenders/${tenderId}`, {
          method: 'DELETE',
          headers: {
            'Content-Type': 'application/json'
          }
        });

        if (!response.ok) {
          throw new Error('Failed to delete tender');
        }

        await loadTenders(); // Reload data
      } catch (error) {
        console.error('Failed to delete tender:', error);
        alert('Ошибка при удалении лота: ' + (error.message || 'Неизвестная ошибка'));
      }
    }

    function renderLots() {
      const container = document.getElementById("lot-list");
      const openLotIds = Array.from(container.querySelectorAll('details.lot-entry[open]')).map(d => d.getAttribute('data-lot-id'));
      const filtered = lots.filter(lot =>
        (lotFilter === "all" || lot.status === lotFilter) &&
        (objectFilter === null || lot.objectName === objectFilter)
      );
      container.innerHTML = filtered.map((lot) => {
        const filteredUploads = lot.uploads;
        const lotName = lot.title || 'Без названия';
        const startLabel = lot.startDate ? new Date(lot.startDate).toLocaleDateString() : '—';
        const endLabel = lot.deadline ? new Date(lot.deadline).toLocaleDateString() : '—';

        const blocksLabel = (lot.blocks && lot.blocks.length) ? lot.blocks.join(', ') : '—';
        const sectionsLabel = (lot.sections && lot.sections.length) ? lot.sections.join(', ') : '—';

        // Calculate lot total sum from items
        const lotSum = (lot.items || []).reduce((acc, it) => acc + (parseFloat(it.totalCost) || 0), 0);

        // Sorting Logic
        const sortedUploads = [...filteredUploads].sort((a, b) => {
          // Robust score extraction
          let scoreA = parseFloat(a.score);
          let scoreB = parseFloat(b.score);
          if (!Number.isFinite(scoreA)) scoreA = -Infinity;
          if (!Number.isFinite(scoreB)) scoreB = -Infinity;

          // Robust sum extraction
          let sumA = parseFloat(a.total);
          let sumB = parseFloat(b.total);
          if (!Number.isFinite(sumA)) sumA = Infinity;
          if (!Number.isFinite(sumB)) sumB = Infinity;

          if (offerSortMode === "score") {
            // Descending score (higher is better)
            return scoreB - scoreA;
          } else {
            // Ascending sum (cheaper is better)
            return sumA - sumB;
          }
        });

        const hasWinner = filteredUploads.some(up => up.status === 'winner');
        const hasContract = filteredUploads.some(up => up.status === 'contract');
        const uploadCards = sortedUploads.map((u) => {
          const fileUrl = (u.files && u.files[0]?.url) || '#';
          const scoreVal = Number.isFinite(u.score) ? u.score : 0;
          const sumLabel = formatMoney(u.total);
          const blockedBanner = u.blocked && u.blockReason ? `<div class="block-reason-banner" style="margin-top:4px;">Заблокировано: ${new Date(u.blockDate).toLocaleString('ru-RU')}<div class="block-banner-inline">${u.blockReason}</div></div>` : '';
          const isWinner = u.status === 'winner';
          const hasOwnContract = u.status === 'contract';
          const cardClass = u.blocked ? 'is-blocked' : ((hasWinner && !isWinner) || (hasContract && !hasOwnContract) ? 'non-winner' : '');

          // View contract button if contract exists
          const viewContractBtn = u.contractNumber ? `
            <button class="share-btn" data-upload-id="${u.uploadId}" data-lot-id="${lot.id}" data-action="view-contract" title="Просмотр договора">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
            </button>
          ` : '';

          return `
            <div class="offer-card ${cardClass}" data-offer-id="${u.uploadId}" data-lot-id="${lot.id}">
              <div class="offer-header">
                <div class="offer-title-box">
                  <div class="offer-title">${u.subcontractor}</div>
                  <div class="offer-code-badge" onclick="copyToClipboard('${u.inviteCode}', this)" title="Нажмите, чтобы скопировать">
                    Код: ${u.inviteCode || '—'}
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-left: 4px; opacity: 0.6;"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                  </div>
                </div>
                <div class="offer-header-actions">
                  ${viewContractBtn}
                  <button class="block-btn ${u.blocked ? 'blocked' : ''}" data-upload-id="${u.uploadId}" data-lot-id="${lot.id}" title="${u.blocked ? 'Разблокировать' : 'Заблокировать'}" ${u.status === 'invited' ? 'disabled style="opacity:0.3; cursor:not-allowed;"' : ''}>
                    ${u.blocked ?
              '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="5" y="11" width="14" height="10" rx="2" /><path d="M7 11V7a5 5 0 0 1 9.9-1" /></svg>' :
              '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="5" y="11" width="14" height="10" rx="2" /><path d="M7 11V7a5 5 0 0 1 10 0v4" /></svg>'
            }
                  </button>
                </div>
              </div>
              ${blockedBanner}
              <div class="offer-status">${statusStepper(u.status)}</div>
              <div class="offer-row"><span class="offer-label">Срок</span><span>${u.completionDate || "—"}</span></div>
              <div class="offer-row"><span class="offer-label">Сумма</span><span class="offer-sum">${sumLabel}</span></div>
              <div class="offer-row" style="margin: 4px 0;">
                <span class="offer-label">Документы</span>
                <div style="display:flex; gap:8px; align-items:center;">
                  <div class="doc-icon-btn ${u.certificatePhoto ? 'active' : ''}" 
                       onclick="event.stopPropagation(); ${u.certificatePhoto ? `viewDoc('Сертификат (Гувохнома)', '${u.certificatePhoto}')` : ''}" 
                       title="${u.certificatePhoto ? 'Просмотреть Сертификат' : 'Сертификат не загружен'}">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
                    <span style="font-size: 10px; margin-left: 4px;">Сертификат</span>
                  </div>
                  <div class="doc-icon-btn ${u.licensePhoto ? 'active' : ''}" 
                       onclick="event.stopPropagation(); ${u.licensePhoto ? `viewDoc('Лицензия', '${u.licensePhoto}')` : ''}" 
                       title="${u.licensePhoto ? 'Просмотреть Лицензию' : 'Лицензия не загружена'}">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg>
                    <span style="font-size: 10px; margin-left: 4px;">Лицензия</span>
                  </div>
                </div>
              </div>
              <div class="offer-row">
                <span class="offer-label">Баллы</span>
                <div class="progress-wrap">
                  <div class="rating-cubes">
                    ${Array.from({ length: 10 }, (_, i) => `<div class="rating-cube ${(u.score || 0) > i ? 'active' : ''}"></div>`).join('')}
                  </div>
                  <span class="progress-value">${u.score ?? '—'}</span>
                </div>
              </div>
              <div class="offer-row"><span class="offer-label">№ договора</span><span>${u.contractNumber || '—'}</span></div>
              <div class="offer-row">
                <span class="offer-label">Рейтинг (mc.uz)</span>
                <div style="display:flex; align-items:center; gap:6px;">
                  <span class="tag" style="background: ${u.rating ? 'var(--primary-lighter)' : 'var(--gray-100)'}; color: ${u.rating ? 'var(--primary)' : 'var(--gray-500)'}; font-weight: 700; padding: 2px 8px;">
                    ${u.rating || '—'}
                  </span>
                  <button class="btn-refresh-rating" data-sub-id="${u.subcontractorId || (u._rawData?.subcontractor?.id)}" data-inn="${u.inn || (u._rawData?.subcontractor?.inn)}" title="Обновить рейтинг" style="background:transparent; border:none; padding:0; cursor:pointer; color:var(--primary); display:flex; align-items:center;">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 4v6h-6"></path><path d="M1 20v-6h6"></path><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>
                  </button>
                </div>
              </div>
              <div class="offer-actions">
                <button class="btn secondary btn-view-file" data-url="${fileUrl}" ${u.status === 'invited' ? 'disabled style="opacity:0.5;"' : ''}>Просмотр файла</button>
                <button class="btn ${hasOwnContract ? 'secondary' : ''} btn-select-winner" data-upload-id="${u.uploadId}" data-lot-id="${lot.id}" ${(hasContract && !hasOwnContract) || u.status === 'invited' ? 'disabled' : ''} style="${hasOwnContract ? 'background: #FFE5E5; color: #d32f2f; border-color: #FFCCCC;' : ''}">${hasOwnContract ? 'Отменить договор' : (isWinner ? 'Составить договор' : 'Выбрать')}</button>
              </div>
            </div>
          `;
        }).join("");

        const inviteCard = `
          <div class="offer-card invite-card" data-lot-id="${lot.id}" role="button" tabindex="0" aria-label="Пригласить субподрядчика">
            <span class="invite-cta">Пригласить</span>
          </div>
        `;

        const uploadsContent = `${uploadCards}${inviteCard}`;

        const isOpen = openLotIds.includes(String(lot.id));
        return `
          <details class="lot-entry" data-lot-id="${lot.id}" ${isOpen ? 'open' : ''}>
            <summary>
              <div class="lot-summary-left">
                <div class="lot-icon" aria-hidden="true">
                  ${lotIconSvg}
                </div>
                <div class="lot-lines">
                   <div class="lot-line">
                    ${statusBadge(lot.status)}
                    <button class="lot-share-btn" data-lot-id="${lot._rawData?.id}" title="Поделиться лотом" onclick="event.stopPropagation(); shareLot('${lot._rawData?.id}')">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><path d="m8.59 13.51 6.83 3.98"/><path d="m15.41 6.51-6.82 3.98"/></svg>
                    </button>
                    <span class="lot-id">${lot.id}</span>
                    <span class="lot-title">${lotName}</span>
                  </div>
                   <div class="lot-line">
                    ${(lot.items && lot.items.length > 0) ? `<span class="lot-meta-chip sum-chip" title="Общая сумма по смете"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12V7H5a2 2 0 0 1 0-4h14v4"/><path d="M3 5v14a2 2 0 0 0 2 2h16v-5"/><path d="M18 12a2 2 0 0 0 0 4h4v-4Z"/></svg>${formatMoney(lotSum)}</span>` : ''}
                    <span class="lot-meta-chip">Срок: ${startLabel} — ${endLabel}</span>
                  </div>
                  <div class="lot-line">
                    <span class="lot-meta-chip">Секции: ${blocksLabel}</span>
                    <span class="lot-meta-chip">Раздел: ${sectionsLabel}</span>
                    <a href="#" class="lot-view-link" data-lot-id="${lot.id}">Просмотр</a>
                  </div>
                </div>
              </div>
              <div class="lot-summary-right">
                <div style="display: flex; align-items: flex-start; gap: 8px;">
                  <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 4px;">
                    ${countdownMarkup(lot.deadline)}
                    ${getPictorialChart(lot.uploads)}
                  </div>
                  <button class="delete-lot-btn" data-lot-id="${lot.id}" title="Удалить лот" onclick="event.stopPropagation();" style="margin-top: 2px;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <line x1="18" y1="6" x2="6" y2="18"></line>
                      <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                  </button>
                </div>
              </div>
            </summary>
            <div class="offers-toolbar">
              <div class="sort-switch" role="group" aria-label="Сортировка предложений">
                <button type="button" class="sort-btn ${offerSortMode === 'score' ? 'active' : ''}" data-sort="score">По баллам</button>
                <button type="button" class="sort-btn ${offerSortMode === 'sum' ? 'active' : ''}" data-sort="sum">По сумме</button>
              </div>
            </div>
            <div class="offers-grid">
              ${uploadsContent}
            </div>
          </details>
        `;
      }).join("");

      // Add event listeners for block buttons
      container.querySelectorAll(".block-btn").forEach(btn => {
        btn.addEventListener("click", (e) => {
          e.stopPropagation();
          const uploadId = btn.getAttribute("data-upload-id");
          const lotId = btn.getAttribute("data-lot-id");
          toggleBlockSubcontractor(lotId, uploadId);
        });
      });

      // Add event listeners for share buttons
      container.querySelectorAll(".share-btn").forEach(btn => {
        btn.addEventListener("click", (e) => {
          e.stopPropagation();
          const uploadId = btn.getAttribute("data-upload-id");
          const lotId = btn.getAttribute("data-lot-id");
          shareOffer(lotId, uploadId);
        });
      });

      // View file buttons
      container.querySelectorAll('.btn-view-file').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const url = btn.getAttribute('data-url');
          if (url && url !== '#') window.open(url, '_blank');
          else alert('Файл не прикреплен');
        });
      });

      // Sort buttons
      container.querySelectorAll('.sort-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          const mode = btn.dataset.sort;
          if (mode && mode !== offerSortMode) {
            offerSortMode = mode;
            renderLots();
          }
        });
      });

      // View works link
      container.querySelectorAll('.lot-view-link').forEach(link => {
        link.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          const lotId = link.getAttribute('data-lot-id');
          openLotWorksModal(lotId);
        });
      });

      // initial countdown update
      updateCountdowns();

      // Invite card click
      container.querySelectorAll(".invite-card").forEach(card => {
        const open = () => {
          const lotId = card.getAttribute("data-lot-id");
          if (lotId) openAddSubModal(lotId);
        };
        card.addEventListener("click", (e) => {
          e.stopPropagation();
          open();
        });
        card.addEventListener("keydown", (e) => {
          if (e.key === "Enter" || e.key === " ") {
            e.preventDefault();
            open();
          }
        });
      });

      // Select winner button
      container.querySelectorAll(".btn-select-winner").forEach(btn => {
        btn.addEventListener("click", (e) => {
          e.stopPropagation();
          const uploadId = btn.getAttribute("data-upload-id");
          const lotId = btn.getAttribute("data-lot-id");

          // Find the upload to check its status
          const lot = lots.find(l => l.id === lotId);
          if (!lot) return;
          const upload = lot.uploads.find(u => u.uploadId === uploadId);
          if (!upload) return;

          if (upload.status === 'contract') {
            handleCancelContract(lotId, uploadId);
          } else if (upload.status === 'winner') {
            handleCreateContract(lotId, uploadId);
          } else {
            handleSelectWinner(lotId, uploadId);
          }
        });
      });

      // View contract button (dynamic content, need delegation or re-attach)
      // Since innerHTML wipes logic, we re-attach here.
      // But above we attached to .share-btn which handles 'view-contract' action if not separate.
      // Actually we have a separate viewContractBtn HTML.
      // Let's add listener for it.
      container.querySelectorAll('button[data-action="view-contract"]').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const lotId = btn.getAttribute("data-lot-id");
          const uploadId = btn.getAttribute("data-upload-id");
          // Assuming viewContract is just a modal or similar?
          // We have viewContract function in script, let's verify if it needs renaming.
          // It was not in the original renaming list, but let's check.
          viewContract(lotId, uploadId);
        });
      });

      // View contract button
      container.querySelectorAll(".share-btn[data-action='view-contract']").forEach(btn => {
        btn.addEventListener("click", (e) => {
          e.stopPropagation();
          const uploadId = btn.getAttribute("data-upload-id");
          const lotId = btn.getAttribute("data-lot-id");
          viewContract(lotId, uploadId);
        });
      });

      container.querySelectorAll("button[data-open]").forEach(btn => {
        // ... (removed old modal logic listeners if any remain, but I replaced the whole block so it's fine)
      });

      // Delete lot buttons
      container.querySelectorAll(".delete-lot-btn").forEach(btn => {
        btn.addEventListener("click", async (e) => {
          e.stopPropagation();
          e.preventDefault();
          const lotId = btn.getAttribute("data-lot-id");
          if (lotId) await deleteLot(lotId);
        });
      });

      // Refresh rating buttons
      container.querySelectorAll(".btn-refresh-rating").forEach(btn => {
        btn.addEventListener("click", async (e) => {
          e.stopPropagation();
          const subId = btn.getAttribute("data-sub-id");
          const inn = btn.getAttribute("data-inn");
          if (!subId) return;

          btn.style.animation = "spin 1s linear infinite";
          try {
            await refreshSubcontractorRating(subId, inn);
          } finally {
            btn.style.animation = "";
          }
        });
      });
    }

    function viewDoc(title, src) {
      if (!src) return;
      const overlay = document.createElement('div');
      overlay.style.position = 'fixed';
      overlay.style.top = '0';
      overlay.style.left = '0';
      overlay.style.width = '100%';
      overlay.style.height = '100%';
      overlay.style.background = 'rgba(0,0,0,0.9)';
      overlay.style.zIndex = '10000';
      overlay.style.display = 'flex';
      overlay.style.flexDirection = 'column';
      overlay.style.alignItems = 'center';
      overlay.style.justifyContent = 'center';
      overlay.style.padding = '40px';
      overlay.style.backdropFilter = 'blur(5px)';
      overlay.innerHTML = `
        <div style="position:absolute; top:20px; right:30px; color:#fff; font-size:40px; cursor:pointer; line-height:1;" onclick="this.parentElement.remove()">&times;</div>
        <div style="color:#fff; margin-bottom:20px; font-weight:600; font-size:20px; text-shadow: 0 2px 4px rgba(0,0,0,0.5);">${title}</div>
        <img src="${src}" style="max-width:95%; max-height:85vh; border-radius:12px; box-shadow:0 20px 50px rgba(0,0,0,0.8); object-fit:contain; border: 1px solid rgba(255,255,255,0.1);">
      `;
      document.body.appendChild(overlay);
    }
    window.viewDoc = viewDoc;

    async function refreshSubcontractorRating(subId, inn) {
      if (!inn) {
        alert("У субподрядчика не указан ИНН");
        return;
      }
      try {
        const response = await fetch(`${API_BASE_URL}/subcontractors/${subId}/refresh-rating`, {
          method: 'POST'
        });

        if (!response.ok) {
          const text = await response.text();
          let errorMsg = `Ошибка сервера (${response.status})`;
          try {
            const json = JSON.parse(text);
            errorMsg = json.error || errorMsg;
          } catch (e) {
            // If not JSON, use the status text or HTML content hint
            if (text.includes('Cannot POST')) errorMsg = "Маршрут не найден на сервере (404). Возможно, требуется перезагрузка бэкенда.";
          }
          throw new Error(errorMsg);
        }

        const result = await response.json();
        if (result.error) throw new Error(result.error);

        // Refresh local data and re-render
        await loadTenders();
        alert('Рейтинг успешно обновлен: ' + (result.rating || '—'));
      } catch (error) {
        console.error('Failed to refresh rating:', error);
        alert('Ошибка при обновлении рейтинга: ' + error.message);
      }
    }

    document.querySelectorAll(".chip[data-filter]").forEach(chip => {
      chip.addEventListener("click", () => {
        document.querySelectorAll(".chip[data-filter]").forEach(c => c.classList.remove("active"));
        chip.classList.add("active");
        lotFilter = chip.getAttribute("data-filter");
        renderLots();
      });
    });

    // Expose functions to parent window
    window.refreshMockData = () => {
      alert("Моки обновлены (ничего не меняется, демо)");
    };

    // API Bridge
    window.probimApi = {
      getBlocks: async () => [],
      getEstimates: async (blockId) => [],
      getSections: async (estimateId) => [],
      getStages: async (sectionId) => [],
      getWorkTypes: async (stageId) => []
    };

    window.initApi = (apiImpl) => {
      window.probimApi = apiImpl;
      console.log("Tender API initialized");
    };

    window.createNewLot = async () => {
      const innerModal = modal.querySelector('.modal');
      const today = new Date().toISOString().split('T')[0];

      // New Layout Structure
      innerModal.innerHTML = `
        <div class="row" style="justify-content: space-between; align-items: center; padding-bottom: 12px; border-bottom: 1px solid var(--gray-200); margin-bottom: 12px;">
          <div style="display:flex; flex-direction:column; gap:4px;">
            <h3 style="margin:0;">Добавление нового лота</h3>
            <div id="new-lot-total-sum" style="font-weight: 700; font-size: 14px; color: var(--primary);">Итого: 0 ${PROJECT_CURRENCY === 'UZS' ? 'сўм' : '$'}</div>
          </div>
          <div style="display:flex; gap:12px; align-items:center;">
            <input type="date" id="new-lot-deadline" value="${today}" min="${today}" style="padding:6px 10px; border:1px solid var(--gray-300); border-radius:6px; width: 140px; font-family:inherit; font-size:13px;">
            <button class="btn" id="btn-create-lot-save">Сохранить</button>
            <button class="btn secondary" id="btn-create-lot-close">Закрыть</button>
          </div>
        </div>
        <div style="display:flex; flex-wrap:wrap; gap:8px; align-items:center; margin-bottom:12px;">
          <label for="new-lot-name" style="font-size:13px; color:var(--gray-700); min-width:120px;">Название лота <span style="color:red;">*</span></label>
          <input type="text" id="new-lot-name" placeholder="Например: Секция 2 - ОВ" style="flex:1; min-width:220px; padding:6px 10px; border:1px solid var(--gray-300); border-radius:6px; font-family:inherit; font-size:13px;">
        </div>
        <div class="meta" style="margin-bottom:12px; color:var(--gray-600); font-size:12px;">${objectFilter || "Выберите параметры лота"}</div>
        
        <style>
            .modal-content-wrapper { display: flex; flex-direction: column; height: 70vh; gap: 16px; }
            .modal-grid-3 { display: grid; grid-template-columns: 300px 300px 1fr; gap: 16px; flex: 1; min-height: 0; }
            .col-panel { 
                display: flex; flex-direction: column; 
                border: 1px solid var(--gray-300); 
                border-radius: 8px; 
                background: var(--gray-50);
                overflow: hidden;
            }
            .col-header {
              padding: 12px;
              background: #fff;
              border-bottom: 1px solid var(--gray-200);
              font-weight: 600;
              color: var(--gray-800);
              font-size: 14px;
            }
            .col-content {
                padding: 0;
                overflow-y: auto;
                flex: 1;
            }
            /* Custom Scrollbar */
            .col-content::-webkit-scrollbar { width: 6px; }
            .col-content::-webkit-scrollbar-track { background: transparent; }
            .col-content::-webkit-scrollbar-thumb { background-color: var(--gray-300); border-radius: 3px; }
            .col-content::-webkit-scrollbar-thumb:hover { background-color: var(--gray-400); }

            .nav-item { padding: 8px 12px; cursor: pointer; border-bottom: 1px solid var(--gray-200); font-size: 12px; color: var(--gray-700); transition: background 0.1s; }
            .nav-item:hover { background: var(--gray-100); color: var(--gray-900); }
            .nav-item.active { background: var(--primary-lighter); color: var(--primary); font-weight: 500; }
            .nav-item.disabled { opacity: 0.5; cursor: not-allowed !important; background: var(--gray-50); color: var(--gray-400); pointer-events: none; }

            .tree-grid-header { position: sticky; top: 0; z-index: 3; display: grid; grid-template-columns: 1fr 60px 50px 100px; column-gap: 8px; padding: 8px 12px; background: var(--gray-50); border-bottom: 1px solid var(--gray-200); font-size: 11px; text-transform: uppercase; letter-spacing: 0.3px; color: var(--gray-500); }
            .tree-stage { padding: 0 12px; }
            .tree-stage-header { display: flex; align-items: center; gap: 8px; padding: 8px 0; position: sticky; top: 36px; background: var(--gray-50); z-index: 2; font-size: 12px; }
            .tree-stage-header strong { font-weight: 600; color: var(--gray-900); font-size: 12px; }
            .tree-wt-list { margin-left: 12px; display: flex; flex-direction: column; }
            .tree-wt-row { display: grid; grid-template-columns: 1fr 60px 50px 100px; align-items: center; column-gap: 8px; padding: 6px 8px; border: 1px solid var(--gray-200); background: #fff; font-size: 12px; color: var(--gray-700); }
            .tree-wt-row + .tree-wt-row { margin-top: 4px; }
            .tree-wt-item { display: flex; align-items: center; gap: 8px; font-size: 12px; color: inherit; cursor: pointer; }
            .tree-wt-item:hover { color: var(--gray-900); }
            .tree-wt-volume, .tree-wt-unit { font-size: 12px; color: var(--gray-700); }
            .wt-name { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
            
            .tree-wt-row.disabled { opacity: 0.5; background: var(--gray-50); cursor: not-allowed; }
            .tree-wt-row.disabled label { cursor: not-allowed; }
            .tree-wt-row.disabled .wt-badge { 
              font-size: 10px; color: var(--accent-orange); background: #fff8f0; 
              padding: 2px 6px; border-radius: 4px; border: 1px solid rgba(202, 80, 16, 0.1);
              margin-left: auto; white-space: nowrap;
            }
            
            input[type="checkbox"] { accent-color: #2B7A78; width: 16px; height: 16px; }
            input[type="checkbox"]:disabled { cursor: not-allowed; }
        </style>

        <div class="modal-content-wrapper" id="lot-creation-body">
            <div style="display:flex; align-items:center; justify-content:center; height:100%; color:var(--gray-500);">Загрузка данных...</div>
        </div>
      `;

      modal.style.display = "flex";

      // Bind Header Events
      document.getElementById('btn-create-lot-close').addEventListener('click', closeModal);

      // State
      let blocksData = [];
      let activeBlockId = null;
      let activeEstimateId = null;

      // Selection State: Map<wtId, { wtName, stageId, stageName, estimateId, estimateName, blockId, blockName }>
      const selectedWorkTypes = new Map();

      // Collect all work type IDs already used in existing tenders
      const usedWorkTypeIds = new Set();
      lots.forEach(lot => {
        (lot.items || []).forEach(it => {
          if (it.workTypeId) usedWorkTypeIds.add(it.workTypeId);
        });
      });

      // Elements
      const bodyContainer = document.getElementById('lot-creation-body');

      try {
        blocksData = await window.probimApi.getBlocks();
        renderLayout();
      } catch (e) {
        bodyContainer.innerHTML = `<div style="color:red; text-align:center;">Ошибка: ${e.message}</div>`;
      }

      function renderLayout() {
        bodyContainer.innerHTML = `
            <div class="modal-grid-3">
                <!-- Column 1: Blocks -->
                <div class="col-panel">
                    <div class="col-header">1. Блоки (Секции)</div>
                    <div class="col-content" id="col-blocks"></div>
                </div>

                <!-- Column 2: Estimates -->
                <div class="col-panel">
                    <div class="col-header">2. Разделы смет</div>
                    <div class="col-content" id="col-estimates">
                        <div class="muted" style="padding:12px; text-align:center;">Выберите блок</div>
                    </div>
                </div>

                <!-- Column 3: Tree -->
                <div class="col-panel">
                    <div class="col-header" id="col-tree-header">3. Состав работ</div>
                    <div class="col-content" id="col-tree">
                        <div class="muted" style="padding:12px; text-align:center;">Выберите разрез сметы</div>
                    </div>
                </div>
            </div>
          `;
        renderBlocksList();
      }

      function renderBlocksList() {
        const container = document.getElementById('col-blocks');
        container.innerHTML = blocksData.map(b => `
              <div class="nav-item ${b.id === activeBlockId ? 'active' : ''}" data-id="${b.id}">
                  ${b.name}
              </div>
          `).join('');

        container.querySelectorAll('.nav-item').forEach(el => {
          el.addEventListener('click', () => selectBlock(el.dataset.id));
        });
      }

      async function selectBlock(id) {
        if (activeBlockId === id) return;
        activeBlockId = id;
        activeEstimateId = null;

        renderBlocksList(); // Update active state

        const estContainer = document.getElementById('col-estimates');
        estContainer.innerHTML = '<div class="muted" style="padding:12px; text-align:center;">Загрузка...</div>';
        document.getElementById('col-tree-header').textContent = "3. Состав работ";
        document.getElementById('col-tree').innerHTML = '<div class="muted" style="padding:12px; text-align:center;">Выберите разрез сметы</div>';

        try {
          const estimates = await window.probimApi.getEstimates(id);
          renderEstimatesList(estimates);
        } catch (e) {
          estContainer.innerHTML = '<div style="color:red; padding:12px;">Ошибка загрузки смет</div>';
        }
      }

      function renderEstimatesList(estimates) {
        const container = document.getElementById('col-estimates');
        if (estimates.length === 0) {
          container.innerHTML = '<div class="muted" style="padding:12px; text-align:center;">Нет разделов</div>';
          return;
        }

        // Sort alphabetically by name
        const sorted = [...estimates].sort((a, b) => (a.name || "").localeCompare(b.name || ""));

        container.innerHTML = sorted.map(e => {
          // If the backend provides section count, we can use it as a basic check
          const isEmpty = e._count && e._count.sections === 0;
          return `
              <div class="nav-item ${e.id === activeEstimateId ? 'active' : ''} ${isEmpty ? 'disabled' : ''}" 
                   data-id="${e.id}" data-name="${e.name}"
                   ${isEmpty ? 'title="Раздел не содержит данных"' : ''}>
                  ${e.name}
              </div>
          `;
        }).join('');

        container.querySelectorAll('.nav-item').forEach(el => {
          if (!el.classList.contains('disabled')) {
            el.addEventListener('click', () => selectEstimate(el.dataset.id, el.dataset.name));
          }
        });
      }

      async function selectEstimate(id, name) {
        if (activeEstimateId === id) return;
        activeEstimateId = id;

        // Update active class in estimates list
        const estContainer = document.getElementById('col-estimates');
        estContainer.querySelectorAll('.nav-item').forEach(el => {
          if (el.dataset.id === id) el.classList.add('active');
          else el.classList.remove('active');
        });

        const treeContainer = document.getElementById('col-tree');
        treeContainer.innerHTML = '<div class="muted" style="padding:12px; text-align:center;">Загрузка этапов...</div>';

        try {
          // Fetch Tree Data
          const sections = await window.probimApi.getSections(id);
          // Flatten stages from all sections
          let allStages = [];
          for (const sec of sections) {
            const stages = await window.probimApi.getStages(sec.id);
            allStages = allStages.concat(stages);
          }

          if (allStages.length === 0) {
            treeContainer.innerHTML = '<div class="muted" style="padding:12px; text-align:center;">Нет этапов</div>';
            return;
          }

          // Fetch Work Types for all stages
          const stagesWithWt = await Promise.all(allStages.map(async (stage) => {
            const wts = await window.probimApi.getWorkTypes(stage.id);
            return { ...stage, wts };
          }));

          renderTree(stagesWithWt, id, name);

        } catch (e) {
          console.error(e);
          treeContainer.innerHTML = '<div style="color:red; padding:12px;">Ошибка загрузки дерева</div>';
        }
      }

      function renderTree(stages, estimateId, estimateName) {
        const container = document.getElementById('col-tree');
        const header = document.getElementById('col-tree-header');
        const blockName = blocksData.find(b => b.id == activeBlockId)?.name;

        if (header && estimateName) {
          header.textContent = `3. Состав работ раздела ${estimateName}`;
        }

        let html = '<div class="tree-grid-header"><span>Вид работ</span><span>Объем</span><span>Ед. изм.</span><span>Сумма</span></div>';
        stages.forEach(stage => {
          if (!stage.wts || stage.wts.length === 0) return;

          const wtItems = stage.wts.map(wt => {
            const isChecked = selectedWorkTypes.has(wt.id);
            const isUsed = usedWorkTypeIds.has(wt.id);
            const volume = wt.volume ?? wt.qty ?? wt.quantity ?? '—';
            const unit = wt.unit ?? wt.uom ?? wt.measure ?? '—';

            const itemTotalCost = wt.totalCost || (parseFloat(wt.quantity || 0) * parseFloat(wt.unitCost || 0)) || 0;

            return `
                    <div class="tree-wt-row ${isUsed ? 'disabled' : ''}">
                      <label class="tree-wt-item">
                        <input type="checkbox" class="wt-cb" 
                          value="${wt.id}" 
                          ${isChecked ? 'checked' : ''}
                          ${isUsed ? 'disabled' : ''}
                          data-name="${wt.name}"
                          data-stage-id="${stage.id}"
                          data-stage-name="${stage.name}"
                          data-unit="${unit}"
                          data-volume="${volume}"
                          data-unit-cost="${wt.unitCost || 0}"
                          data-total-cost="${itemTotalCost}"
                        >
                        <span class="wt-name" title="${wt.name}">${wt.name}</span>
                        ${isUsed ? '<span class="wt-badge">В другом лоте</span>' : ''}
                      </label>
                      <span class="tree-wt-volume">${volume}</span>
                      <span class="tree-wt-unit">${unit}</span>
                      <span class="tree-wt-sum" style="text-align:right; font-weight:600; color:var(--primary);">${formatMoney(itemTotalCost)}</span>
                    </div>
                  `;
          }).join('');

          const isAllUsed = stage.wts.every(wt => usedWorkTypeIds.has(wt.id));

          html += `
                  <div class="tree-stage">
                      <div class="tree-stage-header">
                          <input type="checkbox" class="stage-cb" data-stage-id="${stage.id}" ${isAllUsed ? 'disabled' : ''}>
                          <strong ${isAllUsed ? 'style="opacity:0.5;"' : ''}>${stage.name}</strong>
                      </div>
                          <div class="tree-wt-list" id="wt-list-${stage.id}">
                            ${wtItems}
                          </div>
                  </div>
              `;
        });

        container.innerHTML = html || '<div class="muted" style="padding:12px; text-align:center;">Нет видов работ</div>';

        // Bind Events
        bindTreeEvents(container, estimateId, estimateName, blockName);
        updateStageCheckboxes(container);
      }

      function bindTreeEvents(container, estimateId, estimateName, blockName) {
        const handleWorkTypeChange = (cb, notifyStage = true) => {
          const wtId = cb.value;
          if (cb.checked) {
            selectedWorkTypes.set(wtId, {
              id: wtId,
              name: cb.dataset.name,
              stageId: cb.dataset.stageId,
              stageName: cb.dataset.stageName,
              estimateId: estimateId,
              estimateName: estimateName,
              blockId: activeBlockId,
              blockName: blockName,
              unit: cb.dataset.unit,
              volume: cb.dataset.volume,
              unitCost: cb.dataset.unitCost,
              totalCost: cb.dataset.totalCost
            });
          } else {
            selectedWorkTypes.delete(wtId);
          }
          if (notifyStage) {
            updateStageCheckboxes(container);
          }
        };

        container.querySelectorAll('.wt-cb').forEach(cb => {
          cb.addEventListener('change', () => {
            handleWorkTypeChange(cb);
            updateSelectedTotal();
          });
        });

        container.querySelectorAll('.stage-cb').forEach(stageCb => {
          stageCb.addEventListener('change', () => {
            const stageRow = stageCb.closest('.tree-stage');
            if (!stageRow) return;
            const wtList = stageRow.querySelector('.tree-wt-list');
            if (!wtList) return;

            const stageChecked = stageCb.checked;
            wtList.querySelectorAll('.wt-cb:not(:disabled)').forEach(wtCb => {
              if (wtCb.checked !== stageChecked) {
                wtCb.checked = stageChecked;
                handleWorkTypeChange(wtCb, false);
              }
            });

            updateStageCheckboxes(container);
            updateSelectedTotal();
          });
        });
      }

      function updateSelectedTotal() {
        const sumDisplay = document.getElementById('new-lot-total-sum');
        if (!sumDisplay) return;

        let total = 0;
        selectedWorkTypes.forEach(wt => {
          total += parseFloat(wt.totalCost) || 0;
        });

        sumDisplay.textContent = `Итого: ${formatMoney(total)}`;
      }

      function updateStageCheckboxes(container) {
        container.querySelectorAll('.tree-wt-list').forEach(list => {
          const stageId = list.id.replace('wt-list-', '');
          const stageCb = container.querySelector(`.stage-cb[data-stage-id="${stageId}"]`);
          if (!stageCb) return;

          const all = list.querySelectorAll('.wt-cb:not(:disabled)');
          const checked = list.querySelectorAll('.wt-cb:not(:disabled):checked');

          if (all.length === 0) {
            // If all are disabled, the state depends on nothing (already handled by disabling stageCb)
            return;
          }

          stageCb.checked = (all.length === checked.length);
          stageCb.indeterminate = (checked.length > 0 && checked.length < all.length);
        });
      }

      // Save Handler
      document.getElementById('btn-create-lot-save').addEventListener('click', async () => {
        if (selectedWorkTypes.size === 0) {
          alert("Выберите хотя бы один вид работ");
          return;
        }

        const deadline = document.getElementById("new-lot-deadline").value;
        const manualTitle = document.getElementById("new-lot-name").value.trim();

        if (!manualTitle) {
          alert("Введите название лота");
          document.getElementById("new-lot-name").focus();
          return;
        }

        // Generate Title & Description
        // Group by Block -> Estimate -> Stage
        const items = Array.from(selectedWorkTypes.values());

        // Simple title generation
        const uniqueBlocks = [...new Set(items.map(i => i.blockName))];
        const uniqueStages = [...new Set(items.map(i => i.stageName))];

        const autoTitle = `${uniqueStages[0]}${uniqueStages.length > 1 ? ' и др.' : ''} (${uniqueBlocks.join(', ')})`;
        const finalTitle = manualTitle || autoTitle;
        let description = items.map(i => i.name).join(', ');
        if (description.length > 100) description = description.substring(0, 100) + '...';

        try {
          // Prepare items for backend
          const itemsPayload = items.map(i => ({
            workTypeId: i.id, // Save the original ID for tracking
            blockName: i.blockName,
            estimateName: i.estimateName,
            stageName: i.stageName,
            section: i.stageName, // Keep for backward compatibility
            name: i.name,
            unit: i.unit || "ед.", // Use selected unit
            quantity: parseFloat(i.volume) || 1, // Use selected volume/quantity
            volume: i.volume || "—",
            totalCost: parseFloat(i.totalCost) || 0,
            unitCost: parseFloat(i.unitCost) || 0
          }));

          // Call API to create tender
          await apiCreateTender({
            projectId: CURRENT_PROJECT_ID,
            name: finalTitle,
            description: description,
            startDate: new Date().toISOString(),
            deadline: deadline,
            blockIds: uniqueBlocks,
            sectionIds: [],
            items: itemsPayload // Send items to backend
          });

          closeModal();
          await loadTenders(); // Reload from server
        } catch (error) {
          console.error('Failed to create tender:', error);
          alert('Ошибка при создании лота: ' + error.message);
        }
      });
    };

    function getRatingPoints(ratingBase) {
      if (!ratingBase) return 0;
      const ratingMap = {
        'AAA': 5.0, 'AA': 4.6, 'A': 4.2,
        'BBB': 3.8, 'BB': 3.4, 'B': 3.0,
        'CCC': 2.6, 'CC': 2.2, 'C': 1.8,
        'DDD': 1.4, 'DD': 1.0, 'D': 0.6
      };
      let cleanRating = ratingBase.replace('+', '').trim();
      let pts = ratingMap[cleanRating] || 0;
      if (ratingBase.includes('+')) pts += 0.2;
      return parseFloat(Math.min(5.0, pts).toFixed(1));
    }

    // ===========================================
    // API Integration Functions
    // ===========================================

    function calculateBidScore(bid, allBids, targetDeadline) {
      // 1. mc.uz Rating (max 5.0 points)
      let score = getRatingPoints(bid.subcontractor?.rating || bid.rating);

      // 2. Documents (max 2.0 points)
      // +1.0 each for Certificate and License
      if (bid.subcontractor?.certificatePhoto || bid.certificatePhoto) score += 1.0;
      if (bid.subcontractor?.licensePhoto || bid.licensePhoto) score += 1.0;

      // 3. Price Competitiveness (max 2.0 points)
      // Lower price is better. Comparison with other bids.
      if (allBids && allBids.length > 0) {
        const prices = allBids.map(b => b.priceTotal).filter(p => p > 0);
        const minPrice = prices.length ? Math.min(...prices) : 0;
        const maxPrice = prices.length ? Math.max(...prices) : 0;

        if (maxPrice > minPrice && bid.priceTotal > 0) {
          // If multiple bids, lowest gets full 2.0, highest gets 0
          score += 2.0 * (1 - (bid.priceTotal - minPrice) / (maxPrice - minPrice));
        } else if (bid.priceTotal > 0) {
          // If only one bid or all same, full 2.0 points
          score += 2.0;
        }
      }

      // 4. Deadline Competitiveness (max 1.0 point)
      // Sooner date is better. Comparison with target lot deadline.
      if (targetDeadline && bid.completionDate) {
        const target = new Date(targetDeadline);
        const bidDate = new Date(bid.completionDate);
        if (!isNaN(target.getTime()) && !isNaN(bidDate.getTime())) {
          // If bid is before or on target, full points (1.0)
          if (bidDate <= target) {
            score += 1.0;
          } else {
            // If bid is after target, deduct 0.1 per day delay, min 0
            const dayDiff = Math.ceil((bidDate - target) / (1000 * 60 * 60 * 24));
            score += Math.max(0, 1.0 - (dayDiff * 0.1));
          }
        }
      } else {
        // Flat small bonus if no deadline data provided
        score += 0.3;
      }

      return parseFloat(Math.min(10, score).toFixed(1));
    }

    /**
     * Загрузить тендеры с сервера
     */
    async function loadTenders() {
      try {
        const tenders = await apiGetTenders(CURRENT_PROJECT_ID);

        if (tenders && tenders.length > 0 && tenders[0].project) {
          PROJECT_CURRENCY = tenders[0].project.currency || 'UZS';
        }

        // Преобразуем данные с сервера в формат для UI
        lots = tenders.map((tender, index) => {
          const blockIds = JSON.parse(tender.blockIds || '[]');
          const sectionIds = JSON.parse(tender.sectionIds || '[]');
          const tenderItems = JSON.parse(tender.items || '[]');

          // Generate Display ID based on order (assuming sorted by newest first)
          // Total count is tenders.length. Newest is index 0.
          // ID = Total - index
          const displayIdNumber = tenders.length - index;
          const displayId = `LOT-${String(displayIdNumber).padStart(3, '0')}`;

          // Преобразуем bids в uploads
          const bidUploads = tender.bids.map(bid => {
            const items = JSON.parse(bid.items || '[]');
            const files = JSON.parse(bid.files || '[]');

            return {
              uploadId: bid.id,
              subcontractor: bid.subcontractor.company,
              coverage: `${blockIds.join(', ')}: ${sectionIds.join(', ')}`,
              status: bid.status,
              files: files,
              total: bid.priceTotal,
              score: calculateBidScore(bid, tender.bids, tender.deadline),
              completionDate: bid.completionDate,
              contractNumber: bid.contractNumber,
              items: items,
              ratingPoints: getRatingPoints(bid.subcontractor?.rating),
              rating: bid.subcontractor?.rating || null,
              certificatePhoto: bid.certificatePhoto || bid.subcontractor?.certificatePhoto || null,
              licensePhoto: bid.licensePhoto || bid.subcontractor?.licensePhoto || null,
              inn: bid.subcontractor?.inn || null,
              subcontractorId: bid.subcontractor?.id,
              errors: [],
              blocked: bid.blocked,
              blockReason: bid.blockReason,
              blockDate: bid.blockDate,
              inviteCode: bid.invite?.inviteCode,
              _rawData: bid
            };
          });

          // Преобразуем invites в uploads (для тех, кто еще не подал оффер)
          // Фильтруем те, у которых уже есть bid (они попадут в bidUploads)
          const inviteUploads = (tender.invites || [])
            .filter(invite => !invite.bid)
            .map(invite => {
              return {
                uploadId: `invite-${invite.id}`,
                subcontractor: invite.subcontractor.company,
                coverage: `${blockIds.join(', ')}: ${sectionIds.join(', ')}`,
                status: 'invited', // Специальный статус для приглашенных
                files: [],
                total: null,
                score: null,
                completionDate: null,
                contractNumber: null,
                items: [],
                ratingPoints: getRatingPoints(invite.subcontractor?.rating),
                rating: invite.subcontractor?.rating || null,
                certificatePhoto: invite.subcontractor?.certificatePhoto || null,
                licensePhoto: invite.subcontractor?.licensePhoto || null,
                inn: invite.subcontractor?.inn || null,
                subcontractorId: invite.subcontractor?.id,
                errors: [],
                blocked: false,
                blockReason: null,
                blockDate: null,
                inviteCode: invite.inviteCode,
                _rawData: invite
              };
            });

          const uploads = [...bidUploads, ...inviteUploads];

          return {
            id: displayId, // Use generated ID for display
            objectName: tender.project?.name || 'Проект',
            title: tender.name,
            startDate: new Date(tender.startDate).toISOString().split('T')[0],
            status: tender.status,
            deadline: new Date(tender.deadline).toISOString().split('T')[0],
            allowAllBlocks: true,
            allowAllSections: true,
            blocks: blockIds,
            sections: sectionIds,
            items: tenderItems, // Store items
            invites: tender.invites?.length || 0,
            uploads: uploads,
            _rawData: tender // Сохраняем оригинальные данные
          };
        });

        renderLots();
      } catch (error) {
        console.error('Failed to load tenders:', error);
        alert('Не удалось загрузить тендеры. Используются демо-данные.');
      }
    }

    renderObjects();
    // renderLots(); // Закомментируем, чтобы не было двойного рендера
    loadTenders(); // Загружаем данные с сервера
  </script>
</body>

</html>