<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Портал субподрядчика · ProBIM</title>
    <link rel="stylesheet" href="css/style.css">
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Outfit:wght@500;600;700&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --primary: #2B7A78;
            --primary-light: #3AAFA9;
            --primary-lighter: #DEF2F1;
            --dark: #17252A;
            --gray-50: #F8FAFC;
            --gray-100: #F1F5F9;
            --gray-200: #E2E8F0;
            --gray-300: #CBD5E1;
            --gray-400: #94A3B8;
            --gray-500: #64748B;
            --gray-600: #475569;
            --gray-700: #334155;
            --gray-800: #1E293B;
            --white: #FFFFFF;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --font-main: 'Inter', sans-serif;
            --font-title: 'Outfit', sans-serif;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: var(--font-main);
            background-color: var(--gray-50);
            color: var(--gray-800);
            -webkit-font-smoothing: antialiased;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* --- Login Screen --- */
        #login-screen {
            position: fixed;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
            overflow: hidden;
            background: var(--dark);
        }

        #login-video {
            position: absolute;
            top: 50%;
            left: 50%;
            min-width: 100%;
            min-height: 100%;
            width: auto;
            height: auto;
            transform: translate(-50%, -50%);
            object-fit: cover;
            z-index: 1;
        }

        #login-screen::after {
            content: "";
            position: absolute;
            inset: 0;
            background: rgba(23, 37, 42, 0.5);
            /* Overlay for readability */
            z-index: 2;
        }

        .login-card {
            position: relative;
            z-index: 10;
            background: var(--white);
            padding: 40px;
            border-radius: 24px;
            box-shadow: var(--shadow-lg);
            width: 100%;
            max-width: 400px;
            text-align: center;
            animation: slideUp 0.5s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .login-logo {
            font-family: var(--font-title);
            font-size: 32px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .login-title {
            font-size: 18px;
            color: var(--gray-600);
            margin-bottom: 32px;
        }

        .code-input-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
            align-items: center;
            margin-bottom: 24px;
        }

        .code-input-group label {
            font-size: 11px;
            font-weight: 700;
            color: var(--gray-400);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 4px;
        }

        .split-inputs {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .code-input-single {
            width: 50px;
            height: 60px;
            border: 2px solid var(--gray-200);
            border-radius: 12px;
            font-size: 28px;
            text-align: center;
            font-weight: 700;
            font-family: var(--font-title);
            color: var(--dark);
            transition: all 0.2s;
            outline: none;
        }

        .code-input-single:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 4px var(--primary-lighter);
        }

        .btn-login {
            width: 100%;
            padding: 16px;
            background: var(--primary);
            color: var(--white);
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-login:hover {
            background: var(--primary-light);
            transform: translateY(-1px);
        }

        .btn-login:disabled {
            background: var(--gray-300);
            cursor: not-allowed;
            transform: none;
        }

        /* --- Dashboard Screen --- */
        #portal-screen {
            display: none;
            /* Shown after login */
            flex-direction: column;
            height: 100vh;
        }

        .portal-header {
            background: var(--white);
            border-bottom: 1px solid var(--gray-200);
            padding: 16px 32px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: var(--shadow-sm);
        }

        .portal-brand {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .portal-logo {
            font-family: var(--font-title);
            font-size: 24px;
            font-weight: 700;
            color: var(--primary);
        }

        .tender-info-chip {
            background: var(--gray-100);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
            color: var(--gray-700);
        }

        .portal-actions {
            display: flex;
            gap: 12px;
        }

        .btn-action {
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
        }

        .btn-save {
            background: var(--white);
            border-color: var(--gray-300);
            color: var(--gray-700);
        }

        .btn-save:hover {
            background: var(--gray-50);
            border-color: var(--gray-400);
        }

        .btn-submit {
            background: var(--primary);
            color: var(--white);
        }

        .btn-submit:hover {
            background: var(--primary-light);
        }

        .btn-primary {
            background: var(--primary);
            color: #fff;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            border: none;
            cursor: pointer;
            outline: none;
        }

        .btn-primary:hover {
            background: var(--primary-light);
            transform: translateY(-1px);
        }

        .btn-download {
            background: #E6F4F1;
            color: var(--primary);
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            border: 1px solid var(--primary-light);
            cursor: pointer;
            transition: all 0.2s;
            outline: none;
        }

        .btn-download:hover {
            background: #DEF2F1;
            border-color: var(--primary);
        }

        /* --- Stats Bar --- */
        .stats-bar {
            background: var(--white);
            border-bottom: 1px solid var(--gray-200);
            padding: 12px 32px;
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 24px;
        }

        .stat-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .stat-label {
            font-size: 11px;
            text-transform: uppercase;
            color: var(--gray-500);
            letter-spacing: 0.05em;
            font-weight: 600;
        }

        .stat-value {
            font-size: 15px;
            font-weight: 700;
            color: var(--gray-800);
        }

        .stat-input {
            border: 1px solid var(--gray-300);
            border-radius: 6px;
            padding: 4px 8px;
            font-size: 14px;
            font-weight: 600;
            width: 100%;
            outline: none;
            transition: border-color 0.2s;
        }

        .stat-input:focus {
            border-color: var(--primary);
        }

        .countdown-timer {
            color: #E11D48;
            font-family: inherit;
        }

        /* --- Main Content Split --- */
        .main-content {
            flex: 1;
            display: grid;
            grid-template-columns: 250px 300px 1fr;
            overflow: hidden;
            background: var(--gray-50);
            padding: 24px;
            gap: 24px;
        }

        /* --- Requisites Bar --- */
        .requisites-bar {
            background: #fff;
            border-bottom: 1px solid var(--gray-200);
            padding: 8px 32px;
            display: flex;
            gap: 24px;
            font-size: 12px;
            color: var(--gray-600);
        }

        .req-item strong {
            color: var(--gray-800);
            margin-right: 4px;
        }

        .panel {
            display: flex;
            flex-direction: column;
            background: var(--white);
            border-radius: 12px;
            box-shadow: var(--shadow-sm);
            overflow: hidden;
            border: 1px solid var(--gray-200);
        }

        .panel-header {
            padding: 16px;
            border-bottom: 1px solid var(--gray-100);
            background: var(--gray-50);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .panel-title {
            font-size: 15px;
            font-weight: 700;
            color: var(--gray-800);
        }

        .panel-body {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
        }

        /* --- List Styles --- */
        .list-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            border-bottom: 1px solid var(--gray-50);
            transition: background 0.1s;
        }

        .list-item:hover {
            background: var(--gray-50);
        }

        .item-name {
            font-size: 13px;
            font-weight: 500;
            color: var(--gray-700);
        }

        .btn-download {
            background: var(--primary-lighter);
            color: var(--primary);
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .btn-download:hover {
            background: #D1EAE9;
        }

        /* --- Upload Area --- */
        .upload-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border: 2px dashed var(--gray-300);
            border-radius: 12px;
            margin: 12px;
            padding: 32px;
            text-align: center;
            transition: all 0.2s;
            cursor: pointer;
        }

        .upload-container:hover,
        .upload-container.dragover {
            border-color: var(--primary);
            background: var(--primary-lighter);
        }

        .upload-icon {
            font-size: 40px;
            margin-bottom: 16px;
            color: var(--primary);
        }

        .upload-text {
            font-size: 14px;
            color: var(--gray-600);
            margin-bottom: 8px;
        }

        .upload-hint {
            font-size: 12px;
            color: var(--gray-400);
        }

        /* --- Toast Notification --- */
        #toast {
            position: fixed;
            bottom: 32px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--dark);
            color: var(--white);
            padding: 12px 24px;
            border-radius: 30px;
            font-size: 14px;
            font-weight: 500;
            box-shadow: var(--shadow-lg);
            transition: all 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28);
            z-index: 2000;
        }

        #toast.show {
            transform: translateX(-50%) translateY(0);
        }

        /* --- Tree View Styles --- */
        .tree-stage {
            margin-bottom: 20px;
        }

        .tree-stage-title {
            font-weight: 700;
            font-size: 13px;
            color: var(--dark);
            padding: 10px 14px;
            background: var(--gray-50);
            border-radius: 8px;
            margin-bottom: 12px;
            border-left: 4px solid var(--primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .tree-work {
            margin-left: 12px;
            margin-bottom: 12px;
            border: 1px solid var(--gray-100);
            border-radius: 8px;
            padding: 12px;
            transition: border-color 0.2s;
        }

        .tree-work:hover {
            border-color: var(--primary-light);
        }

        .tree-work-header {
            display: flex;
            justify-content: space-between;
            font-weight: 600;
            font-size: 13px;
            color: var(--gray-800);
            margin-bottom: 8px;
        }

        .tree-resources {
            margin-top: 8px;
            display: flex;
            flex-direction: column;
            gap: 6px;
            border-top: 1px dashed var(--gray-200);
            padding-top: 8px;
        }

        .tree-resource {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: var(--gray-600);
            padding: 2px 0;
        }

        .res-type-tag {
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            padding: 2px 6px;
            border-radius: 4px;
            margin-right: 8px;
            background: var(--gray-100);
            color: var(--gray-500);
            width: 80px;
            text-align: center;
        }

        .res-type-material {
            background: #E0F2FE;
            color: #0369A1;
        }

        .res-type-work {
            background: #F0FDF4;
            color: #15803D;
        }

        .res-type-equipment {
            background: #FEF3C7;
            color: #92400E;
        }

        .res-name {
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .res-qty {
            width: 70px;
            text-align: right;
            font-weight: 600;
            color: var(--gray-800);
        }

        .res-unit {
            width: 40px;
            text-align: right;
            color: var(--gray-400);
            font-weight: 500;
        }

        .estimate-item {
            cursor: pointer;
            transition: all 0.2s;
            border-radius: 8px;
            margin-bottom: 4px;
        }

        .estimate-item:hover {
            background: var(--primary-lighter);
        }

        .estimate-item.active {
            background: #DEF2F1;
            color: var(--primary);
            border: 1px solid var(--primary-light);
        }

        .estimate-item.active .item-name {
            color: var(--primary);
        }

        .estimate-item.active .btn-download {
            background: rgba(43, 122, 120, 0.1);
            color: var(--primary);
        }

        .section-item {
            cursor: pointer;
            transition: all 0.2s;
            border-radius: 8px;
            margin-bottom: 4px;
        }

        .section-item:hover {
            background: var(--gray-100);
        }

        .section-item.active {
            background: #DEF2F1;
            color: var(--primary);
            border: 1px solid var(--primary-light);
        }

        .section-item.active .item-name {
            color: var(--primary);
        }

        .caret {
            display: inline-block;
            transition: transform 0.2s;
            cursor: pointer;
            color: var(--gray-400);
            width: 14px;
            text-align: center;
            font-size: 11px;
            user-select: none;
        }

        .tree-stage-title,
        .tree-work-header {
            cursor: pointer;
            user-select: none;
        }

        .tree-stage-title:hover {
            background: var(--gray-100);
        }

        .tree-work-header:hover {
            color: var(--primary);
        }

        .res-icon-box {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            margin-right: 12px;
        }

        /* Shadow for work items */
        .shadow-sm {
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }
    </style>
</head>

<body>

    <!-- Login Screen -->
    <div id="login-screen">
        <video autoplay muted loop playsinline id="login-video">
            <source src="src/media/Login.mp4" type="video/mp4">
        </video>
        <div class="login-card">
            <div class="login-logo" style="text-transform: uppercase;">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"
                    stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" />
                </svg>
                PROBIM PORTAL
            </div>
            <div class="login-title"
                style="font-size: 11px; font-weight: 700; color: var(--gray-400); letter-spacing: 0.1em; text-transform: uppercase; margin-top: -4px;">
                МОДУЛЬ ТЕНДЕРА</div>

            <div class="code-input-group" style="margin-top: 32px;">
                <label>Введите 4-значный код</label>
                <div class="split-inputs">
                    <input type="text" class="code-input-single" maxlength="1" pattern="\d*" inputmode="numeric"
                        autofocus>
                    <input type="text" class="code-input-single" maxlength="1" pattern="\d*" inputmode="numeric">
                    <input type="text" class="code-input-single" maxlength="1" pattern="\d*" inputmode="numeric">
                    <input type="text" class="code-input-single" maxlength="1" pattern="\d*" inputmode="numeric">
                </div>
            </div>

            <button id="btn-login" class="btn-login">Войти в систему</button>
            <div id="login-error" style="color: #E11D48; font-size: 13px; margin-top: 16px; display: none;">Неверный код
                доступа</div>
        </div>
    </div>

    <!-- Portal Screen -->
    <div id="portal-screen">
        <header class="portal-header">
            <div class="portal-brand">
                <div class="portal-logo">ProBIM</div>
                <div class="tender-info-chip" id="tender-title-chip">Загрузка...</div>
            </div>
            <div class="portal-actions">
                <button class="btn-action btn-save" id="btn-save">Сохранить черновик</button>
                <button class="btn-action btn-submit" id="btn-submit">Отправить оферту</button>
                <button class="btn-action logout-btn" onclick="logout()"
                    style="background: #FFE5E5; color: #E11D48; border-color: #FECACA; display: flex; align-items: center; gap: 6px;">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" />
                        <polyline points="16 17 21 12 16 7" />
                        <line x1="21" y1="12" x2="9" y2="12" />
                    </svg>
                    Выйти
                </button>
            </div>
        </header>

        <section class="stats-bar">
            <div class="stat-item">
                <div class="stat-label">Общая сумма предложения</div>
                <input type="number" id="total-price" class="stat-input" placeholder="0.00">
            </div>
            <div class="stat-item">
                <div class="stat-label">Срок выполнения (дней)</div>
                <input type="number" id="completion-days" class="stat-input" placeholder="0">
            </div>
            <div class="stat-item">
                <div class="stat-label">Дата начала лота</div>
                <div class="stat-value" id="start-date-val">—</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">Дата окончания</div>
                <div class="stat-value" id="deadline-val">—</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">До завершения</div>
                <div class="stat-value countdown-timer" id="timer-val">—</div>
            </div>
        </section>

        <section class="requisites-bar" id="sub-requisites">
            <!-- Subcontractor requisites will be here -->
        </section>

        <main class="main-content">
            <!-- 1. Sections -->
            <div class="panel">
                <div class="panel-header">
                    <div class="panel-title">Секции</div>
                </div>
                <div class="panel-body" id="sections-list">
                    <!-- Dynamic content -->
                </div>
            </div>

            <!-- 2. Estimates -->
            <div class="panel">
                <div class="panel-header">
                    <div class="panel-title">Доступные сметы</div>
                </div>
                <div class="panel-body" id="estimates-list">
                    <!-- Dynamic content -->
                </div>
            </div>

            <!-- 3. Detailed View & Upload -->
            <div class="panel" style="background: var(--gray-50);">
                <div class="panel-header">
                    <div class="panel-title" id="details-title">Просмотр сметы</div>
                    <div style="display:flex; gap:8px;">
                        <button class="btn-download" id="top-btn-download"
                            style="display: none; height: 32px; font-size: 12px; align-items: center;"
                            onclick="downloadEstimate()">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2" style="margin-right: 6px;">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                                <polyline points="7 10 12 15 17 10" />
                                <line x1="12" y1="15" x2="12" y2="3" />
                            </svg>
                            Экспорт CSV
                        </button>
                        <button class="btn-primary"
                            style="height: 32px; font-size: 12px; display: flex; align-items: center;"
                            onclick="document.getElementById('file-upload').click()">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2" style="margin-right: 6px;">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                                <polyline points="17 8 12 3 7 8" />
                                <line x1="12" y1="3" x2="12" y2="15" />
                            </svg>
                            Загрузить оферту (CSV)
                        </button>
                        <input type="file" id="file-upload" accept=".csv" style="display: none;"
                            onchange="uploadFile(this)">
                    </div>
                </div>
                <div class="panel-body" id="details-view"
                    style="padding: 20px; background: #fff; margin: 12px; border-radius: 12px; border: 1px solid var(--gray-200);">
                    <div style="text-align: center; color: var(--gray-400); margin-top: 40px;">Выберите смету для
                        просмотра деталей</div>
                </div>
                <div id="file-status"
                    style="margin: 0 20px 20px 20px; padding: 10px; border-radius: 8px; font-size: 13px; font-weight: 500; display: none; background: var(--gray-100);">
                </div>
            </div>
        </main>
    </div>

    <div id="toast">Уведомление</div>

    <script>
        // State
        const urlParams = new URLSearchParams(window.location.search);
        let token = urlParams.get('token');
        let tenderId = urlParams.get('tenderId');
        let authCode = localStorage.getItem('sub_authCode') || null;
        let tenderData = null;
        let timerInterval = null;
        let activeBlockName = null;
        let activeEstimateId = null;
        let showPrices = false; // Flag to reveal prices after interaction

        // Auto-login if we have saved credentials
        window.addEventListener('load', async () => {
            const savedToken = localStorage.getItem('sub_token');
            const savedCode = localStorage.getItem('sub_authCode');
            if (savedToken && savedCode) {
                token = savedToken;
                authCode = savedCode;
                // If tenderId was not in URL, try to get it from localStorage
                if (!tenderId) {
                    tenderId = localStorage.getItem('sub_tenderId');
                }
                loadPortal();
            }
        });

        // UI Elements
        const loginScreen = document.getElementById('login-screen');
        const portalScreen = document.getElementById('portal-screen');
        const splitInputs = document.querySelectorAll('.code-input-single');
        const btnLogin = document.getElementById('btn-login');
        const loginError = document.getElementById('login-error');
        const toast = document.getElementById('toast');

        // Initial check
        if (!token && !tenderId) {
            alert('Ссылка недействительна (отсутствует токен или ID тендера)');
        }

        // --- Logic ---

        function showToast(msg) {
            toast.textContent = msg;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        // OTP Input Logic
        const focusFirstEmpty = () => {
            for (let input of splitInputs) {
                if (!input.value) {
                    input.focus();
                    return;
                }
            }
            splitInputs[splitInputs.length - 1].focus();
        };

        if (splitInputs.length > 0) focusFirstEmpty();

        // Redirect clicks on login screen to the appropriate input
        loginScreen.addEventListener('click', (e) => {
            // Only redirect if not clicking on the login button or other interactive elements
            if (e.target.closest('.btn-login') || e.target.closest('.code-input-single')) return;
            focusFirstEmpty();
        });

        splitInputs.forEach((input, index) => {
            input.addEventListener('input', (e) => {
                if (e.target.value.length === 1 && index < splitInputs.length - 1) {
                    splitInputs[index + 1].focus();
                }
            });

            input.addEventListener('keydown', (e) => {
                if (e.key === 'Backspace' && !e.target.value && index > 0) {
                    splitInputs[index - 1].focus();
                }
            });

            // Prevent focusing a field if a previous one is empty
            input.addEventListener('focus', () => {
                for (let i = 0; i < index; i++) {
                    if (!splitInputs[i].value) {
                        splitInputs[i].focus();
                        break;
                    }
                }
            });
        });

        // Auth
        btnLogin.addEventListener('click', async () => {
            const code = Array.from(splitInputs).map(i => i.value).join('');
            if (code.length !== 4) return;

            btnLogin.disabled = true;
            btnLogin.textContent = 'Проверка...';
            loginError.style.display = 'none';

            try {
                let response;
                if (token) {
                    // Auth by token + code
                    response = await fetch(`/api/tenders/invites/${token}/auth`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ code })
                    });
                } else if (tenderId) {
                    // Auth by tenderId + code
                    response = await fetch(`/api/tenders/auth`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ tenderId, code })
                    });
                }

                if (response && response.ok) {
                    const resData = await response.json();
                    authCode = code;
                    token = resData.token; // Update token from server if we had none

                    // Save to persistent storage
                    localStorage.setItem('sub_token', token);
                    localStorage.setItem('sub_authCode', authCode);
                    if (tenderId) localStorage.setItem('sub_tenderId', tenderId);

                    await loadPortal();
                } else {
                    loginError.style.display = 'block';
                }
            } catch (err) {
                console.error(err);
                alert('Ошибка соединения с сервером');
            } finally {
                btnLogin.disabled = false;
                btnLogin.textContent = 'Войти в систему';
            }
        });

        async function loadPortal() {
            try {
                const response = await fetch(`/api/tenders/invites/${token}/details?code=${authCode}`);
                if (!response.ok) throw new Error('Failed to load details');

                tenderData = await response.json();

                // Hide login, show portal
                loginScreen.style.display = 'none';
                portalScreen.style.display = 'flex';

                renderUI();
                startCountdown();
            } catch (err) {
                console.error(err);
                alert('Ошибка при загрузке данных тендера');
            }
        }

        window.logout = () => {
            localStorage.removeItem('sub_token');
            localStorage.removeItem('sub_authCode');
            localStorage.removeItem('sub_tenderId');
            window.location.reload();
        };

        function renderUI() {
            const { tender, items, bid, subcontractor } = tenderData;

            document.getElementById('tender-title-chip').textContent = tender.name;
            document.getElementById('start-date-val').textContent = formatDate(tender.startDate);
            document.getElementById('deadline-val').textContent = formatDate(tender.deadline);

            if (bid) {
                document.getElementById('total-price').value = bid.priceTotal;
                document.getElementById('completion-days').value = bid.completionDate;
                if (bid.priceTotal > 0) showPrices = true; // Show prices if bid already exists
            }

            // Subcontractor Requisites
            const requisitesContainer = document.getElementById('sub-requisites');
            requisitesContainer.innerHTML = `
                <div class="req-item"><strong>Организация:</strong> ${subcontractor.company}</div>
                <div class="req-item"><strong>ИНН:</strong> ${subcontractor.inn || '—'}</div>
                <div class="req-item"><strong>Телефон:</strong> ${subcontractor.phone || '—'}</div>
                <div class="req-item"><strong>Адрес:</strong> ${subcontractor.address || '—'}</div>
            `;

            // Sections List (Unique Blocks)
            const blocks = [...new Set(items.map(i => i.blockName || i.blockId))].filter(Boolean);
            const sectionsContainer = document.getElementById('sections-list');

            let sectionsHtml = blocks.map(bName => `
                <div class="list-item section-item ${activeBlockName === bName ? 'active' : ''}" onclick="selectSection('${bName}')">
                    <span class="item-name">${bName}</span>
                </div>
            `).join('');
            sectionsContainer.innerHTML = sectionsHtml;

            // Auto-select first section if none selected
            if (!activeBlockName && blocks.length > 0) {
                selectSection(blocks[0]);
            }

            // Estimates List (Filtered by activeBlockName)
            const filteredItems = activeBlockName
                ? items.filter(i => (i.blockName || i.blockId) === activeBlockName)
                : items;

            const estimates = [...new Set(filteredItems.map(i => i.estimateId))].filter(Boolean);
            const estimateNames = {};
            filteredItems.forEach(i => { if (i.estimateId) estimateNames[i.estimateId] = i.estimateName || i.estimateId; });

            const estimatesContainer = document.getElementById('estimates-list');
            if (estimates.length === 0) {
                estimatesContainer.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--gray-400); font-size: 13px;">Сметы не найдены</div>';
            } else {
                estimatesContainer.innerHTML = estimates.map(eId => `
                    <div class="list-item estimate-item ${activeEstimateId === eId ? 'active' : ''}" data-id="${eId}" onclick="selectEstimate('${eId}')">
                        <span class="item-name">${estimateNames[eId]}</span>
                    </div>
                `).join('');
            }
        }

        window.selectSection = (bName) => {
            activeBlockName = bName;
            renderUI();
        };

        window.selectEstimate = (eId) => {
            activeEstimateId = eId;
            document.querySelectorAll('.estimate-item').forEach(el => {
                el.classList.toggle('active', el.dataset.id === eId);
            });
            document.getElementById('top-btn-download').style.display = 'flex';
            renderEstimateDetails(eId);
        };

        function renderEstimateDetails(estimateId) {
            const { tender, items, workTypes } = tenderData;
            const container = document.getElementById('details-view');
            const titleEl = document.getElementById('details-title');

            const currency = tender.project?.currency || 'RUB';
            const currencySymbols = { 'RUB': '₽', 'UZS': 'сўм', 'USD': '$', 'EUR': '€' };
            const symbol = currencySymbols[currency] || currency;

            const estimateItems = items.filter(i => i.estimateId === estimateId);
            if (estimateItems.length === 0) return;

            titleEl.textContent = `Раздел сметы: ${estimateItems[0].estimateName || estimateId}`;

            // Map workTypes for easy lookup and total cost calculation
            const wtMap = new Map();
            workTypes.forEach(wt => {
                const totalCost = wt.resources.reduce((sum, res) => sum + (res.totalCost || 0), 0);
                wtMap.set(wt.id, { ...wt, totalCost });
            });

            // Group items by Stage
            const stagesMap = new Map();
            estimateItems.forEach(item => {
                const sId = item.stageId || 'default-stage';
                const sName = item.stageName || item.stage || 'Этап';
                if (!stagesMap.has(sId)) {
                    stagesMap.set(sId, { name: sName, items: [] });
                }
                stagesMap.get(sId).items.push(item);
            });

            // Icons
            const icons = {
                material: `
                    <div class="res-icon-box" style="background: #E0E7FF; color: rgb(0, 0, 128);">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><path d="m3.3 7 8.7 5 8.7-5"/><path d="M12 22V12"/></svg>
                    </div>`,
                equipment: `
                    <div class="res-icon-box" style="background: #FFEDD5; color: #EA580C;">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m14 11 4 2 2-2"/><path d="M4 18V7c0-1.1.9-2 2-2h3c1.1 0 2 .9 2 2v3"/><circle cx="7" cy="15" r="4"/><circle cx="18" cy="15" r="4"/><path d="M12 15h2"/></svg>
                    </div>`,
                labor: `
                    <div class="res-icon-box" style="background: #F3E8FF; color: rgb(128, 0, 128);">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                    </div>`,
                service: `
                    <div class="res-icon-box" style="background: #EDE9FE; color: #6D28D9;">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"></path></svg>
                    </div>`
            };

            const formatNum = (n) => (n || 0).toLocaleString('ru-RU', { minimumFractionDigits: 0, maximumFractionDigits: 2 });
            const formatCur = (n) => `${formatNum(n)} ${symbol}`;

            let html = '';
            let stageIdx = 1;
            stagesMap.forEach((stage, sId) => {
                let sName = stage.name;
                // Remove existing "ЭТАП N" prefix to avoid duplicates
                sName = sName.replace(/^ЭТАП\s+\d+:\s*/i, '').replace(/^STAGE\s+\d+:\s*/i, '');

                html += `
                    <div class="tree-stage">
                        <div class="tree-stage-title" onclick="toggleTreeItem('stage-${sId}')">
                            <div style="display:flex; align-items:center; gap:8px;">
                                <span class="caret" id="caret-stage-${sId}">▼</span>
                                <span>ЭТАП ${stageIdx++}: ${sName.toUpperCase()}</span>
                            </div>
                        </div>
                        <div class="tree-works" id="stage-${sId}">
                            ${stage.items.map((item, idx) => {
                    const wt = wtMap.get(item.workTypeId);
                    const resources = wt ? wt.resources : [];
                    const workRef = `work-${sId}-${idx}`;
                    const workNum = idx + 1;

                    const actualTotal = wt ? wt.totalCost : 0;
                    const displayTotal = showPrices ? actualTotal : 0;
                    const actualUnitCost = actualTotal / (item.volume || 1);
                    const displayUnitCost = showPrices ? actualUnitCost : 0;

                    return `
                                    <div class="tree-work shadow-sm" style="background: #fff; margin-bottom: 20px;">
                                        <div class="tree-work-header" style="border-bottom: none; padding-bottom: 4px;" onclick="toggleTreeItem('${workRef}')">
                                            <div style="display:flex; align-items:start; gap:12px;">
                                                <span class="caret" id="caret-${workRef}" style="margin-top: 4px;">▼</span>
                                                <span style="color: #94A3B8; font-family: monospace;">${workNum}.</span>
                                                <div>
                                                    <div style="font-weight: 500; font-size: 14px;">${item.name} <span style="color: #CBD5E1; margin-left:8px; font-weight:400;">(${resources.length})</span></div>
                                                    <div style="font-size: 13px; color: #94A3B8; margin-top: 4px; font-weight: 400;">
                                                        ${formatNum(item.volume)} ${item.unit} <span style="margin: 0 8px; opacity: 0.5;">×</span> ${formatNum(displayUnitCost)} <span style="margin: 0 8px; opacity: 0.5;">=</span> <span style="color: #2B7A78; font-weight: 600;">${formatCur(displayTotal)}</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        ${resources.length > 0 ? `
                                            <div class="tree-resources" id="${workRef}" style="margin-left: 48px; gap: 8px; border-left: 2px solid #F1F5F9; padding-left: 12px; margin-top: 12px; margin-bottom: 8px;">
                                                ${resources.map((res, rIdx) => {
                        const rawType = (res.resourceType || '').toLowerCase();
                        let type = 'material';
                        if (rawType.includes('labor') || rawType.includes('работа')) type = 'labor';
                        else if (rawType.includes('equipment') || rawType.includes('оборудование') || rawType.includes('механизм')) type = 'equipment';
                        else if (rawType.includes('service') || rawType.includes('услуга')) type = 'service';
                        else type = 'material';

                        const resColor = {
                            material: 'rgb(0, 0, 128)',
                            labor: 'rgb(128, 0, 128)',
                            equipment: '#EA580C',
                            service: '#6D28D9'
                        }[type];

                        const resDisplayPrice = showPrices ? res.unitCost : 0;
                        const resDisplayTotal = showPrices ? res.totalCost : 0;

                        return `
                                                        <div class="tree-resource" style="margin-bottom: 6px;">
                                                            <span style="color: #CBD5E1; font-family: monospace; width: 24px; font-size: 12px;">${workNum}.${rIdx + 1}</span>
                                                            ${icons[type]}
                                                            <div style="flex: 1; min-width: 0;">
                                                                <div class="res-name" style="color: ${resColor}; font-weight: 500; font-size: 13px;">${res.name}</div>
                                                                <div style="font-size: 12px; color: ${resColor}; opacity: 0.8; margin-top: 2px;">
                                                                    ${formatNum(res.quantity)} ${res.unit || ''} <span style="margin: 0 4px; opacity: 0.5;">×</span> ${formatNum(resDisplayPrice)} <span style="margin: 0 4px; opacity: 0.5;">=</span> <span style="font-weight: 600; color: #334155;">${formatCur(resDisplayTotal)}</span>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    `;
                    }).join('')}
                                            </div>
                                        ` : ''}
                                    </div>
                                `;
                }).join('')}
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html || '<div style="text-align: center; color: var(--gray-400); margin-top: 40px;">Данные не найдены</div>';
            container.scrollTop = 0;
        }

        window.toggleTreeItem = (id) => {
            const el = document.getElementById(id);
            const caret = document.getElementById('caret-' + id);
            if (el.style.display === 'none') {
                el.style.display = 'flex';
                if (id.startsWith('stage')) el.style.display = 'block';
                caret.style.transform = 'rotate(0deg)';
                caret.textContent = '▼';
            } else {
                el.style.display = 'none';
                caret.style.transform = 'rotate(-90deg)';
                caret.textContent = '▶';
            }
        };

        window.downloadEstimate = () => {
            if (!activeEstimateId) return;
            window.location.href = `/api/tenders/invites/${token}/export-csv/${activeEstimateId}?code=${authCode}`;
        };

        function formatDate(d) {
            if (!d) return '—';
            const date = new Date(d);
            const pad = (n) => String(n).padStart(2, '0');
            const day = pad(date.getDate());
            const month = pad(date.getMonth() + 1);
            const year = String(date.getFullYear()).slice(-2);
            const hours = pad(date.getHours());
            const minutes = pad(date.getMinutes());
            const seconds = pad(date.getSeconds());
            return `${day}.${month}.${year} ${hours}:${minutes}:${seconds}`;
        }

        function startCountdown() {
            if (timerInterval) clearInterval(timerInterval);

            let deadlineStr = tenderData.tender.deadline;
            if (deadlineStr && !deadlineStr.includes('T')) {
                deadlineStr += 'T23:59:59';
            }
            const deadline = new Date(deadlineStr).getTime();

            function updateTimer() {
                const now = new Date().getTime();
                const diff = deadline - now;

                if (diff <= 0) {
                    document.getElementById('timer-val').textContent = 'Прием завершен';
                    clearInterval(timerInterval);
                    return;
                }

                const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const min = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                const sec = Math.floor((diff % (1000 * 60)) / 1000);

                document.getElementById('timer-val').textContent = `${days}д ${hours}ч ${min}м ${sec}с`;
            }

            updateTimer();
            timerInterval = setInterval(updateTimer, 1000);
        }

        // Upload Logic
        const fileUploadInput = document.getElementById('file-upload');
        const fileStatus = document.getElementById('file-status');

        if (fileUploadInput) {
            fileUploadInput.onchange = (e) => handleFiles(e.target.files);
        }

        async function handleFiles(files) {
            if (files.length === 0) return;
            const file = files[0];
            if (!file.name.endsWith('.csv')) {
                alert('Пожалуйста, выберите CSV файл');
                return;
            }

            fileStatus.textContent = `Загрузка: ${file.name}...`;
            fileStatus.style.display = 'block';
            fileStatus.style.color = 'var(--gray-500)';

            const formData = new FormData();
            formData.append('file', file);
            formData.append('code', authCode);

            try {
                const response = await fetch(`/api/tenders/invites/${token}/upload-csv`, {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    const res = await response.json();
                    fileStatus.textContent = `Файл загружен. Найдено позиций: ${res.itemCount}`;
                    fileStatus.style.color = 'var(--primary)';

                    showPrices = true; // Reveal prices after upload
                    renderEstimateDetails(activeEstimateId);

                    document.getElementById('total-price').value = res.totalPrice.toFixed(2);
                    showToast('Смета успешно обработана!');
                } else {
                    const err = await response.json();
                    throw new Error(err.error || 'Upload failed');
                }
            } catch (err) {
                console.error(err);
                fileStatus.textContent = `Ошибка: ${err.message}`;
                fileStatus.style.color = '#E11D48';
            }
        }

        async function saveBid(status = 'parsing') {
            const totalPrice = document.getElementById('total-price').value;
            const completionDays = document.getElementById('completion-days').value;

            if (!totalPrice || !completionDays) {
                alert('Пожалуйста, заполните сумму и срок выполнения');
                return;
            }

            try {
                const response = await fetch(`/api/tenders/invites/${token}/bid`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        code: authCode,
                        priceTotal: totalPrice,
                        completionDate: completionDays,
                        status: status
                    })
                });

                if (response.ok) {
                    showToast(status === 'parsed' ? 'Оферта успешно отправлена!' : 'Черновик сохранен');
                    if (status === 'parsed') {
                        document.getElementById('btn-submit').disabled = true;
                    }
                } else {
                    alert('Ошибка при сохранении');
                }
            } catch (err) {
                console.error(err);
                alert('Ошибка соединения');
            }
        }

        document.getElementById('btn-save').onclick = () => saveBid('parsing');
        document.getElementById('btn-submit').onclick = () => saveBid('parsed');
    </script>
</body>

</html>