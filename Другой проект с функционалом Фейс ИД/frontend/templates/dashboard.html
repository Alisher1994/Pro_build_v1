<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/mobile.css') }}">
    <style>
        /* –ö–∞—Å—Ç–æ–º–Ω—ã–π —Å–∫—Ä–æ–ª–ª–±–∞—Ä –¥–ª—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ */
        .tab-content-container::-webkit-scrollbar {
            width: 12px !important;
            height: 12px !important;
            background: transparent !important;
        }
        
        /* –¢–µ–º–Ω–∞—è —Ç–µ–º–∞ - —Å–∫—Ä–æ–ª–ª–±–∞—Ä */
        .tab-content-container::-webkit-scrollbar-track {
            background: rgba(30, 41, 59, 0.5) !important;
            border-radius: 12px !important;
            border: 1px solid rgba(51, 65, 85, 0.5) !important;
            margin: 8px 4px !important;
        }
        
        .tab-content-container::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
            border-radius: 12px !important;
            border: 2px solid rgba(30, 41, 59, 0.5) !important;
            min-height: 40px !important;
            box-shadow: inset 0 0 6px rgba(0, 0, 0, 0.2), 0 2px 4px rgba(0, 0, 0, 0.1) !important;
            transition: all 0.3s ease !important;
        }
        
        .tab-content-container::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #5568d3 0%, #6a3f91 100%) !important;
            border-color: rgba(51, 65, 85, 0.7) !important;
            box-shadow: inset 0 0 8px rgba(0, 0, 0, 0.3), 0 3px 6px rgba(0, 0, 0, 0.15) !important;
            transform: scale(1.05) !important;
        }
        
        /* –°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞ - —Å–∫—Ä–æ–ª–ª–±–∞—Ä */
        body.theme-light .tab-content-container::-webkit-scrollbar-track {
            background: #e5e7eb !important;
            border-radius: 12px !important;
            border: 1px solid #d1d5db !important;
            margin: 8px 4px !important;
        }
        
        body.theme-light .tab-content-container::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
            border-radius: 12px !important;
            border: 2px solid #e5e7eb !important;
            min-height: 40px !important;
            box-shadow: inset 0 0 6px rgba(0, 0, 0, 0.1), 0 2px 4px rgba(0, 0, 0, 0.1) !important;
            transition: all 0.3s ease !important;
        }
        
        body.theme-light .tab-content-container::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #5568d3 0%, #6a3f91 100%) !important;
            border-color: #cbd5e1 !important;
            box-shadow: inset 0 0 8px rgba(0, 0, 0, 0.2), 0 3px 6px rgba(0, 0, 0, 0.15) !important;
            transform: scale(1.05) !important;
        }
        
        /* –î–ª—è Firefox */
        .tab-content-container {
            scrollbar-width: thin !important;
            scrollbar-color: #667eea rgba(30, 41, 59, 0.5) !important;
        }
        
        body.theme-light .tab-content-container {
            scrollbar-width: thin !important;
            scrollbar-color: #667eea #e5e7eb !important;
        }
        
        .tab-content-container::-webkit-scrollbar-corner {
            background: transparent !important;
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω */
        body.theme-dark .modal-content {
            background: #1e293b !important;
            color: #e2e8f0 !important;
        }
        
        body.theme-dark .modal-title {
            color: #e2e8f0 !important;
        }
        
        body.theme-dark .modal-text {
            color: #94a3b8 !important;
        }
    </style>
    <style>
        /* –¢–µ–º–Ω—ã–π —Ñ–æ–Ω –¥–ª—è main-content */
        .game-main-content {
            background: var(--theme-bg-primary);
            min-height: 100vh;
            padding: 0 !important;
            margin-left: 280px !important;
            width: calc(100% - 280px) !important;
        }
        
        body.theme-light .game-main-content {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        }
        
        /* –ê–¥–∞–ø—Ç–∞—Ü–∏—è –ø—Ä–∏ —Å–≤–µ—Ä–Ω—É—Ç–æ–º sidebar */
        body:has(.sidebar.collapsed) .game-main-content,
        .sidebar.collapsed ~ .main-content.game-main-content {
            margin-left: 80px !important;
            width: calc(100% - 80px) !important;
        }
        
        /* –ò–≥—Ä–æ–≤–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Å—Ç–∏–ª–∏ */
        .game-layout {
            display: flex;
            flex-direction: column;
            gap: 0;
            height: 100vh;
            background: var(--theme-bg-primary);
            overflow: hidden;
            transition: background-color 0.3s ease;
        }
        
        body.theme-light .game-layout {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        }
        
        /* –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å —Å –≤–∫–ª–∞–¥–∫–∞–º–∏ */
        .game-top-bar {
            padding: 0;
            background: var(--theme-bg-secondary);
            border-bottom: 2px solid var(--theme-border);
            transition: background-color 0.3s ease, border-color 0.3s ease;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
        }
        
        .tabs {
            display: flex;
            gap: 0;
            margin: 0;
            border-bottom: none;
            background: var(--theme-bg-secondary);
            padding: 0 24px;
            height: 100%;
            align-items: stretch;
        }
        
        .tab {
            padding: 0 24px;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            color: var(--theme-text-tertiary);
            transition: all 0.3s;
            position: relative;
            display: flex;
            align-items: center;
            height: 100%;
            box-sizing: border-box;
        }
        
        .tab:hover {
            color: var(--theme-text-primary);
            background: var(--theme-bg-tertiary);
        }
        
        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
            background: var(--theme-bg-secondary);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç–∏ –≥—Ä—É–ø–ø */
        .group-accordion {
            margin-bottom: 20px;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            overflow: hidden;
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .group-accordion-header {
            padding: 18px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.3s;
        }
        
        .group-accordion-header:hover {
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
        }
        
        .group-accordion-header.active {
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
        }
        
        .group-header-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .group-title {
            font-size: 18px;
            font-weight: 600;
        }
        
        .group-stats {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .group-accordion-icon {
            font-size: 20px;
            transition: transform 0.3s;
        }
        
        .group-accordion-header.active .group-accordion-icon {
            transform: rotate(180deg);
        }
        
        .group-accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        
        .group-accordion-content.active {
            max-height: 5000px;
            transition: max-height 0.5s ease-in;
        }
        
        .students-grid-container {
            padding: 24px;
            background: #f8f9fa;
        }
        
        .students-grid {
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            gap: 15px;
        }
        
        .student-card {
            background: white;
            border-radius: 10px;
            padding: 12px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: transform 0.2s, box-shadow 0.2s;
            border: 2px solid transparent;
        }
        
        .student-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        .student-card.attended {
            border-color: #27ae60;
        }
        
        .student-card.not-attended {
            opacity: 0.6;
        }
        
        .student-photo {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            margin: 0 auto 8px;
            display: block;
            border: 2px solid #3498db;
        }
        
        .student-card.attended .student-photo {
            border-color: #27ae60;
        }
        
        .student-card.not-attended .student-photo {
            filter: grayscale(100%);
            border-color: #95a5a6;
        }
        
        .student-name {
            font-weight: 600;
            color: #2c3e50;
            font-size: 11px;
            margin-bottom: 3px;
            word-break: break-word;
        }
        
        .student-lastname {
            font-weight: 500;
            color: #7f8c8d;
            font-size: 12px;
            margin-bottom: 6px;
            word-break: break-word;
        }
        
        .student-checkin-time {
            font-size: 11px;
            color: #27ae60;
            font-weight: 600;
            margin-top: 6px;
        }
        
        .no-groups-message {
            text-align: center;
            padding: 60px 20px;
            color: #95a5a6;
            font-size: 16px;
        }
        
        .chart-container {
            width: 100%;
            max-width: 100%;
            overflow-x: auto;
            overflow-y: hidden;
            padding: 16px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-top: 12px;
            box-sizing: border-box;
        }
        
        body.theme-dark .chart-container {
            background: var(--theme-bg-secondary);
        }
        
        .chart-container canvas {
            max-width: 100%;
            width: 100%;
            height: 300px;
            display: block;
        }
        
        @media (max-width: 1400px) {
            .students-grid {
                grid-template-columns: repeat(8, 1fr);
            }
        }
        
        @media (max-width: 1200px) {
            .students-grid {
                grid-template-columns: repeat(6, 1fr);
            }
        }
        
        @media (max-width: 900px) {
            .students-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }
        
        @media (max-width: 600px) {
            .students-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }
    </style>
</head>
<body>
    {% include '_sidebar.html' %}

    <div class="main-content game-main-content">
        <!-- –ò–≥—Ä–æ–≤–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å -->
        <div class="game-layout">
            <!-- –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å —Å –≤–∫–ª–∞–¥–∫–∞–º–∏ -->
            <div class="game-top-bar">
                <div class="tabs">
                    <button class="tab active" data-tab="finances">üí∞ –ê–Ω–∞–ª–∏–∑ –ø–æ —Ñ–∏–Ω–∞–Ω—Å–∞–º</button>
                    <button class="tab" data-tab="finance-details">üìä –§–∏–Ω–∞–Ω—Å—ã –¥–µ—Ç–∞–ª—å–Ω—ã–π</button>
                    <button class="tab" data-tab="groups-attendance">üë• –ü–æ—Å–µ—â–∞–µ–º–æ—Å—Ç—å –≥—Ä—É–ø–ø</button>
                    <button class="tab" data-tab="rating">‚≠ê –†–µ–π—Ç–∏–Ω–≥ —É—á–µ–Ω–∏–∫–æ–≤</button>
                    <button class="tab" data-tab="rating-current-month">‚≠ê –†–µ–π—Ç–∏–Ω–≥ —É—á–µ–Ω–∏–∫–æ–≤ —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü</button>
                </div>
            </div>
            
            <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –≤–∫–ª–∞–¥–æ–∫ -->
            <div class="tab-content-container" style="flex: 1; overflow-y: auto; padding: 24px;">

        <!-- –í–∫–ª–∞–¥–∫–∞: –ê–Ω–∞–ª–∏–∑ –ø–æ —Ñ–∏–Ω–∞–Ω—Å–∞–º -->
        <div id="finances-tab" class="tab-content active">
            <div class="form-block" style="margin-top: 30px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3>üìà –§–∏–Ω–∞–Ω—Å—ã –ø–æ –º–µ—Å—è—Ü–∞–º</h3>
                    <div style="display: flex; gap: 12px; align-items: center;">
                        <label for="yearFilter" style="font-weight: 600; color: #475569;">–ì–æ–¥:</label>
                        <select id="yearFilter" style="padding: 8px 16px; border: 1px solid #e2e8f0; border-radius: 10px; font-size: 0.95rem; background: white; cursor: pointer;">
                            <!-- Years will be populated by JavaScript -->
                        </select>
                    </div>
                </div>
                <div class="month-grid">
                    {% set month_names = ['–Ø–Ω–≤–∞—Ä—å','–§–µ–≤—Ä–∞–ª—å','–ú–∞—Ä—Ç','–ê–ø—Ä–µ–ª—å','–ú–∞–π','–ò—é–Ω—å','–ò—é–ª—å','–ê–≤–≥—É—Å—Ç','–°–µ–Ω—Ç—è–±—Ä—å','–û–∫—Ç—è–±—Ä—å','–ù–æ—è–±—Ä—å','–î–µ–∫–∞–±—Ä—å'] %}
                    {% for i in range(12) %}
                    <div class="month-cell">
                        <div class="month-title">{{ month_names[i] }}</div>
                        <div class="bars" data-month-index="{{ i }}">
                            <div class="bar income" title="–ü—Ä–∏—Ö–æ–¥"><span class="bar-value"></span></div>
                            <div class="bar expense" title="–†–∞—Å—Ö–æ–¥"><span class="bar-value"></span></div>
                            <div class="bar balance" title="–û—Å—Ç–∞—Ç–æ–∫"><span class="bar-value"></span></div>
                        </div>
                        <div class="legend">
                            <span class="legend-item income">–ü—Ä–∏—Ö–æ–¥</span>
                            <span class="legend-item expense">–†–∞—Å—Ö–æ–¥</span>
                            <span class="legend-item balance">–û—Å—Ç–∞—Ç–æ–∫</span>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            
            <!-- –ë–ª–æ–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ -->
            <div class="stats-grid" style="margin-top: 40px;">
                <div class="stat-card">
                    <h3>–í—Å–µ–≥–æ —É—á–µ–Ω–∏–∫–æ–≤</h3>
                    <p class="stat-number">{{ total_students }}</p>
                </div>
                
                <div class="stat-card warning">
                    <h3>–ú–∞–ª–æ –∑–∞–Ω—è—Ç–∏–π</h3>
                    <p class="stat-number">{{ students_low_balance }}</p>
                </div>
                
                <div class="stat-card">
                    <h3>–°–µ–≥–æ–¥–Ω—è –Ω–∞ –∑–∞–Ω—è—Ç–∏–∏</h3>
                    <p class="stat-number">{{ today_attendance }}</p>
                </div>
                
                <div class="stat-card success">
                    <h3>–î–æ—Ö–æ–¥ (–º–µ—Å—è—Ü)</h3>
                    <p class="stat-number">{{ "%.0f"|format(month_income) }} —Å—É–º</p>
                </div>
                
                <div class="stat-card danger">
                    <h3>–†–∞—Å—Ö–æ–¥—ã (–º–µ—Å—è—Ü)</h3>
                    <p class="stat-number">{{ "%.0f"|format(month_expenses) }} —Å—É–º</p>
                </div>
                
                <div class="stat-card {% if profit >= 0 %}success{% else %}danger{% endif %}">
                    <h3>–ü—Ä–∏–±—ã–ª—å (–º–µ—Å—è—Ü)</h3>
                    <p class="stat-number">{{ "%.0f"|format(profit) }} —Å—É–º</p>
                </div>
            </div>
        </div>

        <!-- –í–∫–ª–∞–¥–∫–∞: –§–∏–Ω–∞–Ω—Å—ã –¥–µ—Ç–∞–ª—å–Ω—ã–π -->
        <div id="finance-details-tab" class="tab-content">
            <h2 style="margin-top: 0; margin-bottom: 16px; font-size: 20px;">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ –º–µ—Å—è—Ü–∞–º</h2>
            
            <table class="data-table" style="margin-bottom: 16px;">
                <thead>
                    <tr>
                        <th>–ú–µ—Å—è—Ü</th>
                        <th>–ü—Ä–∏—Ö–æ–¥</th>
                        <th>–†–∞—Å—Ö–æ–¥</th>
                        <th>–û—Å—Ç–∞—Ç–æ–∫</th>
                    </tr>
                </thead>
                <tbody id="analytics-table-body">
                    <!-- –ó–∞–ø–æ–ª–Ω–∏—Ç—Å—è —á–µ—Ä–µ–∑ JS -->
                </tbody>
            </table>
            
            <div class="chart-container">
                <canvas id="financeChart" width="400" height="150"></canvas>
            </div>
        </div>

        <!-- –í–∫–ª–∞–¥–∫–∞: –ü–æ—Å–µ—â–∞–µ–º–æ—Å—Ç—å –≥—Ä—É–ø–ø -->
        <div id="groups-attendance-tab" class="tab-content">
            <div class="form-block" style="margin-top: 30px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;">
                    <h3>üë• –ü–æ—Å–µ—â–∞–µ–º–æ—Å—Ç—å –≥—Ä—É–ø–ø</h3>
                    <div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
                        <label for="attendanceDateYear" style="font-weight: 600; color: #475569;">–ì–æ–¥:</label>
                        <select id="attendanceDateYear" style="padding: 8px 16px; border: 1px solid #e2e8f0; border-radius: 10px; font-size: 0.95rem; background: white; cursor: pointer;">
                            <!-- Years will be populated by JavaScript -->
                        </select>
                        <label for="attendanceDateMonth" style="font-weight: 600; color: #475569;">–ú–µ—Å—è—Ü:</label>
                        <select id="attendanceDateMonth" style="padding: 8px 16px; border: 1px solid #e2e8f0; border-radius: 10px; font-size: 0.95rem; background: white; cursor: pointer;">
                            <!-- Months will be populated by JavaScript -->
                        </select>
                        <label for="attendanceDateDay" style="font-weight: 600; color: #475569;">–î–µ–Ω—å:</label>
                        <select id="attendanceDateDay" style="padding: 8px 16px; border: 1px solid #e2e8f0; border-radius: 10px; font-size: 0.95rem; background: white; cursor: pointer;">
                            <!-- Days will be populated by JavaScript -->
                        </select>
                    </div>
                </div>
                
                <div id="groupsAttendanceContent">
                    <!-- –ó–∞–ø–æ–ª–Ω–∏—Ç—Å—è —á–µ—Ä–µ–∑ JS -->
                </div>
            </div>
        </div>

        <!-- –í–∫–ª–∞–¥–∫–∞: –†–µ–π—Ç–∏–Ω–≥ —É—á–µ–Ω–∏–∫–æ–≤ -->
        <div id="rating-tab" class="tab-content">
            <div class="form-block" style="margin-top: 30px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3>‚≠ê –ò—Å—Ç–æ—Ä–∏—è –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π (1 –º–µ—Å—Ç–æ)</h3>
                    <div style="display: flex; gap: 12px; align-items: center;">
                        <label for="ratingYearFilter" style="font-weight: 600; color: #475569;">–ì–æ–¥:</label>
                        <select id="ratingYearFilter" style="padding: 8px 16px; border: 1px solid #e2e8f0; border-radius: 10px; font-size: 0.95rem; background: white; cursor: pointer;">
                            <!-- Years will be populated by JavaScript -->
                        </select>
                    </div>
                </div>
                
                <div id="winnersHistoryContent">
                    <!-- –ó–∞–ø–æ–ª–Ω–∏—Ç—Å—è —á–µ—Ä–µ–∑ JS -->
                </div>
            </div>
        </div>

        <!-- –í–∫–ª–∞–¥–∫–∞: –†–µ–π—Ç–∏–Ω–≥ —É—á–µ–Ω–∏–∫–æ–≤ —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü -->
        <div id="rating-current-month-tab" class="tab-content">
            <div class="form-block" style="margin-top: 30px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3>‚≠ê –†–µ–π—Ç–∏–Ω–≥ —É—á–µ–Ω–∏–∫–æ–≤ —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü</h3>
                </div>
                
                <div id="currentMonthRatingContent" style="text-align: center; padding: 10px; color: #95a5a6;">
                    <p>–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–π—Ç–∏–Ω–≥–∞...</p>
                </div>
            </div>
        </div>
    </div>
    <script>
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ —Å –ø—Ä–æ–∫—Ä—É—Ç–∫–æ–π
    function getScrollContainer() {
        return document.querySelector('.tab-content-container');
    }
    
    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫
    document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', () => {
            const tabName = tab.getAttribute('data-tab');
            
            // –£–±—Ä–∞—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —Å–æ –≤—Å–µ—Ö –≤–∫–ª–∞–¥–æ–∫
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
            
            // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–∫—Ä—É—Ç–∫–æ–π: –æ—Ç–∫–ª—é—á–∞–µ–º –¥–ª—è –≤–∫–ª–∞–¥–∫–∏ finances, –≤–∫–ª—é—á–∞–µ–º –¥–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö
            const scrollContainer = getScrollContainer();
            if (scrollContainer) {
                if (tabName === 'finances') {
                    scrollContainer.style.overflowY = 'hidden';
                    scrollContainer.style.overflow = 'hidden';
                } else {
                    scrollContainer.style.overflowY = 'auto';
                    scrollContainer.style.overflow = 'auto';
                }
            }
            
            // –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—É—é –≤–∫–ª–∞–¥–∫—É
            tab.classList.add('active');
            const tabElement = document.getElementById(`${tabName}-tab`);
            if (tabElement) {
                tabElement.classList.add('active');
                
                // –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –Ω–∞ –≤–∫–ª–∞–¥–∫—É —Ä–µ–π—Ç–∏–Ω–≥–∞
                if (tabName === 'rating') {
                    setTimeout(() => {
                        const year = parseInt(ratingYearFilter.value);
                        loadWinnersHistory(year);
                    }, 100);
                }
                
                // –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ä–µ–π—Ç–∏–Ω–≥ —Ç–µ–∫—É—â–µ–≥–æ –º–µ—Å—è—Ü–∞ –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –Ω–∞ –≤–∫–ª–∞–¥–∫—É
                if (tabName === 'rating-current-month') {
                    setTimeout(() => {
                        loadCurrentMonthRating();
                    }, 100);
                }
                
                // –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç–∏ –≥—Ä—É–ø–ø –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –Ω–∞ –≤–∫–ª–∞–¥–∫—É
                if (tabName === 'groups-attendance') {
                    setTimeout(() => {
                        loadGroupsAttendance();
                    }, 100);
                }
                
                // –ó–∞–≥—Ä—É–∑–∏—Ç—å –∞–Ω–∞–ª–∏—Ç–∏–∫—É —Ñ–∏–Ω–∞–Ω—Å–æ–≤ –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –Ω–∞ –≤–∫–ª–∞–¥–∫—É
                if (tabName === 'finance-details') {
                    setTimeout(() => {
                        loadAnalytics();
                    }, 100);
                }
            }
        });
    });
    
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –¥–ª—è –∞–∫—Ç–∏–≤–Ω–æ–π –≤–∫–ª–∞–¥–∫–∏
    document.addEventListener('DOMContentLoaded', () => {
        const scrollContainer = getScrollContainer();
        if (scrollContainer) {
            const activeTab = document.querySelector('.tab.active');
            if (activeTab) {
                const tabName = activeTab.getAttribute('data-tab');
                if (tabName === 'finances') {
                    scrollContainer.style.overflowY = 'hidden';
                    scrollContainer.style.overflow = 'hidden';
                }
            }
        }
    });
    
    // –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ —Ñ–∏–Ω–∞–Ω—Å–æ–≤
    async function loadAnalytics() {
        try {
            const response = await fetch('/api/finances/analytics');
            const data = await response.json();
            
            // –¢–∞–±–ª–∏—Ü–∞
            const tbody = document.getElementById('analytics-table-body');
            if (!tbody) return;
            
            if (data.months.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #95a5a6;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>';
                return;
            }
            
            // –ü–æ–¥—Å—á—ë—Ç –∏—Ç–æ–≥–æ–≤
            const totalIncome = data.months.reduce((acc, m) => acc + Number(m.income || 0), 0);
            const totalExpense = data.months.reduce((acc, m) => acc + Number(m.expense || 0), 0);
            const totalBalance = totalIncome - totalExpense;

            const rows = data.months.map(m => {
                const balance = m.income - m.expense;
                const balanceColor = balance >= 0 ? '#27ae60' : '#e74c3c';
                
                return `
                    <tr>
                        <td><strong>${m.month_name}</strong></td>
                        <td style="color: #27ae60;">${m.income.toLocaleString('ru-RU')} —Å—É–º</td>
                        <td style="color: #e74c3c;">${m.expense.toLocaleString('ru-RU')} —Å—É–º</td>
                        <td style="color: ${balanceColor}; font-weight: bold;">
                            ${balance >= 0 ? '+' : ''}${balance.toLocaleString('ru-RU')} —Å—É–º
                        </td>
                    </tr>
                `;
            }).join('');

            const totalRow = `
                <tr style="background: #f8f9fa; font-weight: bold;">
                    <td>–ò—Ç–æ–≥–æ –∑–∞ 12 –º–µ—Å.</td>
                    <td style="color: #27ae60;">${totalIncome.toLocaleString('ru-RU')} —Å—É–º</td>
                    <td style="color: #e74c3c;">${totalExpense.toLocaleString('ru-RU')} —Å—É–º</td>
                    <td style="color: ${totalBalance >= 0 ? '#27ae60' : '#e74c3c'};">
                        ${totalBalance >= 0 ? '+' : ''}${totalBalance.toLocaleString('ru-RU')} —Å—É–º
                    </td>
                </tr>
            `;

            tbody.innerHTML = rows + totalRow;
            
            // –ì—Ä–∞—Ñ–∏–∫
            drawSimpleChart(data.months);
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏:', error);
        }
    }

    // –ü—Ä–æ—Å—Ç–æ–π –≥—Ä–∞—Ñ–∏–∫ –Ω–∞ Canvas
    function drawSimpleChart(months) {
        const canvas = document.getElementById('financeChart');
        if (!canvas) return;
        
        // –ü–æ–ª—É—á–∞–µ–º —Ä–µ–∞–ª—å–Ω—É—é —à–∏—Ä–∏–Ω—É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
        const container = canvas.parentElement;
        const containerWidth = container ? container.clientWidth : 800;
        
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä—ã canvas —Å —É—á–µ—Ç–æ–º DPI
        const dpr = window.devicePixelRatio || 1;
        canvas.width = containerWidth * dpr;
        canvas.height = 300 * dpr;
        canvas.style.width = containerWidth + 'px';
        canvas.style.height = '300px';
        
        const ctx = canvas.getContext('2d');
        ctx.scale(dpr, dpr);
        
        // –û—á–∏—â–∞–µ–º canvas
        ctx.clearRect(0, 0, containerWidth, 300);
        
        if (months.length === 0) {
            ctx.fillStyle = '#95a5a6';
            ctx.font = '16px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è', containerWidth / 2, 150);
            return;
        }
        
        const leftPadding = 60;
        const rightPadding = 20;
        const topPadding = 40;
        const bottomPadding = 45; // –ú–µ—Å—Ç–æ –¥–ª—è –ø–æ–¥–ø–∏—Å–µ–π –º–µ—Å—è—Ü–µ–≤
        const chartWidth = containerWidth - leftPadding - rightPadding;
        const chartHeight = 300 - topPadding - bottomPadding;
        
        const maxValueRaw = Math.max(...months.map(m => Math.max(m.income || 0, m.expense || 0)));
        const maxValue = maxValueRaw > 0 ? maxValueRaw : 1;
        
        // –†–∞—Å—á–µ—Ç: –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –º–µ—Å—è—Ü–∞ 2 —Å—Ç–æ–ª–±—Ü–∞ (–ø—Ä–∏—Ö–æ–¥ + —Ä–∞—Å—Ö–æ–¥) + –ø—Ä–æ–º–µ–∂—É—Ç–æ–∫ –º–µ–∂–¥—É –≥—Ä—É–ø–ø–∞–º–∏
        const barsPerMonth = 2;
        const gapBetweenBars = 4; // –ü—Ä–æ–º–µ–∂—É—Ç–æ–∫ –º–µ–∂–¥—É —Å—Ç–æ–ª–±—Ü–∞–º–∏ –ø—Ä–∏—Ö–æ–¥–∞ –∏ —Ä–∞—Å—Ö–æ–¥–∞
        const gapBetweenMonthGroups = Math.max(8, chartWidth / (months.length * 20)); // –ü—Ä–æ–º–µ–∂—É—Ç–æ–∫ –º–µ–∂–¥—É –≥—Ä—É–ø–ø–∞–º–∏ –º–µ—Å—è—Ü–µ–≤
        
        // –î–æ—Å—Ç—É–ø–Ω–∞—è —à–∏—Ä–∏–Ω–∞ –¥–ª—è —Å—Ç–æ–ª–±—Ü–æ–≤
        const totalGapsWidth = (months.length - 1) * gapBetweenMonthGroups;
        const availableWidth = chartWidth - totalGapsWidth;
        const barWidth = Math.max(8, (availableWidth / (months.length * barsPerMonth)) - gapBetweenBars);
        
        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Å—Ç–æ–ª–±—Ü–æ–≤
        months.forEach((m, i) => {
            // –ü–æ–∑–∏—Ü–∏—è –Ω–∞—á–∞–ª–∞ –≥—Ä—É–ø–ø—ã —Å—Ç–æ–ª–±—Ü–æ–≤ –¥–ª—è –º–µ—Å—è—Ü–∞
            const groupWidth = barWidth * barsPerMonth + gapBetweenBars;
            const groupStartX = leftPadding + i * (groupWidth + gapBetweenMonthGroups);
            const groupCenterX = groupStartX + groupWidth / 2;
            
            // –ü—Ä–∏—Ö–æ–¥ (–∑–µ–ª—ë–Ω—ã–π) - –ª–µ–≤—ã–π —Å—Ç–æ–ª–±–µ—Ü
            const incomeHeight = ((m.income || 0) / maxValue) * chartHeight;
            if (incomeHeight > 0) {
                ctx.fillStyle = '#27ae60';
                ctx.fillRect(groupStartX, topPadding + chartHeight - incomeHeight, barWidth, incomeHeight);
            }
            
            // –†–∞—Å—Ö–æ–¥ (–∫—Ä–∞—Å–Ω—ã–π) - –ø—Ä–∞–≤—ã–π —Å—Ç–æ–ª–±–µ—Ü
            const expenseHeight = ((m.expense || 0) / maxValue) * chartHeight;
            if (expenseHeight > 0) {
                ctx.fillStyle = '#e74c3c';
                ctx.fillRect(groupStartX + barWidth + gapBetweenBars, topPadding + chartHeight - expenseHeight, barWidth, expenseHeight);
            }
            
            // –ü–æ–¥–ø–∏—Å—å –º–µ—Å—è—Ü–∞ (–ø–æ–¥ –≥—Ä—É–ø–ø–æ–π —Å—Ç–æ–ª–±—Ü–æ–≤)
            ctx.fillStyle = '#2c3e50';
            ctx.font = '10px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'top';
            const monthText = m.month_name || '';
            ctx.fillText(monthText, groupCenterX, topPadding + chartHeight + 8);
        });
        
        // –õ–µ–≥–µ–Ω–¥–∞ –≤–≤–µ—Ä—Ö—É
        const legendY = 15;
        ctx.fillStyle = '#27ae60';
        ctx.fillRect(leftPadding, legendY, 18, 12);
        ctx.fillStyle = '#2c3e50';
        ctx.font = '13px Arial';
        ctx.textAlign = 'left';
        ctx.textBaseline = 'middle';
        ctx.fillText('–ü—Ä–∏—Ö–æ–¥', leftPadding + 23, legendY + 6);
        
        ctx.fillStyle = '#e74c3c';
        ctx.fillRect(leftPadding + 90, legendY, 18, 12);
        ctx.fillText('–†–∞—Å—Ö–æ–¥', leftPadding + 113, legendY + 6);
    }
    
    // Populate year filter
    const currentYear = new Date().getFullYear();
    const currentMonth = new Date().getMonth() + 1;
    const currentDay = new Date().getDate();
    
    const yearFilter = document.getElementById('yearFilter');
    const ratingYearFilter = document.getElementById('ratingYearFilter');
    const attendanceDateYear = document.getElementById('attendanceDateYear');
    const attendanceDateMonth = document.getElementById('attendanceDateMonth');
    const attendanceDateDay = document.getElementById('attendanceDateDay');
    
    // –ó–∞–ø–æ–ª–Ω—è–µ–º –≥–æ–¥—ã
    for (let year = currentYear; year >= currentYear - 5; year--) {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year;
        if (year === currentYear) option.selected = true;
        yearFilter.appendChild(option);
        
        const option2 = document.createElement('option');
        option2.value = year;
        option2.textContent = year;
        if (year === currentYear) option2.selected = true;
        ratingYearFilter.appendChild(option2);
        
        const option3 = document.createElement('option');
        option3.value = year;
        option3.textContent = year;
        if (year === currentYear) option3.selected = true;
        attendanceDateYear.appendChild(option3);
    }
    
    // –ó–∞–ø–æ–ª–Ω—è–µ–º –º–µ—Å—è—Ü—ã
    const monthNames = ['–Ø–Ω–≤–∞—Ä—å', '–§–µ–≤—Ä–∞–ª—å', '–ú–∞—Ä—Ç', '–ê–ø—Ä–µ–ª—å', '–ú–∞–π', '–ò—é–Ω—å', 
                       '–ò—é–ª—å', '–ê–≤–≥—É—Å—Ç', '–°–µ–Ω—Ç—è–±—Ä—å', '–û–∫—Ç—è–±—Ä—å', '–ù–æ—è–±—Ä—å', '–î–µ–∫–∞–±—Ä—å'];
    for (let month = 1; month <= 12; month++) {
        const option = document.createElement('option');
        option.value = month;
        option.textContent = monthNames[month - 1];
        if (month === currentMonth) option.selected = true;
        attendanceDateMonth.appendChild(option);
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –¥–Ω–µ–π –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –º–µ—Å—è—Ü–∞ –∏ –≥–æ–¥–∞
    function populateDays(year, month) {
        attendanceDateDay.innerHTML = '';
        const daysInMonth = new Date(year, month, 0).getDate();
        for (let day = 1; day <= daysInMonth; day++) {
            const option = document.createElement('option');
            option.value = day;
            option.textContent = day;
            if (day === currentDay && month === currentMonth && year === currentYear) {
                option.selected = true;
            }
            attendanceDateDay.appendChild(option);
        }
    }
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –¥–Ω–∏
    populateDays(currentYear, currentMonth);
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –¥–Ω–∏ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –≥–æ–¥–∞ –∏–ª–∏ –º–µ—Å—è—Ü–∞
    attendanceDateYear.addEventListener('change', () => {
        const year = parseInt(attendanceDateYear.value);
        const month = parseInt(attendanceDateMonth.value);
        populateDays(year, month);
        loadGroupsAttendance();
    });
    
    attendanceDateMonth.addEventListener('change', () => {
        const year = parseInt(attendanceDateYear.value);
        const month = parseInt(attendanceDateMonth.value);
        populateDays(year, month);
        loadGroupsAttendance();
    });
    
    attendanceDateDay.addEventListener('change', () => {
        loadGroupsAttendance();
    });

    // Fetch and render monthly finance data
    async function loadFinances(year) {
        try {
            const res = await fetch(`/api/finances/monthly?year=${year}`);
            if (!res.ok) return;
            const data = await res.json();
            if (!data || !Array.isArray(data.months)) return;
            const months = data.months;
            const maxVal = Math.max(1, ...months.flatMap(m => [m.income||0, m.expense||0, m.balance||0]));
            
            // Render each month
            document.querySelectorAll('.bars').forEach((barsEl, idx) => {
                const m = months[idx] || { income: 0, expense: 0, balance: 0 };
                const items = [
                    { cls: '.income', val: m.income || 0 },
                    { cls: '.expense', val: m.expense || 0 },
                    { cls: '.balance', val: m.balance || 0 }
                ];
                items.forEach(item => {
                    const bar = barsEl.querySelector(item.cls);
                    if (bar) {
                        const pct = Math.min(100, Math.round((item.val / maxVal) * 100));
                        bar.style.height = pct + '%';
                        const valEl = bar.querySelector('.bar-value');
                        if (valEl) {
                            valEl.textContent = item.val ? new Intl.NumberFormat('ru-RU').format(item.val) : '';
                        }
                    }
                });
            });
        } catch (e) {
            console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∏–Ω–∞–Ω—Å—ã –ø–æ –º–µ—Å—è—Ü–∞–º', e);
        }
    }

    // Load initial data
    loadFinances(currentYear);

    // Reload on year change
    yearFilter.addEventListener('change', (e) => {
        loadFinances(parseInt(e.target.value));
    });

    // –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π
    async function loadWinnersHistory(year) {
        try {
            const res = await fetch(`/api/rating/winners-history?year=${year}`);
            if (!res.ok) {
                document.getElementById('winnersHistoryContent').innerHTML = '<p style="text-align: center; padding: 40px; color: #95a5a6;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</p>';
                return;
            }
            const data = await res.json();
            
            if (!data.groups || data.groups.length === 0) {
                document.getElementById('winnersHistoryContent').innerHTML = '<p style="text-align: center; padding: 40px; color: #95a5a6;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</p>';
                return;
            }
            
            renderWinnersHistory(data.groups, data.year);
        } catch (e) {
            console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π', e);
            document.getElementById('winnersHistoryContent').innerHTML = '<p style="text-align: center; padding: 40px; color: #e74c3c;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</p>';
        }
    }

    // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π
    function renderWinnersHistory(groups, year) {
        const container = document.getElementById('winnersHistoryContent');
        const monthNames = ['–Ø–Ω–≤–∞—Ä—å', '–§–µ–≤—Ä–∞–ª—å', '–ú–∞—Ä—Ç', '–ê–ø—Ä–µ–ª—å', '–ú–∞–π', '–ò—é–Ω—å', '–ò—é–ª—å', '–ê–≤–≥—É—Å—Ç', '–°–µ–Ω—Ç—è–±—Ä—å', '–û–∫—Ç—è–±—Ä—å', '–ù–æ—è–±—Ä—å', '–î–µ–∫–∞–±—Ä—å'];
        const medals = ['ü•á', 'ü•à', 'ü•â'];
        
        let html = '';
        
        groups.forEach(group => {
            html += `
                <div style="background: white; padding: 25px; border-radius: 12px; margin-bottom: 30px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <h4 style="margin-bottom: 20px; color: #1a202c; font-size: 20px; border-bottom: 2px solid #e0e0e0; padding-bottom: 10px;">
                        üë®‚Äçüë©‚Äçüë¶ ${group.group_name}
                    </h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 12px; overflow-x: visible;">
            `;
            
            group.winners.forEach(winner => {
                const monthName = monthNames[winner.month - 1];
                
                if (winner.is_empty || !winner.students || winner.students.length === 0) {
                    html += `
                        <div style="text-align: center; padding: 10px; border: 2px dashed #e0e0e0; border-radius: 10px; background: #f8f9fa; min-width: 90px;">
                            <div style="font-size: 11px; color: #95a5a6; margin-bottom: 8px; font-weight: 600;">${monthName}</div>
                            <div style="font-size: 20px; color: #cbd5e0;">-</div>
                            <div style="font-size: 10px; color: #95a5a6; margin-top: 5px;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>
                        </div>
                    `;
                } else {
                    html += `
                        <div style="text-align: center; padding: 10px; border: 2px solid #f39c12; border-radius: 10px; background: linear-gradient(135deg, #fffbf0 0%, #fff9e6 100%); min-width: 90px;">
                            <div style="font-size: 11px; color: #856404; margin-bottom: 10px; font-weight: 600;">${monthName}</div>
                            <div style="display: flex; flex-direction: column; gap: 10px;">
                    `;
                    
                    winner.students.forEach((student, index) => {
                        const photoUrl = student.photo_path ? 
                            `/static/${student.photo_path.replace('frontend/static/', '').replace(/\\/g, '/')}` : 
                            null;
                        const medal = medals[index] || '‚≠ê';
                        const placeholderId = `placeholder-${group.group_id}-${winner.month}-${index}`;
                        
                        html += `
                            <div style="position: relative;">
                                <div style="position: absolute; top: -8px; left: 50%; transform: translateX(-50%); font-size: 20px; z-index: 10;">${medal}</div>
                                ${photoUrl ? 
                                    `<img src="${photoUrl}" alt="${student.full_name}" style="width: 35px; height: 35px; border-radius: 50%; object-fit: cover; border: 2px solid #f39c12; margin: 6px auto 4px; display: block; box-shadow: 0 2px 4px rgba(243,156,18,0.3);" onerror="document.getElementById('${placeholderId}').style.display='flex'; this.style.display='none';">` : 
                                    ''
                                }
                                <div id="${placeholderId}" style="width: 35px; height: 35px; border-radius: 50%; margin: 6px auto 4px; display: ${photoUrl ? 'none' : 'flex'}; align-items: center; justify-content: center; background: #ffe69c; font-size: 14px; border: 2px solid #f39c12; box-shadow: 0 2px 4px rgba(243,156,18,0.3);">üë§</div>
                                <div style="font-weight: bold; color: #2c3e50; font-size: 9px; margin-bottom: 2px; word-wrap: break-word; line-height: 1.2; max-height: 28px; overflow: hidden; text-overflow: ellipsis;">${student.full_name}</div>
                                <div style="font-size: 11px; color: #f39c12; font-weight: bold;">‚≠ê ${student.points}</div>
                            </div>
                        `;
                    });
                    
                    html += `
                            </div>
                        </div>
                    `;
                }
            });
            
            html += `
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = html;
    }

    // Reload on year change –¥–ª—è —Ä–µ–π—Ç–∏–Ω–≥–∞
    if (ratingYearFilter) {
        ratingYearFilter.addEventListener('change', (e) => {
            loadWinnersHistory(parseInt(e.target.value));
        });
    }
    
    // –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç–∏ –≥—Ä—É–ø–ø
    async function loadGroupsAttendance() {
        try {
            const year = parseInt(attendanceDateYear.value);
            const month = parseInt(attendanceDateMonth.value);
            const day = parseInt(attendanceDateDay.value);
            
            const res = await fetch(`/api/attendance/groups-statistics?year=${year}&month=${month}&day=${day}`);
            if (!res.ok) {
                document.getElementById('groupsAttendanceContent').innerHTML = 
                    '<div class="no-groups-message">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</div>';
                return;
            }
            
            const data = await res.json();
            renderGroupsAttendance(data);
        } catch (e) {
            console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç–∏ –≥—Ä—É–ø–ø', e);
            document.getElementById('groupsAttendanceContent').innerHTML = 
                '<div class="no-groups-message">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</div>';
        }
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è HTML
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è HTML
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Å—Ç—Ä–æ–∫–∏ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ JavaScript (–≤ –∞—Ç—Ä–∏–±—É—Ç–∞—Ö onclick –∏ —Ç.–¥.)
    function escapeJsString(str) {
        if (!str) return '';
        return String(str)
            .replace(/\\/g, '\\\\')
            .replace(/'/g, "\\'")
            .replace(/"/g, '\\"')
            .replace(/\n/g, '\\n')
            .replace(/\r/g, '\\r')
            .replace(/\t/g, '\\t');
    }
    
    // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç–∏ –≥—Ä—É–ø–ø
    function renderGroupsAttendance(data) {
        const container = document.getElementById('groupsAttendanceContent');
        
        if (!data.groups || data.groups.length === 0) {
            container.innerHTML = '<div class="no-groups-message">–ù–∞ –≤—ã–±—Ä–∞–Ω–Ω—É—é –¥–∞—Ç—É –Ω–µ—Ç –∑–∞–Ω—è—Ç–∏–π</div>';
            return;
        }
        
        let html = '';
        let firstGroup = true;
        
        data.groups.forEach((group, index) => {
            const isActive = firstGroup;
            firstGroup = false;
            
            html += `
                <div class="group-accordion">
                    <div class="group-accordion-header ${isActive ? 'active' : ''}" data-group-id="${group.group_id}">
                        <div class="group-header-info">
                            <div>
                                <div class="group-title">${group.group_name}</div>
                                <div class="group-stats">
                                    –ü—Ä–∏—à–ª–æ: ${group.attended_count} –∏–∑ ${group.total_students} —É—á–µ–Ω–∏–∫–æ–≤
                                    ${group.schedule_time ? ` ‚Ä¢ –í—Ä–µ–º—è: ${group.schedule_time}` : ''}
                                </div>
                            </div>
                        </div>
                        <div class="group-accordion-icon">‚ñº</div>
                    </div>
                    <div class="group-accordion-content ${isActive ? 'active' : ''}">
                        <div class="students-grid-container">
                            <div class="students-grid">
            `;
            
            if (group.students.length === 0) {
                html += `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #95a5a6;">
                        –í —ç—Ç–æ–π –≥—Ä—É–ø–ø–µ –Ω–µ—Ç —É—á–µ–Ω–∏–∫–æ–≤
                    </div>
                `;
            } else {
                group.students.forEach(student => {
                    // –õ–æ–≥–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ —É—á–µ–Ω–∏–∫–∞ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
                    console.log('–û–±—Ä–∞–±–æ—Ç–∫–∞ —É—á–µ–Ω–∏–∫–∞:', {
                        id: student.id,
                        full_name: student.full_name,
                        has_attended: student.has_attended,
                        attendance_id: student.attendance_id,
                        check_in_time: student.check_in_time
                    });
                    
                    let photoUrl = null;
                    if (student.photo_path) {
                        // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ä–∞–∑–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã –ø—É—Ç–µ–π
                        let path = student.photo_path.replace(/\\/g, '/');
                        if (path.startsWith('frontend/static/')) {
                            path = path.replace('frontend/static/', '');
                        } else if (path.startsWith('static/')) {
                            path = path.replace('static/', '');
                        } else if (!path.startsWith('/')) {
                            // –ï—Å–ª–∏ –ø—É—Ç—å –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π, –¥–æ–±–∞–≤–ª—è–µ–º static/
                            path = path;
                        }
                        photoUrl = `/static/${path}`;
                    }
                    
                    const cardClass = student.has_attended ? 'attended' : 'not-attended';
                    let checkInTime = '';
                    let isLate = student.is_late || false;
                    if (student.check_in_time) {
                        try {
                            checkInTime = new Date(student.check_in_time).toLocaleTimeString('ru-RU', { 
                                hour: '2-digit', 
                                minute: '2-digit' 
                            });
                        } catch (e) {
                            console.warn('–û—à–∏–±–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏:', e);
                        }
                    }
                    
                    const placeholderId = `photo-placeholder-${student.id}-${group.group_id}`;
                    const year = parseInt(attendanceDateYear.value);
                    const month = parseInt(attendanceDateMonth.value);
                    const day = parseInt(attendanceDateDay.value);
                    
                    // –ü—Ä–∞–≤–∏–ª—å–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º attendance_id (–º–æ–∂–µ—Ç –±—ã—Ç—å null, undefined –∏–ª–∏ —á–∏—Å–ª–æ–º)
                    const attendanceId = (student.attendance_id !== null && student.attendance_id !== undefined) ? student.attendance_id : null;
                    
                    console.log('–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∫–Ω–æ–ø–∫–∏:', {
                        attendanceId,
                        studentId: student.id,
                        studentName: student.full_name
                    });
                    
                    html += `
                        <div class="student-card ${cardClass}">
                            ${photoUrl ? 
                                `<img src="${photoUrl}" alt="${student.full_name}" class="student-photo" onerror="document.getElementById('${placeholderId}').style.display='flex'; this.style.display='none';">` :
                                ''
                            }
                            <div id="${placeholderId}" class="student-photo photo-placeholder" style="background: #e0e0e0; display: ${photoUrl ? 'none' : 'flex'}; align-items: center; justify-content: center; font-size: 20px; border-radius: 50%; width: 50px; height: 50px; margin: 0 auto 8px; border: 2px solid ${student.has_attended ? '#27ae60' : '#95a5a6'};">üë§</div>
                            <div class="student-name">${escapeHtml(student.first_name)}</div>
                            ${student.last_name ? `<div class="student-lastname">${escapeHtml(student.last_name)}</div>` : ''}
                            ${student.has_attended ? 
                                `
                                ${checkInTime ? `<div class="student-checkin-time" style="color: ${isLate ? '#e74c3c' : '#27ae60'}; font-weight: 600; margin-bottom: 8px;">${checkInTime}</div>` : '<div style="font-size: 11px; color: #27ae60; margin-top: 6px; font-weight: 500; margin-bottom: 8px;">–ü—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç</div>'}
                                <button class="remove-attendance-btn" 
                                        onclick="confirmRemoveAttendance(${student.id}, '${escapeJsString(student.full_name)}', ${attendanceId !== null ? attendanceId : 'null'}, ${year}, ${month}, ${day})"
                                        style="
                                            background: linear-gradient(135deg, #f87171 0%, #ef4444 100%);
                                            color: white;
                                            border: none;
                                            border-radius: 8px;
                                            padding: 8px 16px;
                                            font-size: 12px;
                                            font-weight: 600;
                                            cursor: pointer;
                                            transition: all 0.2s ease;
                                            width: 100%;
                                        "
                                        onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(248, 113, 113, 0.4)';"
                                        onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                                    –û—Ç–º–µ–Ω–∏—Ç—å
                                </button>
                                ` : 
                                (!student.has_attended ? `
                                    <div style="font-size: 11px; color: #95a5a6; margin-top: 6px; font-weight: 500; margin-bottom: 8px;">–ù–µ—Ç —è–≤–∫–∏</div>
                                    <button class="mark-attendance-btn" 
                                            onclick="confirmMarkAttendance(${student.id}, '${escapeJsString(student.full_name)}', ${year}, ${month}, ${day}, ${group.group_id})"
                                            style="
                                                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                                color: white;
                                                border: none;
                                                border-radius: 8px;
                                                padding: 8px 16px;
                                                font-size: 12px;
                                                font-weight: 600;
                                                cursor: pointer;
                                                transition: all 0.2s ease;
                                                width: 100%;
                                                margin-top: 4px;
                                            "
                                            onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(102, 126, 234, 0.4)';"
                                            onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                                        ‚úì –û—Ç–º–µ—Ç–∏—Ç—å
                                    </button>
                                ` : '')
                            }
                        </div>
                    `;
                });
            }
            
            html += `
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = html;
        
        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∞–∫–∫–æ—Ä–¥–µ–æ–Ω–∞
        document.querySelectorAll('.group-accordion-header').forEach(header => {
            header.addEventListener('click', function() {
                const content = this.nextElementSibling;
                const isActive = this.classList.contains('active');
                
                // –ó–∞–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∞–∫–∫–æ—Ä–¥–µ–æ–Ω—ã
                document.querySelectorAll('.group-accordion-header').forEach(h => {
                    h.classList.remove('active');
                    h.nextElementSibling.classList.remove('active');
                });
                
                // –û—Ç–∫—Ä—ã–≤–∞–µ–º/–∑–∞–∫—Ä—ã–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π
                if (!isActive) {
                    this.classList.add('active');
                    content.classList.add('active');
                }
            });
        });
    }
    
    // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ—Ç–º–µ—Ç–∫–∏ –ø–æ—Å–µ—â–µ–Ω–∏—è
    function confirmMarkAttendance(studentId, studentName, year, month, day, groupId) {
        const now = new Date();
        const currentTime = now.toLocaleTimeString('ru-RU', { 
            hour: '2-digit', 
            minute: '2-digit' 
        });
        const currentDate = `${day}.${month}.${year}`;
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
        const modal = document.getElementById('attendance-confirm-modal');
        const modalText = document.getElementById('attendance-confirm-text');
        const confirmBtn = document.getElementById('attendance-confirm-yes');
        const cancelBtn = document.getElementById('attendance-confirm-no');
        
        modalText.textContent = `–û—Ç–º–µ—Ç–∏—Ç—å ${studentName} –≤ ${currentTime} (${currentDate})?`;
        
        // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
        const newConfirmBtn = confirmBtn.cloneNode(true);
        const newCancelBtn = cancelBtn.cloneNode(true);
        confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
        cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
        
        // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
        newConfirmBtn.onclick = () => {
            modal.style.display = 'none';
            markStudentAttendance(studentId, year, month, day, groupId);
        };
        newCancelBtn.onclick = () => {
            modal.style.display = 'none';
        };
        
        modal.style.display = 'flex';
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä—É—á–Ω–æ–π –æ—Ç–º–µ—Ç–∫–∏ –ø–æ—Å–µ—â–µ–Ω–∏—è —É—á–µ–Ω–∏–∫–∞
    async function markStudentAttendance(studentId, year, month, day, groupId) {
        try {
            // –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã - —á–∏—Å–ª–∞
            const requestData = {
                student_id: parseInt(studentId),
                year: parseInt(year),
                month: parseInt(month),
                day: parseInt(day)
            };
            
            console.log('–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ —Ñ–∏–∫—Å–∞—Ü–∏—é –ø–æ—Å–µ—â–µ–Ω–∏—è:', requestData);
            
            const response = await fetch('/api/attendance/manual-checkin', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestData)
            });
            
            if (!response.ok) {
                const errorText = await response.text();
                console.error('–û—à–∏–±–∫–∞ HTTP:', response.status, errorText);
                throw new Error(`HTTP ${response.status}: ${errorText}`);
            }
            
            const data = await response.json();
            console.log('–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', data);
            
            if (data.success) {
                // –ü–æ–∫–∞–∑–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ
                console.log('–ü–æ—Å–µ—â–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–æ:', data);
                // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç–∏
                loadGroupsAttendance();
            } else {
                console.error('–û—à–∏–±–∫–∞ API:', data);
                alert('–û—à–∏–±–∫–∞: ' + (data.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–º–µ—Ç–∏—Ç—å –ø–æ—Å–µ—â–µ–Ω–∏–µ'));
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –æ—Ç–º–µ—Ç–∫–∏ –ø–æ—Å–µ—â–µ–Ω–∏—è:', error);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–º–µ—Ç–∫–µ –ø–æ—Å–µ—â–µ–Ω–∏—è: ' + error.message);
        }
    }
    
    // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —Å–Ω—è—Ç–∏—è —è–≤–∫–∏
    function confirmRemoveAttendance(studentId, studentName, attendanceId, year, month, day) {
        console.log('confirmRemoveAttendance –≤—ã–∑–≤–∞–Ω–∞:', { studentId, studentName, attendanceId, year, month, day });
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ attendanceId –Ω–µ null –∏ –Ω–µ undefined
        if (attendanceId === null || attendanceId === undefined || attendanceId === 'null') {
            console.error('attendanceId –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç:', attendanceId);
            alert('–û—à–∏–±–∫–∞: –Ω–µ –Ω–∞–π–¥–µ–Ω ID –∑–∞–ø–∏—Å–∏ –ø–æ—Å–µ—â–µ–Ω–∏—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É.');
            return;
        }
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
        const modal = document.getElementById('attendance-remove-modal');
        const modalText = document.getElementById('attendance-remove-text');
        const confirmBtn = document.getElementById('attendance-remove-yes');
        const cancelBtn = document.getElementById('attendance-remove-no');
        
        modalText.textContent = `–°–Ω—è—Ç—å —è–≤–∫—É —É ${studentName}?`;
        
        // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
        const newConfirmBtn = confirmBtn.cloneNode(true);
        const newCancelBtn = cancelBtn.cloneNode(true);
        confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
        cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
        
        // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
        newConfirmBtn.onclick = () => {
            modal.style.display = 'none';
            removeAttendance(attendanceId, year, month, day);
        };
        newCancelBtn.onclick = () => {
            modal.style.display = 'none';
        };
        
        modal.style.display = 'flex';
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–Ω—è—Ç–∏—è —è–≤–∫–∏
    async function removeAttendance(attendanceId, year, month, day) {
        try {
            console.log('–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ —É–¥–∞–ª–µ–Ω–∏–µ –ø–æ—Å–µ—â–µ–Ω–∏—è:', attendanceId);
            
            const response = await fetch(`/api/attendance/delete/${attendanceId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            
            if (!response.ok) {
                const errorText = await response.text();
                console.error('–û—à–∏–±–∫–∞ HTTP:', response.status, errorText);
                throw new Error(`HTTP ${response.status}: ${errorText}`);
            }
            
            const data = await response.json();
            console.log('–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', data);
            
            if (data.success) {
                // –ü–æ–∫–∞–∑–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ
                console.log('–ü–æ—Å–µ—â–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–æ:', data);
                // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç–∏
                loadGroupsAttendance();
            } else {
                console.error('–û—à–∏–±–∫–∞ API:', data);
                alert('–û—à–∏–±–∫–∞: ' + (data.message || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–Ω—è—Ç—å —è–≤–∫—É'));
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ —Å–Ω—è—Ç–∏—è —è–≤–∫–∏:', error);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–Ω—è—Ç–∏–∏ —è–≤–∫–∏: ' + error.message);
        }
    }
    
    // –ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–π—Ç–∏–Ω–≥–∞ —Ç–µ–∫—É—â–µ–≥–æ –º–µ—Å—è—Ü–∞
    async function loadCurrentMonthRating() {
        try {
            const response = await fetch('/api/rating/all-groups');
            const data = await response.json();
            
            if (!data.groups || data.groups.length === 0) {
                document.getElementById('currentMonthRatingContent').innerHTML = '<p style="text-align: center; padding: 40px; color: #95a5a6;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ä–µ–π—Ç–∏–Ω–≥–∞</p>';
                return;
            }
            
            renderCurrentMonthRating(data.groups);
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ–π—Ç–∏–Ω–≥–∞:', error);
            document.getElementById('currentMonthRatingContent').innerHTML = '<p style="text-align: center; padding: 40px; color: #e74c3c;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ–π—Ç–∏–Ω–≥–∞</p>';
        }
    }
    
    // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Ä–µ–π—Ç–∏–Ω–≥–∞ —Ç–µ–∫—É—â–µ–≥–æ –º–µ—Å—è—Ü–∞ (—É–ø—Ä–æ—â–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è –±–µ–∑ –ø—å–µ–¥–µ—Å—Ç–∞–ª–∞)
    function renderCurrentMonthRating(groups) {
        const container = document.getElementById('currentMonthRatingContent');
        
        let html = '';
        
        groups.forEach(group => {
            if (!group.rating || group.rating.length === 0) {
                html += `
                    <div style="background: white; padding: 25px; border-radius: 12px; margin-bottom: 30px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <h4 style="margin-bottom: 20px; color: #1a202c; font-size: 20px; border-bottom: 2px solid #e0e0e0; padding-bottom: 10px;">
                            üë®‚Äçüë©‚Äçüë¶ ${group.group_name}
                        </h4>
                        <p style="text-align: center; padding: 40px; color: #95a5a6;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</p>
                    </div>
                `;
            } else {
                html += `
                    <div style="background: white; padding: 25px; border-radius: 12px; margin-bottom: 30px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <h4 style="margin-bottom: 20px; color: #1a202c; font-size: 20px; border-bottom: 2px solid #e0e0e0; padding-bottom: 10px;">
                            üë®‚Äçüë©‚Äçüë¶ ${group.group_name}
                        </h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px;">
                `;
                
                group.rating.forEach((student, index) => {
                    const place = index + 1;
                    const photoUrl = student.photo_path ? 
                        `/static/${student.photo_path.replace('frontend/static/', '').replace(/\\/g, '/')}` : 
                        null;
                    const placeholderId = `current-rating-${student.student_id}-${group.group_id}`;
                    
                    html += `
                        <div style="text-align: center; padding: 15px; border: 2px solid #e0e0e0; border-radius: 10px; background: ${place <= 3 ? '#fffbf0' : '#fff'};">
                            <div style="font-size: 24px; margin-bottom: 8px;">
                                ${place === 1 ? 'ü•á' : place === 2 ? 'ü•à' : place === 3 ? 'ü•â' : `${place}.`}
                            </div>
                            ${photoUrl ? 
                                `<img src="${photoUrl}" alt="${student.full_name}" style="width: 60px; height: 60px; border-radius: 50%; object-fit: cover; border: 2px solid #f39c12; margin: 0 auto 8px; display: block; box-shadow: 0 2px 6px rgba(243,156,18,0.3);" onerror="document.getElementById('${placeholderId}').style.display='flex'; this.style.display='none';">` : 
                                ''
                            }
                            <div id="${placeholderId}" style="width: 60px; height: 60px; border-radius: 50%; margin: 0 auto 8px; display: ${photoUrl ? 'none' : 'flex'}; align-items: center; justify-content: center; background: #ffe69c; font-size: 24px; border: 2px solid #f39c12; box-shadow: 0 2px 6px rgba(243,156,18,0.3);">üë§</div>
                            <div style="font-weight: bold; color: #2c3e50; font-size: 12px; margin-bottom: 5px; word-wrap: break-word; line-height: 1.2;">${student.full_name}</div>
                            <div style="font-size: 14px; color: #f39c12; font-weight: bold;">‚≠ê ${student.points}</div>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            }
        });
        
        container.innerHTML = html;
    }
    </script>
            </div>
        </div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ—Ç–º–µ—Ç–∫–∏ –ø–æ—Å–µ—â–µ–Ω–∏—è -->
    <div id="attendance-confirm-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 10000; align-items: center; justify-content: center;" onclick="if(event.target === this) this.style.display='none';">
        <div class="modal-content" style="background: white; border-radius: 12px; padding: 24px; max-width: 400px; width: 90%; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);" onclick="event.stopPropagation();">
            <h3 class="modal-title" style="margin: 0 0 16px 0; font-size: 18px; font-weight: 600; color: #1e293b;">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ</h3>
            <p id="attendance-confirm-text" class="modal-text" style="margin: 0 0 24px 0; font-size: 14px; color: #64748b; line-height: 1.5;"></p>
            <div style="display: flex; gap: 12px; justify-content: flex-end;">
                <button id="attendance-confirm-no" style="
                    background: #e2e8f0;
                    color: #475569;
                    border: none;
                    border-radius: 8px;
                    padding: 10px 20px;
                    font-size: 14px;
                    font-weight: 600;
                    cursor: pointer;
                    transition: all 0.2s ease;
                " onmouseover="this.style.background='#cbd5e1';" onmouseout="this.style.background='#e2e8f0';">
                    –ù–µ—Ç
                </button>
                <button id="attendance-confirm-yes" style="
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: white;
                    border: none;
                    border-radius: 8px;
                    padding: 10px 20px;
                    font-size: 14px;
                    font-weight: 600;
                    cursor: pointer;
                    transition: all 0.2s ease;
                " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(102, 126, 234, 0.4)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                    –î–∞
                </button>
            </div>
        </div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —Å–Ω—è—Ç–∏—è —è–≤–∫–∏ -->
    <div id="attendance-remove-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 10000; align-items: center; justify-content: center;" onclick="if(event.target === this) this.style.display='none';">
        <div class="modal-content" style="background: white; border-radius: 12px; padding: 24px; max-width: 400px; width: 90%; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);" onclick="event.stopPropagation();">
            <h3 class="modal-title" style="margin: 0 0 16px 0; font-size: 18px; font-weight: 600; color: #1e293b;">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ</h3>
            <p id="attendance-remove-text" class="modal-text" style="margin: 0 0 24px 0; font-size: 14px; color: #64748b; line-height: 1.5;"></p>
            <div style="display: flex; gap: 12px; justify-content: flex-end;">
                <button id="attendance-remove-no" style="
                    background: #e2e8f0;
                    color: #475569;
                    border: none;
                    border-radius: 8px;
                    padding: 10px 20px;
                    font-size: 14px;
                    font-weight: 600;
                    cursor: pointer;
                    transition: all 0.2s ease;
                " onmouseover="this.style.background='#cbd5e1';" onmouseout="this.style.background='#e2e8f0';">
                    –ù–µ—Ç
                </button>
                <button id="attendance-remove-yes" style="
                    background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
                    color: white;
                    border: none;
                    border-radius: 8px;
                    padding: 10px 20px;
                    font-size: 14px;
                    font-weight: 600;
                    cursor: pointer;
                    transition: all 0.2s ease;
                " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(239, 68, 68, 0.4)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                    –î–∞
                </button>
            </div>
        </div>
    </div>
    
    <script src="{{ url_for('static', filename='js/sidebar.js') }}"></script>
    <script src="{{ url_for('static', filename='js/theme.js') }}"></script>
    <script src="{{ url_for('static', filename='js/mobile-menu.js') }}"></script>
</body>
</html>
