# Архитектура SaaS системы

## Двухуровневая система управления

### 1. Супер-администратор (владелец SaaS)
- **Роль**: `super_admin`
- **Доступ**: `/schools` - управление школами
- **Функции**:
  - Создание школ
  - Выдача логинов/паролей администраторам школ
  - Включение/отключение школ
  - Управление функциями (feature flags) для каждой школы
  - Просмотр всех школ (но не их данных)

### 2. Администратор школы
- **Роль**: `admin`
- **Привязка**: `school_id` - привязан к конкретной школе
- **Функции**:
  - Управление только своей школой
  - Создание пользователей для своей школы
  - Управление учениками, группами, тарифами
  - Финансы, посещаемость и т.д.
  - **НЕ видит** другие школы

## Как создать супер-администратора

```bash
python create_super_admin.py
```

Введите логин и пароль для супер-админа.

## Как работает изоляция данных

1. **Автоматическая фильтрация**: Все запросы автоматически фильтруются по `school_id`
2. **Middleware**: Перед каждым запросом устанавливается текущая школа из `user.school_id`
3. **Супер-админ**: Видит все данные (не фильтруется) для управления системой

## Создание школы

При создании школы через `/schools`:
1. Создаётся запись школы
2. Автоматически создаётся администратор школы с указанным логином/паролем
3. Создаются feature flags для управления функциями
4. Создаются настройки клуба для школы

## Включение/отключение школ

- При отключении школы (`is_active = False`):
  - Администраторы школы не могут войти в систему
  - Все данные остаются в базе
  - Можно включить обратно в любой момент

## Feature Flags

Каждая школа может иметь включенные/выключенные функции:
- `telegram_bot` - Telegram бот
- `rewards` - Система вознаграждений
- `cards` - Система карточек
- `face_recognition` - Распознавание лиц
- `attendance` - Посещаемость
- `payments` - Платежи
- `finances` - Финансы

## Важные замечания

⚠️ **Безопасность**:
- Админы школ видят ТОЛЬКО свои данные
- Супер-админ видит все данные для управления
- Все новые записи автоматически привязываются к школе пользователя

⚠️ **Миграция**:
- Все существующие данные привязаны к дефолтной школе
- При создании новой школы нужно создать для неё данные отдельно

## Примеры использования

### Супер-админ создаёт школу:
1. Заходит на `/schools`
2. Нажимает "Добавить школу"
3. Вводит название, логин и пароль администратора
4. Выбирает функции для школы
5. Сохраняет - получает логин/пароль для передачи администратору школы

### Администратор школы:
1. Входит с выданным логином/паролем
2. Видит только свою школу
3. Создаёт пользователей, учеников, группы и т.д.
4. Все данные автоматически привязываются к его школе

