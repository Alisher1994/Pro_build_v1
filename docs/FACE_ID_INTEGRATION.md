# Интеграция Face ID (Распознавание лиц)

## ⚠️ Критические требования (Принципы разработки)
1. **Сохранение дизайна**: Любые изменения во фронтенде НЕ должны нарушать текущую эстетику и премиальный вид проекта. Весь UI Face ID должен быть органично вписан в существующую дизайн-систему (цвета, шрифты, микро-анимации).
2. **Изоляция кода**: Проект PROBIM является полностью независимым. Код из справочных проектов должен быть грамотно портирован и адаптирован под архитектуру Node.js + TypeScript. **Прямые ссылки на файлы в папке `trash` запрещены.**
3. **Проект-эталон**: Папка `trash/` содержит проект-эталон для Face ID. Эта папка используется исключительно как справочный материал (логика распознавания, пороги точности, параметры OpenCV) для переноса проверенных решений в основной проект.
4. **Чистота архитектуры**: Весь функционал Face ID должен находиться внутри соответствующих папок основного проекта (например, `backend/python_service`, `backend/src/services/face`).

## Технологический стек
- **Python (Backend Service)**: Библиотека `face_recognition` (на базе dlib) для извлечения векторов лиц и их сравнения.
- **Node.js**: Управление процессами (child_process) и API.
- **Prisma/PostgreSQL**: Хранение биометрических данных и логов посещаемости.
- **Web API**: `getUserMedia` для захвата видеопотока в браузере.

## Структура данных

### Модель Employee (дополнения)
```prisma
model Employee {
  // ... существующие поля
  faceEncoding Bytes? // Биометрический вектор лица (128 чисел)
}
```

### Модель Attendance (новая)
```prisma
model Attendance {
  id          String   @id @default(uuid())
  employeeId  String
  type        String   // "entrance" (вход) или "exit" (выход)
  timestamp   DateTime @default(now())
  confidence  Float    // Степень уверенности распознавания
  photoPath   String?  // Путь к захваченному кадру (опционально)
  
  employee    Employee @relation(fields: [employeeId], references: [id])
}
```

## API Эндпоинты

- `POST /api/face/register/:employeeId`: Регистрация лица сотрудника (создание эталонного вектора).
- `POST /api/face/recognize`: Сравнение входящего кадра с базой данных сотрудников.
- `GET /api/face/attendance/today`: Получение списка зафиксированных проходов за сегодня.

## Процесс работы

1. **Захват**: Фронтенд (`timesheet.html`) каждые 2-3 секунды делает скриншот видеопотока.
2. **Передача**: Кадр отправляется на Node.js сервер в формате Base64 или Blob.
3. **Обработка**: Node.js передает изображение в Python-скрипт.
4. **Распознавание**: Python-скрипт находит лицо, извлекает вектор и сравнивает его с векторами из БД.
5. **Фиксация**: При совпадении (точность > 60%) в БД создается запись в таблице `Attendance`.
6. **Уведомление**: Фронтенд получает данные сотрудника и отображает всплывающее уведомление о входе/выходе.

## План реализации (RoadMap)

### Этап 1: Подготовка окружения
- [ ] Создать `backend/python_service/requirements.txt` с зависимостями (`face-recognition`, `opencv-python`, `numpy`).
- [ ] Настроить виртуальное окружение Python для сервера.
- [ ] Проверить работоспособность `dlib` и `face_recognition` на текущей ОС.

### Этап 2: База данных
- [ ] Обновить `schema.prisma`: добавить поле `faceEncoding` в `Employee`.
- [ ] Добавить модель `Attendance` в `schema.prisma`.
- [ ] Выполнить миграцию: `npx prisma migrate dev`.

### Этап 3: Python Backend (Face Engine)
- [ ] Разработать `face_engine.py` (загрузка векторов из БД, поиск лиц в кадре).
- [ ] Реализовать метод извлечения вектора (`encoding`) при регистрации нового фото.

### Этап 4: Node.js Integration
- [ ] Создать `faceEngine.ts` для управления Python-процессом.
- [ ] Создать API роуты `backend/src/routes/face.ts`.
- [ ] Интегрировать автоматическое логирование в `Attendance` при успешном распознавании.

### Этап 5: Frontend КПП
- [ ] Добавить в `timesheet.html` скрипт захвата кадров с камер (Вход/Выход).
- [ ] Реализовать визуальную индикацию ("Человек распознан: Алиев Т.").
- [ ] Добавить звуковые уведомления (Beep) при регистрации прохода.

### Этап 6: Табель (Реальные данные)
- [ ] Обновить логику `timesheet-table.html`, чтобы она брала данные из таблицы `Attendance` вместо моков.
- [ ] Добавить возможность ручной корректировки записей (если ИИ ошибся).

### Этап 7: Регистрация лиц
- [ ] Добавить в интерфейс управления сотрудниками кнопку "Зарегистрировать лицо" (через загрузку фото или напрямую с камеры).
